# Обновления системы подборок недвижимости

## Версия 0.3.0 - Обновление от 06.12.2024

### Реализованные улучшения

#### 1. Добавлен НДС (VAT) ✅

**Расчет цен:**
- НДС для Кипра: 19%
- Показываются обе цены: без НДС и с НДС
- Реализовано в:
  - PDF экспорт (`pdf-export.js`)
  - Swipe интерфейс клиента (`swipe.js`)
  - Страница просмотра объекта (`property.html`)

**Примеры отображения:**
```
€350,000 (без НДС)
€416,500 (с НДС)
```

**Функции:**
```javascript
// В pdf-export.js
VAT_RATE: 0.19
calculateVAT(price, includeVAT = true)
formatPrice(price, options = { showVAT, showBoth })

// В swipe.js
VAT_RATE: 0.19
calculateWithVAT(price)
formatPrice(price, includeVAT = false)
```

#### 2. Брендирование PDF ✅

**Добавлено в PDF экспорт:**
- Логотип компании (опционально)
- Название агентства
- Номер лицензии
- Профессиональный заголовок
- Разделительная линия

**Новые параметры функции `generateResultsPDF`:**
```javascript
{
  brokerName: 'Cyprus Real Estate',
  brokerLicense: '1234/E',
  brokerLogo: null, // base64 изображение (опционально)
  showForBroker: true // показывать ID объектов
}
```

**Переводы:**
- EN: "Real Estate Broker", "License No."
- RU: "Агентство недвижимости", "Лицензия №"
- EL: "Μεσιτικό Γραφείο", "Αριθμός Άδειας"

#### 3. Скрытие ID объектов от клиентов ✅

**Реализация:**
- ID объектов показываются только в PDF для брокеров
- Параметр `showForBroker` контролирует видимость
- Клиенты видят только основную информацию

**В PDF для брокера:**
```
ID объекта: CYP-001234
```

**В PDF для клиента:**
ID не отображается

#### 4. Внутренние ссылки вместо внешних ✅

**Новая функциональность:**
- Создана страница `/src/client/property.html` для просмотра объектов
- Функция `convertToInternalUrl()` конвертирует ссылки
- Формат: `/src/client/property.html?id=CYP-001234`

**Преимущества:**
- Клиенты остаются в системе
- Единообразный интерфейс
- Показываются цены с НДС
- Профессиональное брендирование

**Реализовано в:**
```javascript
// pdf-export.js
convertToInternalUrl(url, propertyId) {
  if (propertyId) {
    const baseUrl = window.location.origin;
    return `${baseUrl}/src/client/property.html?id=${propertyId}`;
  }
  return url;
}
```

### Обновленные файлы

1. **`/src/assets/js/pdf-export.js`**
   - Добавлены расчеты НДС
   - Брендирование PDF
   - Скрытие ID для клиентов
   - Конвертация ссылок
   - Новые переводы

2. **`/src/assets/js/swipe.js`**
   - Расчет и отображение цен с НДС
   - Форматирование цен
   - Обновленный UI карточек

3. **`/src/broker/selections.html`**
   - Передача параметров брендинга в PDF
   - Флаг `showForBroker = true`

4. **`/src/client/property.html`** (НОВЫЙ)
   - Страница просмотра отдельного объекта
   - Показ цен с НДС
   - Галерея фотографий
   - Брендирование

### Новые стили PDF

```javascript
reactionPriceVAT: {
  fontSize: 9,
  bold: true,
  color: '#10b981' // зеленый для цены с НДС
}
```

### Инструкция по использованию

#### Для разработчиков:

1. **Настройка лицензии:**
```javascript
// В selections.html
brokerLicense: '1234/E' // Измените на свой номер
```

2. **Добавление логотипа:**
```javascript
// В selections.html
brokerLogo: 'data:image/png;base64,...' // base64 изображение
```

3. **Создание PDF для брокера:**
```javascript
PDFExport.generateResultsPDF({
  selectionName: 'My Selection',
  clientName: 'John Doe',
  brokerName: 'Cyprus Real Estate',
  brokerLicense: '1234/E',
  brokerLogo: logoBase64,
  properties: properties,
  reactions: reactions,
  lang: 'ru', // en, ru, el
  showForBroker: true // Показать ID объектов
});
```

4. **Создание PDF для клиента:**
```javascript
PDFExport.generateResultsPDF({
  // ... те же параметры
  showForBroker: false // Скрыть ID объектов
});
```

### TODO (Будущие улучшения)

1. ⬜ Добавить функцию загрузки логотипа в настройках брокера
2. ⬜ Сохранять номер лицензии в настройках пользователя
3. ⬜ Добавить выбор: показывать PDF с ID или без
4. ⬜ Создать две кнопки экспорта: "For Broker" и "For Client"
5. ⬜ Добавить водяной знак с лицензией на фотографии
6. ⬜ Настраиваемая ставка НДС (для других стран)

### Тестирование

Проверьте следующие сценарии:

✅ **PDF экспорт:**
- Генерация PDF на русском, английском, греческом
- Отображение логотипа и лицензии
- Правильный расчет НДС (19%)
- Скрытие ID в клиентской версии
- Показ ID в версии для брокера

✅ **Swipe интерфейс:**
- Отображение двух цен на карточках
- Показ цен с НДС в деталях
- Отсутствие ID объектов

✅ **Страница объекта:**
- Корректная загрузка по ID
- Отображение цен с НДС
- Галерея фотографий
- Брендирование внизу

### Совместимость

- ✅ Все браузеры (Chrome, Firefox, Safari, Edge)
- ✅ Мобильные устройства (iOS, Android)
- ✅ PWA функциональность
- ✅ Обратная совместимость с существующими данными

### Контакты для вопросов

Если у вас есть вопросы или предложения по улучшению, создайте issue в репозитории.

---

**Дата обновления:** 06 декабря 2024  
**Версия:** 0.3.0  
**Автор:** Real Estate System Team
