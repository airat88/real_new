/* ============================================
   PDF EXPORT - Using pdfmake for Unicode support
   Supports Cyrillic (Russian) and Greek
   ============================================ */

const PDFExport = {
    // Translations for 3 languages
    translations: {
        en: {
            title: 'Property Selection',
            preparedFor: 'Prepared for',
            preparedBy: 'Prepared by',
            date: 'Date',
            properties: 'Properties',
            property: 'Property',
            price: 'Price',
            location: 'Location',
            bedrooms: 'Bedrooms',
            bathrooms: 'Bathrooms',
            area: 'Area',
            type: 'Type',
            status: 'Status',
            features: 'Features',
            studio: 'Studio',
            viewListing: 'View listing',
            clientFeedback: 'Client Feedback',
            liked: 'Liked',
            passed: 'Passed',
            pending: 'Not Reviewed',
            likeRate: 'Like Rate',
            totalProperties: 'Total Properties',
            reviewed: 'Reviewed',
            generatedBy: 'Generated by Cyprus Real Estate',
            page: 'Page',
            of: 'of',
            bed: 'bed',
            sqm: 'sqm',
            noImage: 'No image',
            withVAT: 'incl. VAT',
            withoutVAT: 'excl. VAT',
            vat: 'VAT',
            licenseNumber: 'License No.',
            realEstateBroker: 'Real Estate Broker',
            propertyId: 'Property ID'
        },
        ru: {
            title: 'Подборка недвижимости',
            preparedFor: 'Подготовлено для',
            preparedBy: 'Подготовил',
            date: 'Дата',
            properties: 'Объекты',
            property: 'Объект',
            price: 'Цена',
            location: 'Расположение',
            bedrooms: 'Спальни',
            bathrooms: 'Ванные',
            area: 'Площадь',
            type: 'Тип',
            status: 'Статус',
            features: 'Особенности',
            studio: 'Студия',
            viewListing: 'Открыть объявление',
            clientFeedback: 'Отзыв клиента',
            liked: 'Понравилось',
            passed: 'Пропущено',
            pending: 'Не просмотрено',
            likeRate: 'Рейтинг',
            totalProperties: 'Всего объектов',
            reviewed: 'Просмотрено',
            generatedBy: 'Создано Cyprus Real Estate',
            page: 'Стр.',
            of: 'из',
            bed: 'спал.',
            sqm: 'м²',
            noImage: 'Нет фото',
            withVAT: 'с НДС',
            withoutVAT: 'без НДС',
            vat: 'НДС',
            licenseNumber: 'Лицензия №',
            realEstateBroker: 'Агентство недвижимости',
            propertyId: 'ID объекта'
        },
        el: {
            title: 'Επιλογή Ακινήτων',
            preparedFor: 'Προετοιμάστηκε για',
            preparedBy: 'Προετοιμάστηκε από',
            date: 'Ημερομηνία',
            properties: 'Ακίνητα',
            property: 'Ακίνητο',
            price: 'Τιμή',
            location: 'Τοποθεσία',
            bedrooms: 'Υπνοδωμάτια',
            bathrooms: 'Μπάνια',
            area: 'Εμβαδόν',
            type: 'Τύπος',
            status: 'Κατάσταση',
            features: 'Χαρακτηριστικά',
            studio: 'Στούντιο',
            viewListing: 'Δείτε αγγελία',
            clientFeedback: 'Σχόλια Πελάτη',
            liked: 'Αρέσει',
            passed: 'Παράλειψη',
            pending: 'Δεν εξετάστηκε',
            likeRate: 'Ποσοστό',
            totalProperties: 'Σύνολο ακινήτων',
            reviewed: 'Εξετάστηκε',
            generatedBy: 'Δημιουργήθηκε από Cyprus Real Estate',
            page: 'Σελ.',
            of: 'από',
            bed: 'υπν.',
            sqm: 'τ.μ.',
            noImage: 'Χωρίς εικόνα',
            withVAT: 'με ΦΠΑ',
            withoutVAT: 'χωρίς ΦΠΑ',
            vat: 'ΦΠΑ',
            licenseNumber: 'Αριθμός Άδειας',
            realEstateBroker: 'Μεσιτικό Γραφείο',
            propertyId: 'ID Ακινήτου'
        }
    },

    // Get translation
    t(key, lang = 'en') {
        return this.translations[lang]?.[key] || this.translations.en[key] || key;
    },

    // VAT rate for Cyprus
    VAT_RATE: 0.19,

    // Calculate price with/without VAT
    calculateVAT(price, includeVAT = true) {
        const numPrice = typeof price === 'number' ? price : parseInt((price || '').toString().replace(/[^\d]/g, ''));
        if (isNaN(numPrice)) return null;
        
        if (includeVAT) {
            return Math.round(numPrice * (1 + this.VAT_RATE));
        } else {
            return numPrice;
        }
    },

    // Format price with VAT options
    formatPrice(price, options = {}) {
        const { showVAT = false, showBoth = false } = options;
        
        if (typeof price === 'number') {
            if (showBoth) {
                const withoutVAT = price;
                const withVAT = this.calculateVAT(price, true);
                return {
                    withoutVAT: '€' + withoutVAT.toLocaleString(),
                    withVAT: '€' + withVAT.toLocaleString()
                };
            }
            const amount = showVAT ? this.calculateVAT(price, true) : price;
            return '€' + amount.toLocaleString();
        }
        if (typeof price === 'string') {
            if (price.includes('€')) return price;
            const num = parseInt(price.replace(/[^\d]/g, ''));
            if (!isNaN(num)) {
                if (showBoth) {
                    const withoutVAT = num;
                    const withVAT = this.calculateVAT(num, true);
                    return {
                        withoutVAT: '€' + withoutVAT.toLocaleString(),
                        withVAT: '€' + withVAT.toLocaleString()
                    };
                }
                const amount = showVAT ? this.calculateVAT(num, true) : num;
                return '€' + amount.toLocaleString();
            }
        }
        return price || 'N/A';
    },

    // Format date
    formatDate(date, lang = 'en') {
        const d = date ? new Date(date) : new Date();
        const locales = { en: 'en-GB', ru: 'ru-RU', el: 'el-GR' };
        return d.toLocaleDateString(locales[lang] || 'en-GB', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
    },

    // Load image as base64 with better error handling
    async loadImageAsBase64(url, timeout = 5000) {
        return new Promise((resolve) => {
            if (!url) {
                resolve(null);
                return;
            }

            // Skip placeholder images
            if (url.includes('unsplash.com')) {
                resolve(null);
                return;
            }

            // Convert Google Drive URLs to thumbnail format
            let imageUrl = url;
            if (url.includes('drive.google.com')) {
                let fileId = null;
                if (url.includes('/d/')) {
                    fileId = url.split('/d/')[1]?.split('/')[0];
                } else if (url.includes('id=')) {
                    fileId = url.split('id=')[1]?.split('&')[0];
                }
                if (fileId) {
                    imageUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w400`;
                }
            }

            const img = new Image();
            img.crossOrigin = 'anonymous';

            let resolved = false;
            const timeoutId = setTimeout(() => {
                if (!resolved) {
                    resolved = true;
                    resolve(null);
                }
            }, timeout);

            img.onload = () => {
                if (resolved) return;
                resolved = true;
                clearTimeout(timeoutId);

                try {
                    const canvas = document.createElement('canvas');
                    const maxWidth = 200;
                    const maxHeight = 150;

                    let width = img.naturalWidth || img.width;
                    let height = img.naturalHeight || img.height;

                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    if (height > maxHeight) {
                        width = (maxHeight / height) * width;
                        height = maxHeight;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#f5f5f5';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);

                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                } catch (e) {
                    resolve(null);
                }
            };

            img.onerror = () => {
                if (resolved) return;
                resolved = true;
                clearTimeout(timeoutId);
                resolve(null);
            };

            img.src = imageUrl;
        });
    },

    // Create placeholder image as base64
    createPlaceholderImage(text = 'No image') {
        const canvas = document.createElement('canvas');
        canvas.width = 150;
        canvas.height = 100;
        const ctx = canvas.getContext('2d');

        // Background
        ctx.fillStyle = '#e5e7eb';
        ctx.fillRect(0, 0, 150, 100);

        // Text
        ctx.fillStyle = '#9ca3af';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, 75, 50);

        return canvas.toDataURL('image/png');
    },

    // Show loading overlay
    showLoading(message = 'Generating PDF...') {
        const existing = document.getElementById('pdfLoading');
        if (existing) existing.remove();

        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'pdfLoading';
        loadingDiv.style.cssText = `
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        `;
        loadingDiv.innerHTML = `
            <div style="background: white; padding: 30px 50px; border-radius: 12px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                <div style="width: 50px; height: 50px; border: 4px solid #e5e7eb; border-top-color: #6366f1; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <p style="margin: 0; font-size: 16px; font-weight: 500;" id="pdfLoadingText">${message}</p>
                <p style="margin: 10px 0 0; font-size: 12px; color: #888;" id="pdfLoadingSubtext">Please wait...</p>
            </div>
            <style>
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            </style>
        `;
        document.body.appendChild(loadingDiv);
    },

    // Update loading text
    updateLoading(text, subtext = '') {
        const textEl = document.getElementById('pdfLoadingText');
        const subtextEl = document.getElementById('pdfLoadingSubtext');
        if (textEl) textEl.textContent = text;
        if (subtextEl) subtextEl.textContent = subtext;
    },

    // Hide loading overlay
    hideLoading() {
        document.getElementById('pdfLoading')?.remove();
    },

    // Generate PDF for a selection (before client reviews)
    async generateSelectionPDF(options) {
        const {
            selectionName,
            clientName,
            brokerName = 'Cyprus Real Estate',
            properties,
            lang = 'en'
        } = options;

        if (typeof pdfMake === 'undefined') {
            alert('PDF library not loaded. Please refresh the page.');
            return;
        }

        this.showLoading(this.t('title', lang));
        this.updateLoading('Loading images...', `0 / ${properties.length}`);

        try {
            // Pre-load all images
            const placeholderImg = this.createPlaceholderImage(this.t('noImage', lang));
            const imagePromises = properties.map(async (prop, idx) => {
                const img = await this.loadImageAsBase64(prop.photos?.[0]);
                this.updateLoading('Loading images...', `${idx + 1} / ${properties.length}`);
                return { prop, img: img || placeholderImg };
            });

            const propertiesWithImages = await Promise.all(imagePromises);

            this.updateLoading('Generating PDF...', '');

            // Build document content
            const content = [];

            // Header
            content.push({
                text: this.t('title', lang),
                style: 'header',
                margin: [0, 0, 0, 5]
            });

            content.push({
                text: `${properties.length} ${this.t('properties', lang).toLowerCase()}`,
                style: 'subheader',
                margin: [0, 0, 0, 20]
            });

            // Info section
            if (clientName) {
                content.push({
                    text: `${this.t('preparedFor', lang)}: ${clientName}`,
                    style: 'info'
                });
            }
            content.push({
                text: `${this.t('preparedBy', lang)}: ${brokerName}`,
                style: 'info'
            });
            content.push({
                text: `${this.t('date', lang)}: ${this.formatDate(null, lang)}`,
                style: 'info',
                margin: [0, 0, 0, 10]
            });

            if (selectionName) {
                content.push({
                    text: selectionName,
                    style: 'selectionName',
                    margin: [0, 0, 0, 20]
                });
            }

            // Properties
            propertiesWithImages.forEach(({ prop, img }, index) => {
                const bedText = prop.bedrooms === 0 ? this.t('studio', lang) : `${prop.bedrooms} ${this.t('bed', lang)}`;
                const areaText = prop.area ? `${prop.area} ${this.t('sqm', lang)}` : '';
                const stats = [bedText, areaText, prop.type].filter(Boolean).join(' • ');

                const propertyTable = {
                    table: {
                        widths: [100, '*'],
                        body: [[
                            // Image column
                            {
                                image: img,
                                width: 90,
                                height: 65,
                                margin: [0, 5, 0, 5]
                            },
                            // Details column
                            {
                                stack: [
                                    {
                                        columns: [
                                            {
                                                text: `${index + 1}. ${(prop.title || 'Property').substring(0, 40)}`,
                                                style: 'propertyTitle',
                                                width: '*'
                                            },
                                            {
                                                text: this.formatPrice(prop.cleanPrice || prop.price),
                                                style: 'propertyPrice',
                                                width: 'auto',
                                                alignment: 'right'
                                            }
                                        ]
                                    },
                                    {
                                        text: prop.location || 'Cyprus',
                                        style: 'propertyLocation',
                                        margin: [0, 3, 0, 0]
                                    },
                                    {
                                        text: stats,
                                        style: 'propertyStats',
                                        margin: [0, 3, 0, 0]
                                    }
                                ],
                                margin: [10, 5, 5, 5]
                            }
                        ]]
                    },
                    layout: {
                        hLineWidth: () => 1,
                        vLineWidth: () => 1,
                        hLineColor: () => '#e5e7eb',
                        vLineColor: () => '#e5e7eb',
                        paddingLeft: () => 5,
                        paddingRight: () => 5,
                        paddingTop: () => 5,
                        paddingBottom: () => 5
                    },
                    margin: [0, 0, 0, 10]
                };

                content.push(propertyTable);
            });

            // Document definition
            const docDefinition = {
                content: content,
                styles: {
                    header: {
                        fontSize: 22,
                        bold: true,
                        color: '#1e1b4b'
                    },
                    subheader: {
                        fontSize: 12,
                        color: '#6b7280'
                    },
                    info: {
                        fontSize: 10,
                        color: '#6b7280',
                        margin: [0, 2, 0, 2]
                    },
                    selectionName: {
                        fontSize: 14,
                        bold: true,
                        color: '#1e1b4b'
                    },
                    propertyTitle: {
                        fontSize: 11,
                        bold: true,
                        color: '#1f2937'
                    },
                    propertyPrice: {
                        fontSize: 12,
                        bold: true,
                        color: '#6366f1'
                    },
                    propertyLocation: {
                        fontSize: 9,
                        color: '#6b7280'
                    },
                    propertyStats: {
                        fontSize: 9,
                        color: '#9ca3af'
                    },
                    propertyLink: {
                        fontSize: 8,
                        color: '#6366f1'
                    }
                },
                defaultStyle: {
                    font: 'Roboto'
                },
                footer: (currentPage, pageCount) => ({
                    columns: [
                        {
                            text: this.t('generatedBy', lang),
                            alignment: 'left',
                            fontSize: 8,
                            color: '#9ca3af',
                            margin: [40, 0, 0, 0]
                        },
                        {
                            text: `${this.t('page', lang)} ${currentPage} ${this.t('of', lang)} ${pageCount}`,
                            alignment: 'right',
                            fontSize: 8,
                            color: '#9ca3af',
                            margin: [0, 0, 40, 0]
                        }
                    ],
                    margin: [0, 10, 0, 0]
                }),
                pageMargins: [40, 40, 40, 50]
            };

            // Generate and download
            const fileName = `${(selectionName || 'Selection').replace(/[^a-zA-Z0-9а-яА-ЯёЁα-ωΑ-Ω\s]/g, '_')}_${lang.toUpperCase()}.pdf`;
            pdfMake.createPdf(docDefinition).download(fileName);

            this.hideLoading();
            return fileName;

        } catch (error) {
            console.error('PDF generation failed:', error);
            this.hideLoading();
            alert('Failed to generate PDF: ' + error.message);
        }
    },

    // Generate PDF with client reactions
    async generateResultsPDF(options) {
        const {
            selectionName,
            clientName,
            brokerName = 'Cyprus Real Estate',
            brokerLicense = '1234/E',
            brokerLogo = null,
            properties,
            reactions,
            lang = 'en',
            showForBroker = false
        } = options;

        if (typeof pdfMake === 'undefined') {
            alert('PDF library not loaded. Please refresh the page.');
            return;
        }

        this.showLoading(this.t('clientFeedback', lang));
        this.updateLoading('Generating PDF...', '');

        try {
            const liked = reactions.filter(r => r.reaction === 'like');
            const disliked = reactions.filter(r => r.reaction === 'dislike');
            const likeRate = reactions.length > 0 ? Math.round((liked.length / reactions.length) * 100) : 0;

            // Build document content
            const content = [];

            // Header with branding
            const headerRow = [];
            
            // Logo (if provided)
            if (brokerLogo) {
                headerRow.push({
                    image: brokerLogo,
                    width: 60,
                    margin: [0, 0, 15, 0]
                });
            }
            
            // Company info
            headerRow.push({
                stack: [
                    {
                        text: brokerName,
                        style: 'header',
                        margin: [0, 0, 0, 5]
                    },
                    {
                        text: `${this.t('realEstateBroker', lang)}`,
                        style: 'subheader',
                        margin: [0, 0, 0, 2]
                    },
                    {
                        text: `${this.t('licenseNumber', lang)} ${brokerLicense}`,
                        style: 'info',
                        color: '#6366f1',
                        bold: true
                    }
                ],
                width: '*'
            });
            
            content.push({
                columns: headerRow,
                margin: [0, 0, 0, 15]
            });
            
            content.push({
                canvas: [
                    {
                        type: 'line',
                        x1: 0, y1: 0,
                        x2: 515, y2: 0,
                        lineWidth: 2,
                        lineColor: '#6366f1'
                    }
                ],
                margin: [0, 0, 0, 20]
            });

            // Title
            content.push({
                text: this.t('clientFeedback', lang),
                style: 'header',
                margin: [0, 0, 0, 5]
            });

            content.push({
                text: selectionName || this.t('title', lang),
                style: 'subheader',
                margin: [0, 0, 0, 20]
            });

            // Info section
            if (clientName) {
                content.push({
                    text: `${this.t('preparedFor', lang)}: ${clientName}`,
                    style: 'info'
                });
            }
            content.push({
                text: `${this.t('date', lang)}: ${this.formatDate(null, lang)}`,
                style: 'info',
                margin: [0, 0, 0, 15]
            });

            // Summary stats
            content.push({
                table: {
                    widths: ['*', '*', '*', '*'],
                    body: [[
                        {
                            stack: [
                                { text: properties.length.toString(), style: 'statValue' },
                                { text: this.t('totalProperties', lang), style: 'statLabel' }
                            ],
                            alignment: 'center',
                            margin: [0, 10, 0, 10]
                        },
                        {
                            stack: [
                                { text: liked.length.toString(), style: 'statValueGreen' },
                                { text: this.t('liked', lang), style: 'statLabel' }
                            ],
                            alignment: 'center',
                            margin: [0, 10, 0, 10]
                        },
                        {
                            stack: [
                                { text: disliked.length.toString(), style: 'statValueRed' },
                                { text: this.t('passed', lang), style: 'statLabel' }
                            ],
                            alignment: 'center',
                            margin: [0, 10, 0, 10]
                        },
                        {
                            stack: [
                                { text: `${likeRate}%`, style: 'statValue' },
                                { text: this.t('likeRate', lang), style: 'statLabel' }
                            ],
                            alignment: 'center',
                            margin: [0, 10, 0, 10]
                        }
                    ]]
                },
                layout: {
                    hLineWidth: () => 1,
                    vLineWidth: () => 1,
                    hLineColor: () => '#e5e7eb',
                    vLineColor: () => '#e5e7eb'
                },
                margin: [0, 0, 0, 25]
            });

            // Liked section
            if (liked.length > 0) {
                content.push({
                    text: [
                        { text: '❤ ', style: 'sectionIconGreen' },
                        { text: `${this.t('liked', lang)} (${liked.length})`, style: 'sectionTitle' }
                    ],
                    margin: [0, 0, 0, 10]
                });

                liked.forEach(reaction => {
                    const prop = properties.find(p => p.id === reaction.property_id) || {};
                    content.push(this.createReactionRow(reaction, prop, 'like', lang, showForBroker));
                });

                content.push({ text: '', margin: [0, 0, 0, 15] });
            }

            // Passed section
            if (disliked.length > 0) {
                content.push({
                    text: [
                        { text: '✕ ', style: 'sectionIconRed' },
                        { text: `${this.t('passed', lang)} (${disliked.length})`, style: 'sectionTitle' }
                    ],
                    margin: [0, 0, 0, 10]
                });

                disliked.forEach(reaction => {
                    const prop = properties.find(p => p.id === reaction.property_id) || {};
                    content.push(this.createReactionRow(reaction, prop, 'dislike', lang, showForBroker));
                });
            }

            // Document definition
            const docDefinition = {
                content: content,
                styles: {
                    header: {
                        fontSize: 20,
                        bold: true,
                        color: '#1e1b4b'
                    },
                    subheader: {
                        fontSize: 12,
                        color: '#6b7280'
                    },
                    info: {
                        fontSize: 10,
                        color: '#6b7280',
                        margin: [0, 2, 0, 2]
                    },
                    statValue: {
                        fontSize: 18,
                        bold: true,
                        color: '#1f2937'
                    },
                    statValueGreen: {
                        fontSize: 18,
                        bold: true,
                        color: '#10b981'
                    },
                    statValueRed: {
                        fontSize: 18,
                        bold: true,
                        color: '#ef4444'
                    },
                    statLabel: {
                        fontSize: 9,
                        color: '#6b7280'
                    },
                    sectionTitle: {
                        fontSize: 13,
                        bold: true,
                        color: '#1f2937'
                    },
                    sectionIconGreen: {
                        fontSize: 13,
                        color: '#10b981'
                    },
                    sectionIconRed: {
                        fontSize: 13,
                        color: '#ef4444'
                    },
                    reactionTitle: {
                        fontSize: 10,
                        bold: true,
                        color: '#1f2937'
                    },
                    reactionPrice: {
                        fontSize: 10,
                        bold: true,
                        color: '#6366f1'
                    },
                    reactionPriceVAT: {
                        fontSize: 9,
                        bold: true,
                        color: '#10b981'
                    },
                    reactionDetails: {
                        fontSize: 8,
                        color: '#6b7280'
                    },
                    reactionLink: {
                        fontSize: 8,
                        color: '#6366f1'
                    }
                },
                defaultStyle: {
                    font: 'Roboto'
                },
                footer: (currentPage, pageCount) => ({
                    columns: [
                        {
                            text: this.t('generatedBy', lang),
                            alignment: 'left',
                            fontSize: 8,
                            color: '#9ca3af',
                            margin: [40, 0, 0, 0]
                        },
                        {
                            text: `${this.t('page', lang)} ${currentPage} ${this.t('of', lang)} ${pageCount}`,
                            alignment: 'right',
                            fontSize: 8,
                            color: '#9ca3af',
                            margin: [0, 0, 40, 0]
                        }
                    ],
                    margin: [0, 10, 0, 0]
                }),
                pageMargins: [40, 40, 40, 50]
            };

            // Generate and download
            const fileName = `${(selectionName || 'Results').replace(/[^a-zA-Z0-9а-яА-ЯёЁα-ωΑ-Ω\s]/g, '_')}_${this.t('clientFeedback', lang)}_${lang.toUpperCase()}.pdf`;
            pdfMake.createPdf(docDefinition).download(fileName);

            this.hideLoading();
            return fileName;

        } catch (error) {
            console.error('PDF generation failed:', error);
            this.hideLoading();
            alert('Failed to generate PDF: ' + error.message);
        }
    },

    // Create a reaction row for results PDF
    createReactionRow(reaction, prop, type, lang, showForBroker = false) {
        const isLike = type === 'like';
        const borderColor = isLike ? '#10b981' : '#ef4444';
        const icon = isLike ? '❤' : '✕';

        const bedText = prop.bedrooms === 0 ? this.t('studio', lang) : `${prop.bedrooms} ${this.t('bed', lang)}`;
        const details = `${prop.location || 'Cyprus'} • ${bedText} • ${prop.area || '-'} ${this.t('sqm', lang)}`;

        // Calculate prices
        const basePrice = prop.cleanPrice || parseInt((prop.price || '').toString().replace(/[^\d]/g, '')) || 0;
        const priceWithoutVAT = this.formatPrice(basePrice);
        const priceWithVAT = this.formatPrice(this.calculateVAT(basePrice, true));

        // Build price stack
        const priceStack = [
            {
                text: priceWithoutVAT,
                style: 'reactionPrice',
                alignment: 'right'
            },
            {
                text: this.t('withoutVAT', lang),
                style: 'reactionDetails',
                alignment: 'right',
                margin: [0, 1, 0, 0]
            },
            {
                text: priceWithVAT,
                style: 'reactionPriceVAT',
                alignment: 'right',
                margin: [0, 3, 0, 0]
            },
            {
                text: this.t('withVAT', lang),
                style: 'reactionDetails',
                alignment: 'right',
                margin: [0, 1, 0, 3]
            }
        ];

        // Add property ID for broker
        if (showForBroker && prop.id) {
            priceStack.push({
                text: `${this.t('propertyId', lang)}: ${prop.id}`,
                style: 'reactionDetails',
                alignment: 'right',
                color: '#9ca3af',
                margin: [0, 3, 0, 0]
            });
        }


        const row = {
            table: {
                widths: [3, '*', 'auto'],
                body: [[
                    // Accent bar
                    { text: '', fillColor: borderColor },
                    // Main content
                    {
                        stack: [
                            {
                                text: [
                                    { text: icon + ' ', color: borderColor },
                                    { text: (reaction.property_title || prop.title || 'Property').substring(0, 40), style: 'reactionTitle' }
                                ]
                            },
                            {
                                text: details,
                                style: 'reactionDetails',
                                margin: [0, 3, 0, 0]
                            }
                        ],
                        margin: [8, 5, 5, 5]
                    },
                    // Price and info
                    {
                        stack: priceStack,
                        margin: [5, 5, 8, 5]
                    }
                ]]
            },
            layout: {
                hLineWidth: () => 1,
                vLineWidth: (i) => i === 0 ? 0 : 1,
                hLineColor: () => '#e5e7eb',
                vLineColor: () => '#e5e7eb',
                paddingLeft: () => 0,
                paddingRight: () => 0,
                paddingTop: () => 0,
                paddingBottom: () => 0
            },
            margin: [0, 0, 0, 8]
        };

        return row;
    },

    // Convert external URL to internal format
};

// Export
if (typeof window !== 'undefined') {
    window.PDFExport = PDFExport;
}
