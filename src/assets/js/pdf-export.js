/* ============================================
   PDF EXPORT - Using pdfmake for Unicode support
   Supports Cyrillic (Russian) and Greek
   ============================================ */

const PDFExport = {
    // Translations for 3 languages
    translations: {
        en: {
            title: 'Property Selection',
            preparedFor: 'Prepared for',
            preparedBy: 'Prepared by',
            date: 'Date',
            properties: 'Properties',
            property: 'Property',
            price: 'Price',
            location: 'Location',
            bedrooms: 'Bedrooms',
            bathrooms: 'Bathrooms',
            area: 'Area',
            type: 'Type',
            status: 'Status',
            features: 'Features',
            studio: 'Studio',
            viewListing: 'View listing',
            clientFeedback: 'Client Feedback',
            liked: 'Liked',
            passed: 'Passed',
            pending: 'Not Reviewed',
            likeRate: 'Like Rate',
            totalProperties: 'Total Properties',
            reviewed: 'Reviewed',
            generatedBy: 'Generated by Cyprus Real Estate',
            page: 'Page',
            of: 'of',
            bed: 'bed',
            sqm: 'sqm',
            noImage: 'No image',
            withVAT: 'incl. VAT',
            withoutVAT: 'excl. VAT',
            vat: 'VAT',
            licenseNumber: 'License No.',
            realEstateBroker: 'Real Estate Broker',
            propertyId: 'Property ID'
        },
        ru: {
            title: 'ÐŸÐ¾Ð´Ð±Ð¾Ñ€ÐºÐ° Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚Ð¸',
            preparedFor: 'ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð´Ð»Ñ',
            preparedBy: 'ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ð»',
            date: 'Ð”Ð°Ñ‚Ð°',
            properties: 'ÐžÐ±ÑŠÐµÐºÑ‚Ñ‹',
            property: 'ÐžÐ±ÑŠÐµÐºÑ‚',
            price: 'Ð¦ÐµÐ½Ð°',
            location: 'Ð Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ',
            bedrooms: 'Ð¡Ð¿Ð°Ð»ÑŒÐ½Ð¸',
            bathrooms: 'Ð’Ð°Ð½Ð½Ñ‹Ðµ',
            area: 'ÐŸÐ»Ð¾Ñ‰Ð°Ð´ÑŒ',
            type: 'Ð¢Ð¸Ð¿',
            status: 'Ð¡Ñ‚Ð°Ñ‚ÑƒÑ',
            features: 'ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸',
            studio: 'Ð¡Ñ‚ÑƒÐ´Ð¸Ñ',
            viewListing: 'ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ',
            clientFeedback: 'ÐžÑ‚Ð·Ñ‹Ð² ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°',
            liked: 'ÐŸÐ¾Ð½Ñ€Ð°Ð²Ð¸Ð»Ð¾ÑÑŒ',
            passed: 'ÐŸÑ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð¾',
            pending: 'ÐÐµ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¾',
            likeRate: 'Ð ÐµÐ¹Ñ‚Ð¸Ð½Ð³',
            totalProperties: 'Ð’ÑÐµÐ³Ð¾ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð²',
            reviewed: 'ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¾',
            generatedBy: 'Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾ Cyprus Real Estate',
            page: 'Ð¡Ñ‚Ñ€.',
            of: 'Ð¸Ð·',
            bed: 'ÑÐ¿Ð°Ð».',
            sqm: 'Ð¼Â²',
            noImage: 'ÐÐµÑ‚ Ñ„Ð¾Ñ‚Ð¾',
            withVAT: 'Ñ ÐÐ”Ð¡',
            withoutVAT: 'Ð±ÐµÐ· ÐÐ”Ð¡',
            vat: 'ÐÐ”Ð¡',
            licenseNumber: 'Ð›Ð¸Ñ†ÐµÐ½Ð·Ð¸Ñ â„–',
            realEstateBroker: 'ÐÐ³ÐµÐ½Ñ‚ÑÑ‚Ð²Ð¾ Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚Ð¸',
            propertyId: 'ID Ð¾Ð±ÑŠÐµÐºÑ‚Ð°'
        },
        el: {
            title: 'Î•Ï€Î¹Î»Î¿Î³Î® Î‘ÎºÎ¹Î½Î®Ï„Ï‰Î½',
            preparedFor: 'Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î¬ÏƒÏ„Î·ÎºÎµ Î³Î¹Î±',
            preparedBy: 'Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î¬ÏƒÏ„Î·ÎºÎµ Î±Ï€ÏŒ',
            date: 'Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±',
            properties: 'Î‘ÎºÎ¯Î½Î·Ï„Î±',
            property: 'Î‘ÎºÎ¯Î½Î·Ï„Î¿',
            price: 'Î¤Î¹Î¼Î®',
            location: 'Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±',
            bedrooms: 'Î¥Ï€Î½Î¿Î´Ï‰Î¼Î¬Ï„Î¹Î±',
            bathrooms: 'ÎœÏ€Î¬Î½Î¹Î±',
            area: 'Î•Î¼Î²Î±Î´ÏŒÎ½',
            type: 'Î¤ÏÏ€Î¿Ï‚',
            status: 'ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·',
            features: 'Î§Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÎ¬',
            studio: 'Î£Ï„Î¿ÏÎ½Ï„Î¹Î¿',
            viewListing: 'Î”ÎµÎ¯Ï„Îµ Î±Î³Î³ÎµÎ»Î¯Î±',
            clientFeedback: 'Î£Ï‡ÏŒÎ»Î¹Î± Î ÎµÎ»Î¬Ï„Î·',
            liked: 'Î‘ÏÎ­ÏƒÎµÎ¹',
            passed: 'Î Î±ÏÎ¬Î»ÎµÎ¹ÏˆÎ·',
            pending: 'Î”ÎµÎ½ ÎµÎ¾ÎµÏ„Î¬ÏƒÏ„Î·ÎºÎµ',
            likeRate: 'Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ',
            totalProperties: 'Î£ÏÎ½Î¿Î»Î¿ Î±ÎºÎ¹Î½Î®Ï„Ï‰Î½',
            reviewed: 'Î•Î¾ÎµÏ„Î¬ÏƒÏ„Î·ÎºÎµ',
            generatedBy: 'Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ Î±Ï€ÏŒ Cyprus Real Estate',
            page: 'Î£ÎµÎ».',
            of: 'Î±Ï€ÏŒ',
            bed: 'Ï…Ï€Î½.',
            sqm: 'Ï„.Î¼.',
            noImage: 'Î§Ï‰ÏÎ¯Ï‚ ÎµÎ¹ÎºÏŒÎ½Î±',
            withVAT: 'Î¼Îµ Î¦Î Î‘',
            withoutVAT: 'Ï‡Ï‰ÏÎ¯Ï‚ Î¦Î Î‘',
            vat: 'Î¦Î Î‘',
            licenseNumber: 'Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î†Î´ÎµÎ¹Î±Ï‚',
            realEstateBroker: 'ÎœÎµÏƒÎ¹Ï„Î¹ÎºÏŒ Î“ÏÎ±Ï†ÎµÎ¯Î¿',
            propertyId: 'ID Î‘ÎºÎ¹Î½Î®Ï„Î¿Ï…'
        }
    },

    // Get translation
    t(key, lang = 'en') {
        return this.translations[lang]?.[key] || this.translations.en[key] || key;
    },

    // VAT rate for Cyprus
    VAT_RATE: 0.19,

    // Calculate price with/without VAT
    calculateVAT(price, includeVAT = true) {
        const numPrice = typeof price === 'number' ? price : parseInt((price || '').toString().replace(/[^\d]/g, ''));
        if (isNaN(numPrice)) return null;
        
        if (includeVAT) {
            return Math.round(numPrice * (1 + this.VAT_RATE));
        } else {
            return numPrice;
        }
    },

    // Format price with VAT options
    formatPrice(price, options = {}) {
        const { showVAT = false, showBoth = false } = options;
        
        if (typeof price === 'number') {
            if (showBoth) {
                const withoutVAT = price;
                const withVAT = this.calculateVAT(price, true);
                return {
                    withoutVAT: 'â‚¬' + withoutVAT.toLocaleString(),
                    withVAT: 'â‚¬' + withVAT.toLocaleString()
                };
            }
            const amount = showVAT ? this.calculateVAT(price, true) : price;
            return 'â‚¬' + amount.toLocaleString();
        }
        if (typeof price === 'string') {
            if (price.includes('â‚¬')) return price;
            const num = parseInt(price.replace(/[^\d]/g, ''));
            if (!isNaN(num)) {
                if (showBoth) {
                    const withoutVAT = num;
                    const withVAT = this.calculateVAT(num, true);
                    return {
                        withoutVAT: 'â‚¬' + withoutVAT.toLocaleString(),
                        withVAT: 'â‚¬' + withVAT.toLocaleString()
                    };
                }
                const amount = showVAT ? this.calculateVAT(num, true) : num;
                return 'â‚¬' + amount.toLocaleString();
            }
        }
        return price || 'N/A';
    },

    // Format date
    formatDate(date, lang = 'en') {
        const d = date ? new Date(date) : new Date();
        const locales = { en: 'en-GB', ru: 'ru-RU', el: 'el-GR' };
        return d.toLocaleDateString(locales[lang] || 'en-GB', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
    },

    // Load image as base64 with better error handling
    async loadImageAsBase64(url, timeout = 10000) {
        return new Promise((resolve) => {
            if (!url) {
                resolve(null);
                return;
            }

            // Skip placeholder images
            if (url.includes('unsplash.com')) {
                resolve(null);
                return;
            }

            // Convert Google Drive URLs to thumbnail format (cors-enabled)
            let imageUrl = url;
            if (url.includes('drive.google.com')) {
                let fileId = null;
                if (url.includes('/d/')) {
                    fileId = url.split('/d/')[1]?.split('/')[0];
                } else if (url.includes('id=')) {
                    fileId = url.split('id=')[1]?.split('&')[0];
                }
                if (fileId) {
                    // Use uc endpoint which has better CORS support
                    imageUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
                }
            }

            const img = new Image();
            // Try with and without CORS
            img.crossOrigin = 'anonymous';

            let resolved = false;
            const timeoutId = setTimeout(() => {
                if (!resolved) {
                    resolved = true;
                    console.log('Image load timeout:', url);
                    resolve(null);
                }
            }, timeout);

            img.onload = () => {
                if (resolved) return;
                resolved = true;
                clearTimeout(timeoutId);

                try {
                    const canvas = document.createElement('canvas');
                    const maxWidth = 300;
                    const maxHeight = 220;

                    let width = img.naturalWidth || img.width;
                    let height = img.naturalHeight || img.height;

                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    if (height > maxHeight) {
                        width = (maxHeight / height) * width;
                        height = maxHeight;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#f5f5f5';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);

                    resolve(canvas.toDataURL('image/jpeg', 0.85));
                } catch (e) {
                    console.error('Error converting image to base64:', e);
                    resolve(null);
                }
            };

            img.onerror = (e) => {
                if (resolved) return;
                resolved = true;
                clearTimeout(timeoutId);
                console.log('Image load error:', url, e);
                
                // Try without CORS as fallback
                if (img.crossOrigin) {
                    img.crossOrigin = null;
                    img.src = imageUrl;
                } else {
                    resolve(null);
                }
            };

            img.src = imageUrl;
        });
    },

    // Create placeholder image as base64
    createPlaceholderImage(text = 'No image') {
        const canvas = document.createElement('canvas');
        canvas.width = 220;
        canvas.height = 160;
        const ctx = canvas.getContext('2d');

        // Background
        ctx.fillStyle = '#f3f4f6';
        ctx.fillRect(0, 0, 220, 160);
        
        // Border
        ctx.strokeStyle = '#d1d5db';
        ctx.lineWidth = 2;
        ctx.strokeRect(0, 0, 220, 160);

        // Icon (camera/image icon)
        ctx.fillStyle = '#9ca3af';
        ctx.font = 'bold 24px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('ðŸ“·', 110, 70);

        // Text
        ctx.fillStyle = '#6b7280';
        ctx.font = '12px Arial';
        ctx.fillText(text, 110, 100);

        return canvas.toDataURL('image/png');
    },

    // Show loading overlay
    showLoading(message = 'Generating PDF...') {
        const existing = document.getElementById('pdfLoading');
        if (existing) existing.remove();

        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'pdfLoading';
        loadingDiv.style.cssText = `
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        `;
        loadingDiv.innerHTML = `
            <div style="background: white; padding: 30px 50px; border-radius: 12px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                <div style="width: 50px; height: 50px; border: 4px solid #e5e7eb; border-top-color: #6366f1; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <p style="margin: 0; font-size: 16px; font-weight: 500;" id="pdfLoadingText">${message}</p>
                <p style="margin: 10px 0 0; font-size: 12px; color: #888;" id="pdfLoadingSubtext">Please wait...</p>
            </div>
            <style>
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            </style>
        `;
        document.body.appendChild(loadingDiv);
    },

    // Update loading text
    updateLoading(text, subtext = '') {
        const textEl = document.getElementById('pdfLoadingText');
        const subtextEl = document.getElementById('pdfLoadingSubtext');
        if (textEl) textEl.textContent = text;
        if (subtextEl) subtextEl.textContent = subtext;
    },

    // Hide loading overlay
    hideLoading() {
        document.getElementById('pdfLoading')?.remove();
    },

    // Generate PDF for a selection (before client reviews)
    async generateSelectionPDF(options) {
        const {
            selectionName,
            clientName,
            brokerName = 'Cyprus Real Estate',
            properties,
            lang = 'en'
        } = options;

        if (typeof pdfMake === 'undefined') {
            alert('PDF library not loaded. Please refresh the page.');
            return;
        }

        this.showLoading(this.t('title', lang));
        this.updateLoading('Loading images...', `0 / ${properties.length}`);

        try {
            // Pre-load all images
            const placeholderImg = this.createPlaceholderImage(this.t('noImage', lang));
            const imagePromises = properties.map(async (prop, idx) => {
                const img = await this.loadImageAsBase64(prop.photos?.[0]);
                this.updateLoading('Loading images...', `${idx + 1} / ${properties.length}`);
                return { prop, img: img || placeholderImg };
            });

            const propertiesWithImages = await Promise.all(imagePromises);

            this.updateLoading('Generating PDF...', '');

            // Build document content
            const content = [];

            // Header
            content.push({
                text: this.t('title', lang),
                style: 'header',
                margin: [0, 0, 0, 5]
            });

            content.push({
                text: `${properties.length} ${this.t('properties', lang).toLowerCase()}`,
                style: 'subheader',
                margin: [0, 0, 0, 20]
            });

            // Info section
            if (clientName) {
                content.push({
                    text: `${this.t('preparedFor', lang)}: ${clientName}`,
                    style: 'info'
                });
            }
            content.push({
                text: `${this.t('preparedBy', lang)}: ${brokerName}`,
                style: 'info'
            });
            content.push({
                text: `${this.t('date', lang)}: ${this.formatDate(null, lang)}`,
                style: 'info',
                margin: [0, 0, 0, 10]
            });

            if (selectionName) {
                content.push({
                    text: selectionName,
                    style: 'selectionName',
                    margin: [0, 0, 0, 20]
                });
            }

            // Properties
            propertiesWithImages.forEach(({ prop, img }, index) => {
                const bedText = prop.bedrooms === 0 ? this.t('studio', lang) : `${prop.bedrooms} ${this.t('bed', lang)}`;
                const areaText = prop.area ? `${prop.area} ${this.t('sqm', lang)}` : '';
                const stats = [bedText, areaText, prop.type].filter(Boolean).join(' â€¢ ');

                const propertyTable = {
                    table: {
                        widths: [120, '*'],
                        body: [[
                            // Image column
                            {
                                image: img,
                                width: 110,
                                height: 80,
                                margin: [0, 5, 0, 5]
                            },
                            // Details column
                            {
                                stack: [
                                    {
                                        columns: [
                                            {
                                                text: `${index + 1}. ${prop.id || 'Property'}`,
                                                style: 'propertyTitle',
                                                width: '*'
                                            },
                                            {
                                                text: this.formatPrice(prop.cleanPrice || prop.price),
                                                style: 'propertyPrice',
                                                width: 'auto',
                                                alignment: 'right'
                                            }
                                        ]
                                    },
                                    {
                                        text: (prop.title || '').substring(0, 60),
                                        style: 'propertyStats',
                                        margin: [0, 2, 0, 0]
                                    },
                                    {
                                        text: prop.location || 'Cyprus',
                                        style: 'propertyLocation',
                                        margin: [0, 3, 0, 0]
                                    },
                                    {
                                        text: stats,
                                        style: 'propertyStats',
                                        margin: [0, 3, 0, 0]
                                    }
                                ],
                                margin: [10, 5, 5, 5]
                            }
                        ]]
                    },
                    layout: {
                        hLineWidth: () => 1,
                        vLineWidth: () => 1,
                        hLineColor: () => '#e5e7eb',
                        vLineColor: () => '#e5e7eb',
                        paddingLeft: () => 5,
                        paddingRight: () => 5,
                        paddingTop: () => 5,
                        paddingBottom: () => 5
                    },
                    margin: [0, 0, 0, 10]
                };

                content.push(propertyTable);
            });

            // Document definition
            const docDefinition = {
                content: content,
                styles: {
                    header: {
                        fontSize: 22,
                        bold: true,
                        color: '#1e1b4b'
                    },
                    subheader: {
                        fontSize: 12,
                        color: '#6b7280'
                    },
                    info: {
                        fontSize: 10,
                        color: '#6b7280',
                        margin: [0, 2, 0, 2]
                    },
                    selectionName: {
                        fontSize: 14,
                        bold: true,
                        color: '#1e1b4b'
                    },
                    propertyTitle: {
                        fontSize: 11,
                        bold: true,
                        color: '#1f2937'
                    },
                    propertyPrice: {
                        fontSize: 12,
                        bold: true,
                        color: '#6366f1'
                    },
                    propertyLocation: {
                        fontSize: 9,
                        color: '#6b7280'
                    },
                    propertyStats: {
                        fontSize: 9,
                        color: '#9ca3af'
                    },
                    propertyLink: {
                        fontSize: 8,
                        color: '#6366f1'
                    }
                },
                defaultStyle: {
                    font: 'Roboto'
                },
                footer: (currentPage, pageCount) => ({
                    columns: [
                        {
                            text: this.t('generatedBy', lang),
                            alignment: 'left',
                            fontSize: 8,
                            color: '#9ca3af',
                            margin: [40, 0, 0, 0]
                        },
                        {
                            text: `${this.t('page', lang)} ${currentPage} ${this.t('of', lang)} ${pageCount}`,
                            alignment: 'right',
                            fontSize: 8,
                            color: '#9ca3af',
                            margin: [0, 0, 40, 0]
                        }
                    ],
                    margin: [0, 10, 0, 0]
                }),
                pageMargins: [40, 40, 40, 50]
            };

            // Generate and download
            const fileName = `${(selectionName || 'Selection').replace(/[^a-zA-Z0-9Ð°-ÑÐ-Ð¯Ñ‘ÐÎ±-Ï‰Î‘-Î©\s]/g, '_')}_${lang.toUpperCase()}.pdf`;
            pdfMake.createPdf(docDefinition).download(fileName);

            this.hideLoading();
            return fileName;

        } catch (error) {
            console.error('PDF generation failed:', error);
            this.hideLoading();
            alert('Failed to generate PDF: ' + error.message);
        }
    },

    // Generate PDF with client reactions
    async generateResultsPDF(options) {
        const {
            selectionName,
            clientName,
            brokerName = 'Cyprus Real Estate',
            brokerLicense = '1234/E',
            brokerLogo = null,
            properties,
            reactions,
            lang = 'en',
            showForBroker = false
        } = options;

        if (typeof pdfMake === 'undefined') {
            alert('PDF library not loaded. Please refresh the page.');
            return;
        }

        this.showLoading(this.t('clientFeedback', lang));
        this.updateLoading('Generating PDF...', '');

        try {
            const liked = reactions.filter(r => r.reaction === 'like');
            const disliked = reactions.filter(r => r.reaction === 'dislike');
            const likeRate = reactions.length > 0 ? Math.round((liked.length / reactions.length) * 100) : 0;

            // Build document content
            const content = [];

            // Header with branding
            const headerRow = [];
            
            // Logo (if provided)
            if (brokerLogo) {
                headerRow.push({
                    image: brokerLogo,
                    width: 60,
                    margin: [0, 0, 15, 0]
                });
            }
            
            // Company info
            headerRow.push({
                stack: [
                    {
                        text: brokerName,
                        style: 'header',
                        margin: [0, 0, 0, 5]
                    },
                    {
                        text: `${this.t('realEstateBroker', lang)}`,
                        style: 'subheader',
                        margin: [0, 0, 0, 2]
                    },
                    {
                        text: `${this.t('licenseNumber', lang)} ${brokerLicense}`,
                        style: 'info',
                        color: '#6366f1',
                        bold: true
                    }
                ],
                width: '*'
            });
            
            content.push({
                columns: headerRow,
                margin: [0, 0, 0, 15]
            });
            
            content.push({
                canvas: [
                    {
                        type: 'line',
                        x1: 0, y1: 0,
                        x2: 515, y2: 0,
                        lineWidth: 2,
                        lineColor: '#6366f1'
                    }
                ],
                margin: [0, 0, 0, 20]
            });

            // Title
            content.push({
                text: this.t('clientFeedback', lang),
                style: 'header',
                margin: [0, 0, 0, 5]
            });

            content.push({
                text: selectionName || this.t('title', lang),
                style: 'subheader',
                margin: [0, 0, 0, 20]
            });

            // Info section
            if (clientName) {
                content.push({
                    text: `${this.t('preparedFor', lang)}: ${clientName}`,
                    style: 'info'
                });
            }
            content.push({
                text: `${this.t('date', lang)}: ${this.formatDate(null, lang)}`,
                style: 'info',
                margin: [0, 0, 0, 15]
            });

            // Summary stats
            content.push({
                table: {
                    widths: ['*', '*', '*', '*'],
                    body: [[
                        {
                            stack: [
                                { text: properties.length.toString(), style: 'statValue' },
                                { text: this.t('totalProperties', lang), style: 'statLabel' }
                            ],
                            alignment: 'center',
                            margin: [0, 10, 0, 10]
                        },
                        {
                            stack: [
                                { text: liked.length.toString(), style: 'statValueGreen' },
                                { text: this.t('liked', lang), style: 'statLabel' }
                            ],
                            alignment: 'center',
                            margin: [0, 10, 0, 10]
                        },
                        {
                            stack: [
                                { text: disliked.length.toString(), style: 'statValueRed' },
                                { text: this.t('passed', lang), style: 'statLabel' }
                            ],
                            alignment: 'center',
                            margin: [0, 10, 0, 10]
                        },
                        {
                            stack: [
                                { text: `${likeRate}%`, style: 'statValue' },
                                { text: this.t('likeRate', lang), style: 'statLabel' }
                            ],
                            alignment: 'center',
                            margin: [0, 10, 0, 10]
                        }
                    ]]
                },
                layout: {
                    hLineWidth: () => 1,
                    vLineWidth: () => 1,
                    hLineColor: () => '#e5e7eb',
                    vLineColor: () => '#e5e7eb'
                },
                margin: [0, 0, 0, 25]
            });

            // Liked section
            if (liked.length > 0) {
                content.push({
                    text: [
                        { text: 'â¤ ', style: 'sectionIconGreen' },
                        { text: `${this.t('liked', lang)} (${liked.length})`, style: 'sectionTitle' }
                    ],
                    margin: [0, 0, 0, 10]
                });

                liked.forEach(reaction => {
                    const prop = properties.find(p => p.id === reaction.property_id) || {};
                    content.push(this.createReactionRow(reaction, prop, 'like', lang, showForBroker));
                });

                content.push({ text: '', margin: [0, 0, 0, 15] });
            }

            // Passed section
            if (disliked.length > 0) {
                content.push({
                    text: [
                        { text: 'âœ• ', style: 'sectionIconRed' },
                        { text: `${this.t('passed', lang)} (${disliked.length})`, style: 'sectionTitle' }
                    ],
                    margin: [0, 0, 0, 10]
                });

                disliked.forEach(reaction => {
                    const prop = properties.find(p => p.id === reaction.property_id) || {};
                    content.push(this.createReactionRow(reaction, prop, 'dislike', lang, showForBroker));
                });
            }

            // Document definition
            const docDefinition = {
                content: content,
                styles: {
                    header: {
                        fontSize: 20,
                        bold: true,
                        color: '#1e1b4b'
                    },
                    subheader: {
                        fontSize: 12,
                        color: '#6b7280'
                    },
                    info: {
                        fontSize: 10,
                        color: '#6b7280',
                        margin: [0, 2, 0, 2]
                    },
                    statValue: {
                        fontSize: 18,
                        bold: true,
                        color: '#1f2937'
                    },
                    statValueGreen: {
                        fontSize: 18,
                        bold: true,
                        color: '#10b981'
                    },
                    statValueRed: {
                        fontSize: 18,
                        bold: true,
                        color: '#ef4444'
                    },
                    statLabel: {
                        fontSize: 9,
                        color: '#6b7280'
                    },
                    sectionTitle: {
                        fontSize: 13,
                        bold: true,
                        color: '#1f2937'
                    },
                    sectionIconGreen: {
                        fontSize: 13,
                        color: '#10b981'
                    },
                    sectionIconRed: {
                        fontSize: 13,
                        color: '#ef4444'
                    },
                    reactionTitle: {
                        fontSize: 10,
                        bold: true,
                        color: '#1f2937'
                    },
                    reactionPrice: {
                        fontSize: 10,
                        bold: true,
                        color: '#6366f1'
                    },
                    reactionPriceVAT: {
                        fontSize: 9,
                        bold: true,
                        color: '#10b981'
                    },
                    reactionDetails: {
                        fontSize: 8,
                        color: '#6b7280'
                    },
                    reactionLink: {
                        fontSize: 8,
                        color: '#6366f1'
                    }
                },
                defaultStyle: {
                    font: 'Roboto'
                },
                footer: (currentPage, pageCount) => ({
                    columns: [
                        {
                            text: this.t('generatedBy', lang),
                            alignment: 'left',
                            fontSize: 8,
                            color: '#9ca3af',
                            margin: [40, 0, 0, 0]
                        },
                        {
                            text: `${this.t('page', lang)} ${currentPage} ${this.t('of', lang)} ${pageCount}`,
                            alignment: 'right',
                            fontSize: 8,
                            color: '#9ca3af',
                            margin: [0, 0, 40, 0]
                        }
                    ],
                    margin: [0, 10, 0, 0]
                }),
                pageMargins: [40, 40, 40, 50]
            };

            // Generate and download
            const fileName = `${(selectionName || 'Results').replace(/[^a-zA-Z0-9Ð°-ÑÐ-Ð¯Ñ‘ÐÎ±-Ï‰Î‘-Î©\s]/g, '_')}_${this.t('clientFeedback', lang)}_${lang.toUpperCase()}.pdf`;
            pdfMake.createPdf(docDefinition).download(fileName);

            this.hideLoading();
            return fileName;

        } catch (error) {
            console.error('PDF generation failed:', error);
            this.hideLoading();
            alert('Failed to generate PDF: ' + error.message);
        }
    },

    // Create a reaction row for results PDF
    createReactionRow(reaction, prop, type, lang, showForBroker = false) {
        const isLike = type === 'like';
        const borderColor = isLike ? '#10b981' : '#ef4444';
        const icon = isLike ? 'â¤' : 'âœ•';

        const bedText = prop.bedrooms === 0 ? this.t('studio', lang) : `${prop.bedrooms} ${this.t('bed', lang)}`;
        const details = `${prop.location || 'Cyprus'} â€¢ ${bedText} â€¢ ${prop.area || '-'} ${this.t('sqm', lang)}`;

        // Calculate prices
        const basePrice = prop.cleanPrice || parseInt((prop.price || '').toString().replace(/[^\d]/g, '')) || 0;
        const priceWithoutVAT = this.formatPrice(basePrice);
        const priceWithVAT = this.formatPrice(this.calculateVAT(basePrice, true));

        // Build price stack
        const priceStack = [
            {
                text: priceWithoutVAT,
                style: 'reactionPrice',
                alignment: 'right'
            },
            {
                text: this.t('withoutVAT', lang),
                style: 'reactionDetails',
                alignment: 'right',
                margin: [0, 1, 0, 0]
            },
            {
                text: priceWithVAT,
                style: 'reactionPriceVAT',
                alignment: 'right',
                margin: [0, 3, 0, 0]
            },
            {
                text: this.t('withVAT', lang),
                style: 'reactionDetails',
                alignment: 'right',
                margin: [0, 1, 0, 3]
            }
        ];

        // Add property ID for broker
        if (showForBroker && prop.id) {
            priceStack.push({
                text: `${this.t('propertyId', lang)}: ${prop.id}`,
                style: 'reactionDetails',
                alignment: 'right',
                color: '#9ca3af',
                margin: [0, 3, 0, 0]
            });
        }


        const row = {
            table: {
                widths: [3, '*', 'auto'],
                body: [[
                    // Accent bar
                    { text: '', fillColor: borderColor },
                    // Main content
                    {
                        stack: [
                            {
                                text: [
                                    { text: icon + ' ', color: borderColor },
                                    { text: prop.id || 'Property', style: 'reactionTitle' }
                                ]
                            },
                            {
                                text: (reaction.property_title || prop.title || '').substring(0, 60),
                                style: 'reactionDetails',
                                margin: [0, 2, 0, 0]
                            },
                            {
                                text: details,
                                style: 'reactionDetails',
                                margin: [0, 3, 0, 0]
                            }
                        ],
                        margin: [8, 5, 5, 5]
                    },
                    // Price and info
                    {
                        stack: priceStack,
                        margin: [5, 5, 8, 5]
                    }
                ]]
            },
            layout: {
                hLineWidth: () => 1,
                vLineWidth: (i) => i === 0 ? 0 : 1,
                hLineColor: () => '#e5e7eb',
                vLineColor: () => '#e5e7eb',
                paddingLeft: () => 0,
                paddingRight: () => 0,
                paddingTop: () => 0,
                paddingBottom: () => 0
            },
            margin: [0, 0, 0, 8]
        };

        return row;
    },

    // Convert external URL to internal format
};

// Export
if (typeof window !== 'undefined') {
    window.PDFExport = PDFExport;
}
