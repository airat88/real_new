<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Cyprus Real Estate</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../assets/css/common.css">
    <link rel="stylesheet" href="../assets/css/broker.css">

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">

    <!-- PWA -->
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#1e1b4b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="../assets/icons/icon-192.png">
</head>
<body>
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileMenu()"></div>

    <div class="broker-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar__header">
                <a href="dashboard.html" class="sidebar__logo">
                    <span>üè†</span>
                    <span>RealEstate</span>
                </a>
            </div>

            <nav class="sidebar__nav">
                <a href="dashboard.html" class="nav-item nav-item--active">
                    <span class="nav-item__icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="properties.html" class="nav-item">
                    <span class="nav-item__icon">üè¢</span>
                    <span>Properties</span>
                </a>
                <a href="selections.html" class="nav-item">
                    <span class="nav-item__icon">üìã</span>
                    <span>Selections</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-item__icon">üë•</span>
                    <span>Clients</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-item__icon">üìà</span>
                    <span>Analytics</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-item__icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
                <a href="#" class="nav-item" onclick="logout(); return false;">
                    <span class="nav-item__icon">üö™</span>
                    <span>Logout</span>
                </a>
                <a href="../index.html" class="nav-item nav-item--home">
                    <span class="nav-item__icon">üåê</span>
                    <span>Home Page</span>
                </a>
            </nav>

            <div class="sidebar__footer">
                <div class="user-info">
                    <div class="user-avatar">MK</div>
                    <div class="user-details">
                        <div class="user-name">Maria Konstantinou</div>
                        <div class="user-role">Senior Broker</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="topbar">
                <button class="mobile-menu-btn" id="menuBtn" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <h1 class="topbar__title">Dashboard</h1>
                <div class="topbar__actions">
                    <button class="btn btn-primary" onclick="openCreateModal()">
                        + New Selection
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card__header">
                            <div class="stat-card__icon stat-card__icon--primary">üè¢</div>
                        </div>
                        <div class="stat-card__value" id="statProperties">-</div>
                        <div class="stat-card__label">Total Properties</div>
                        <div class="stat-card__change" id="statPropertiesChange">Loading...</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card__header">
                            <div class="stat-card__icon stat-card__icon--success">üìã</div>
                        </div>
                        <div class="stat-card__value" id="statSelections">-</div>
                        <div class="stat-card__label">Active Selections</div>
                        <div class="stat-card__change" id="statSelectionsChange">Loading...</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card__header">
                            <div class="stat-card__icon stat-card__icon--warning">üëÄ</div>
                        </div>
                        <div class="stat-card__value" id="statViewRate">-</div>
                        <div class="stat-card__label">View Rate</div>
                        <div class="stat-card__change" id="statViewRateChange">Loading...</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card__header">
                            <div class="stat-card__icon stat-card__icon--danger">‚ù§Ô∏è</div>
                        </div>
                        <div class="stat-card__value" id="statLikeRate">-</div>
                        <div class="stat-card__label">Like Rate</div>
                        <div class="stat-card__change" id="statLikeRateChange">Loading...</div>
                    </div>
                </div>

                <!-- Content Grid -->
                <div class="content-grid">
                    <!-- Recent Selections -->
                    <div class="section">
                        <div class="section__header">
                            <h2 class="section__title">Recent Selections</h2>
                            <a href="selections.html" class="btn btn-secondary">View All</a>
                        </div>
                        <div class="section__body">
                            <div class="selections-list" id="recentSelectionsList">
                                <div class="selection-item">
                                    <div class="selection-item__info">
                                        <div class="selection-item__name" style="color: var(--gray-400);">Loading selections...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="section">
                        <div class="section__header">
                            <h2 class="section__title">Recent Activity</h2>
                        </div>
                        <div class="section__body">
                            <div class="activity-list" id="recentActivityList">
                                <div class="activity-item">
                                    <div class="activity-item__content">
                                        <div class="activity-item__text" style="color: var(--gray-400);">Loading activity...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Selection Modal -->
    <div class="modal-overlay" id="createModal">
        <div class="modal">
            <div class="modal__header">
                <h3 class="modal__title">Create New Selection</h3>
                <button class="modal__close" onclick="closeCreateModal()">‚úï</button>
            </div>
            <div class="modal__body">
                <div class="form-group">
                    <label class="form-label">Selection Name</label>
                    <input type="text" class="input" placeholder="e.g., Apartments for John Smith">
                </div>

                <div class="form-group">
                    <label class="form-label">Description (optional)</label>
                    <textarea class="input" rows="3" placeholder="Add a personal message for your client..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Link Expiry</label>
                    <select class="input">
                        <option>7 days</option>
                        <option>14 days</option>
                        <option>30 days</option>
                        <option>No expiry</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Select Properties</label>
                    <p class="form-hint">You'll select properties on the next step</p>
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button class="btn btn-primary" onclick="goToSelectProperties()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/data-sync.js"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script src="../assets/js/auth-helper.js"></script>

    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('../sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW failed:', err));
        }

        // Check authentication
        async function checkAuth() {
            // Require authentication using AuthHelper
            const authenticated = await AuthHelper.requireAuth('login.html');
            
            if (!authenticated) return;

            // Get current user info
            const userInfo = await AuthHelper.getCurrentUserInfo();
            
            if (userInfo) {
                // Update user info in sidebar
                const userNameEl = document.querySelector('.user-name');
                const userRoleEl = document.querySelector('.user-role');
                const userAvatarEl = document.querySelector('.user-avatar');
                
                if (userNameEl) {
                    userNameEl.textContent = userInfo.name || userInfo.email.split('@')[0];
                }
                if (userRoleEl) {
                    userRoleEl.textContent = userInfo.role === 'broker' ? 'Broker' : 'Client';
                }
                if (userAvatarEl) {
                    const initials = (userInfo.name || userInfo.email)
                        .split(' ')
                        .map(n => n[0])
                        .join('')
                        .toUpperCase()
                        .slice(0, 2);
                    userAvatarEl.textContent = initials;
                }
            }

            // Initialize Supabase for data operations
            SupabaseClient.init();

            // Load dashboard data
            loadDashboardData();
        }

        // Logout function
        async function logout() {
            await AuthHelper.logout('Are you sure you want to sign out?');
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Auto-load CSV data if not in memory
                await DataSync.autoSync();

                // Load properties count
                const properties = DataSync.getProperties();
                const propCount = properties.length;
                document.getElementById('statProperties').textContent = propCount || '-';
                document.getElementById('statPropertiesChange').textContent = propCount > 0 ? 'From CSV' : 'Load data';
                document.getElementById('statPropertiesChange').className = 'stat-card__change';

                // Load selections from Supabase
                const selections = await SupabaseClient.getBrokerSelections();
                const activeSelections = selections.filter(s => s.status !== 'completed');

                document.getElementById('statSelections').textContent = activeSelections.length;
                document.getElementById('statSelectionsChange').textContent = `${selections.length} total`;
                document.getElementById('statSelectionsChange').className = 'stat-card__change';

                // Calculate view and like rates
                let totalViewed = 0;
                let totalProperties = 0;
                let totalLiked = 0;
                let totalReacted = 0;

                selections.forEach(s => {
                    totalProperties += s.total_properties || 0;
                    totalViewed += s.viewed_count || 0;
                    totalLiked += s.liked_count || 0;
                    totalReacted += (s.liked_count || 0) + (s.disliked_count || 0);
                });

                const viewRate = totalProperties > 0 ? Math.round((totalViewed / totalProperties) * 100) : 0;
                const likeRate = totalReacted > 0 ? Math.round((totalLiked / totalReacted) * 100) : 0;

                document.getElementById('statViewRate').textContent = viewRate + '%';
                document.getElementById('statViewRateChange').textContent = `${totalViewed}/${totalProperties} viewed`;
                document.getElementById('statViewRateChange').className = 'stat-card__change';

                document.getElementById('statLikeRate').textContent = likeRate + '%';
                document.getElementById('statLikeRateChange').textContent = `${totalLiked} liked`;
                document.getElementById('statLikeRateChange').className = 'stat-card__change';

                // Render recent selections
                renderRecentSelections(selections.slice(0, 5));

                // Render recent activity
                await renderRecentActivity(selections);

            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }

        // Render recent selections
        function renderRecentSelections(selections) {
            const container = document.getElementById('recentSelectionsList');

            if (selections.length === 0) {
                container.innerHTML = `
                    <div class="selection-item">
                        <div class="selection-item__info">
                            <div class="selection-item__name" style="color: var(--gray-400);">No selections yet</div>
                            <div class="selection-item__meta">
                                <span>Go to Properties to create one</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            const icons = ['üè†', 'üè¢', 'üèñÔ∏è', 'üèôÔ∏è', 'üå≥'];

            container.innerHTML = selections.map((s, i) => {
                const timeAgo = getTimeAgo(s.created_at);
                const icon = icons[i % icons.length];
                const hasReactions = s.liked_count > 0 || s.disliked_count > 0;

                return `
                    <div class="selection-item" onclick="window.location.href='selections.html'" style="cursor: pointer;">
                        <div class="selection-item__icon">${icon}</div>
                        <div class="selection-item__info">
                            <div class="selection-item__name">${s.name}</div>
                            <div class="selection-item__meta">
                                <span>${s.total_properties} properties</span>
                                <span>‚Ä¢</span>
                                <span>${timeAgo}</span>
                            </div>
                        </div>
                        <div class="selection-item__stats">
                            ${hasReactions ? `
                                <span class="selection-item__stat selection-item__stat--like">${s.liked_count} ‚ù§Ô∏è</span>
                                <span class="selection-item__stat selection-item__stat--dislike">${s.disliked_count} ‚úï</span>
                            ` : `
                                <span class="selection-item__stat selection-item__stat--pending">${s.status}</span>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render recent activity
        async function renderRecentActivity(selections) {
            const container = document.getElementById('recentActivityList');
            const activities = [];

            // Add selection creation events
            selections.slice(0, 3).forEach(s => {
                activities.push({
                    type: 'selection',
                    text: `Selection <strong>"${s.name}"</strong> created`,
                    time: s.created_at,
                    dotClass: 'activity-item__dot--primary'
                });
            });

            // Add completion events
            selections.filter(s => s.status === 'completed').slice(0, 2).forEach(s => {
                activities.push({
                    type: 'completed',
                    text: `Client finished viewing <strong>"${s.name}"</strong>`,
                    time: s.completed_at || s.created_at,
                    dotClass: 'activity-item__dot--success'
                });
            });

            // Sort by time
            activities.sort((a, b) => new Date(b.time) - new Date(a.time));

            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-item__content">
                            <div class="activity-item__text" style="color: var(--gray-400);">No activity yet</div>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = activities.slice(0, 5).map(a => `
                <div class="activity-item">
                    <div class="activity-item__dot ${a.dotClass}"></div>
                    <div class="activity-item__content">
                        <div class="activity-item__text">${a.text}</div>
                        <div class="activity-item__time">${getTimeAgo(a.time)}</div>
                    </div>
                </div>
            `).join('');
        }

        // Get time ago string
        function getTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString();
        }

        checkAuth();

        function openCreateModal() {
            document.getElementById('createModal').classList.add('modal-overlay--open');
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('modal-overlay--open');
        }

        function goToSelectProperties() {
            window.location.href = 'properties.html?mode=select';
        }

        // Close modal on backdrop click
        document.getElementById('createModal').addEventListener('click', (e) => {
            if (e.target.id === 'createModal') {
                closeCreateModal();
            }
        });

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeCreateModal();
        });

        // Mobile menu toggle
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const btn = document.getElementById('menuBtn');

            sidebar.classList.toggle('sidebar--open');
            overlay.classList.toggle('active');
            btn.classList.toggle('active');
        }
    </script>
</body>
</html>
