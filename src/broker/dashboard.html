<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Cyprus Real Estate</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../assets/css/common.css">
    <link rel="stylesheet" href="../assets/css/broker.css">

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">

    <!-- PWA -->
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#1e1b4b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="../assets/icons/icon-192.png">
</head>
<body>
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileMenu()"></div>

    <div class="broker-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar__header">
                <a href="dashboard.html" class="sidebar__logo">
                    <span>üè†</span>
                    <span>RealEstate</span>
                </a>
            </div>

            <nav class="sidebar__nav">
                <a href="dashboard.html" class="nav-item nav-item--active">
                    <span class="nav-item__icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="properties.html" class="nav-item">
                    <span class="nav-item__icon">üè¢</span>
                    <span>Properties</span>
                </a>
                <a href="add-property.html" class="nav-item" style="background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--primary);">
                    <span class="nav-item__icon">‚ûï</span>
                    <span>Add Property</span>
                </a>
                <a href="selections.html" class="nav-item">
                    <span class="nav-item__icon">üìã</span>
                    <span>Selections</span>
                </a>
                <a href="complex-manager.html" class="nav-item">
                    <span class="nav-item__icon">üèóÔ∏è</span>
                    <span>–ö–æ–º–ø–ª–µ–∫—Å—ã</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-item__icon">üë•</span>
                    <span>Clients</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-item__icon">üìà</span>
                    <span>Analytics</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-item__icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
                <a href="#" class="nav-item" onclick="logout(); return false;">
                    <span class="nav-item__icon">üö™</span>
                    <span>Logout</span>
                </a>
                <a href="../index.html" class="nav-item nav-item--home">
                    <span class="nav-item__icon">üåê</span>
                    <span>Home Page</span>
                </a>
            </nav>

            <div class="sidebar__footer">
                <div class="user-info">
                    <div class="user-avatar">MK</div>
                    <div class="user-details">
                        <div class="user-name">Maria Konstantinou</div>
                        <div class="user-role">Senior Broker</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="topbar">
                <button class="mobile-menu-btn" id="menuBtn" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <h1 class="topbar__title">Dashboard</h1>
                <div class="topbar__actions">
                    <button class="btn btn-secondary" onclick="loadDashboardData()" title="Refresh Dashboard Data" style="padding: 0 16px;">
                        üîÑ Refresh
                    </button>
                    <button class="btn btn-secondary" onclick="window.location.href='add-property.html'" title="Add New Property">
                        ‚ûï Add Property
                    </button>
                    <button class="btn btn-primary" onclick="openCreateModal()">
                        + New Selection
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card__header">
                            <div class="stat-card__icon stat-card__icon--primary">üè¢</div>
                        </div>
                        <div class="stat-card__value" id="statProperties">-</div>
                        <div class="stat-card__label">Total Properties</div>
                        <div class="stat-card__change" id="statPropertiesChange">Loading...</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card__header">
                            <div class="stat-card__icon stat-card__icon--success">üìã</div>
                        </div>
                        <div class="stat-card__value" id="statSelections">-</div>
                        <div class="stat-card__label">Active Selections</div>
                        <div class="stat-card__change" id="statSelectionsChange">Loading...</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card__header">
                            <div class="stat-card__icon stat-card__icon--warning">üëÄ</div>
                        </div>
                        <div class="stat-card__value" id="statViewRate">-</div>
                        <div class="stat-card__label">View Rate</div>
                        <div class="stat-card__change" id="statViewRateChange">Loading...</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card__header">
                            <div class="stat-card__icon stat-card__icon--danger">‚ù§Ô∏è</div>
                        </div>
                        <div class="stat-card__value" id="statLikeRate">-</div>
                        <div class="stat-card__label">Like Rate</div>
                        <div class="stat-card__change" id="statLikeRateChange">Loading...</div>
                    </div>
                </div>

                <!-- Content Grid -->
                <div class="content-grid">
                    <!-- Recent Selections -->
                    <div class="section">
                        <div class="section__header">
                            <h2 class="section__title">Recent Selections</h2>
                            <a href="selections.html" class="btn btn-secondary">View All</a>
                        </div>
                        <div class="section__body">
                            <div class="selections-list" id="recentSelectionsList">
                                <div class="selection-item">
                                    <div class="selection-item__info">
                                        <div class="selection-item__name" style="color: var(--gray-400);">Loading selections...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="section">
                        <div class="section__header">
                            <h2 class="section__title">Recent Activity</h2>
                        </div>
                        <div class="section__body">
                            <div class="activity-list" id="recentActivityList">
                                <div class="activity-item">
                                    <div class="activity-item__content">
                                        <div class="activity-item__text" style="color: var(--gray-400);">Loading activity...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Selection Modal -->
    <div class="modal-overlay" id="createModal">
        <div class="modal">
            <div class="modal__header">
                <h3 class="modal__title">Create New Selection</h3>
                <button class="modal__close" onclick="closeCreateModal()">‚úï</button>
            </div>
            <div class="modal__body">
                <div class="form-group">
                    <label class="form-label">Selection Name</label>
                    <input type="text" class="input" placeholder="e.g., Apartments for John Smith">
                </div>

                <div class="form-group">
                    <label class="form-label">Description (optional)</label>
                    <textarea class="input" rows="3" placeholder="Add a personal message for your client..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Link Expiry</label>
                    <select class="input">
                        <option>7 days</option>
                        <option>14 days</option>
                        <option>30 days</option>
                        <option>No expiry</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Select Properties</label>
                    <p class="form-hint">You'll select properties on the next step</p>
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button class="btn btn-primary" onclick="goToSelectProperties()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/data-sync.js"></script>
    <script src="../assets/js/supabase-client.js"></script>

    <script>
        // Supabase will be initialized by SupabaseClient.init() after page loads
        // This ensures the library is fully loaded before trying to create a client
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('../sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW failed:', err));
        }

        // Helper function to check if all components are ready
        function areComponentsReady() {
            const checks = {
                supabase: typeof supabase !== 'undefined',
                DataSync: typeof DataSync !== 'undefined',
                SupabaseClient: typeof SupabaseClient !== 'undefined',
                supabaseInit: SupabaseClient && SupabaseClient.initialized,
                domReady: document.readyState === 'complete' || document.readyState === 'interactive'
            };
            
            console.log('üìã Components readiness check:', checks);
            
            const allReady = Object.values(checks).every(v => v === true);
            if (!allReady) {
                const missing = Object.entries(checks)
                    .filter(([k, v]) => !v)
                    .map(([k]) => k);
                console.warn('‚ö†Ô∏è Not ready yet. Missing:', missing.join(', '));
            }
            return allReady;
        }

        // Check authentication
        async function checkAuth() {
            console.log('üîç Checking authentication...');
            
            // Prevent redirect loops - check if we're already redirecting
            if (sessionStorage.getItem('redirecting') === 'true') {
                console.log('‚è≥ Already redirecting, skipping check');
                return;
            }
            
            // Check localStorage session (demo accounts)
            const session = localStorage.getItem('broker_session');
            
            if (!session) {
                console.log('‚ùå No session found, redirecting to login');
                sessionStorage.setItem('redirecting', 'true');
                window.location.href = 'login.html?from=dashboard';
                return;
            }

            try {
                const sessionData = JSON.parse(session);
                console.log('‚úÖ Session found:', sessionData.email);
                
                // Clear redirect flag - we're successfully loaded
                sessionStorage.removeItem('redirecting');
                
                // Update user info in sidebar
                const userName = sessionData.email.split('@')[0];
                const userNameEl = document.querySelector('.user-name');
                if (userNameEl) {
                    userNameEl.textContent = userName.charAt(0).toUpperCase() + userName.slice(1);
                }
                
                // Initialize Supabase for data operations (not auth)
                console.log('üîß Initializing Supabase...');
                
                // Initialize with retry logic (CDN scripts may load async)
                const initSupabase = () => {
                    console.log('‚è≥ Calling SupabaseClient.init()...');
                    const result = SupabaseClient.init();
                    if (result && SupabaseClient.client) {
                        console.log('‚úÖ Supabase initialized successfully');
                        return true;
                    } else {
                        console.log('‚ùå Supabase init failed - library may not be loaded yet');
                        return false;
                    }
                };
                
                // Try to initialize, with retry if needed
                if (!initSupabase()) {
                    console.log('‚è≥ Waiting for Supabase library to load (retry in 800ms)...');
                    // Wait a bit and try again
                    setTimeout(() => {
                        if (!initSupabase()) {
                            console.error('‚ùå Failed to initialize Supabase after retry');
                            console.error('Check that CDN script loaded: https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
                        } else {
                            console.log('‚úÖ Supabase initialized after retry:', !!SupabaseClient.client);
                            // Load dashboard data after successful retry with additional delay
                            console.log('‚è≥ Scheduling loadDashboardData() after retry (400ms additional delay)...');
                            setTimeout(() => {
                                console.log('üöÄ Calling loadDashboardData() after retry...');
                                loadDashboardData();
                            }, 400); // Additional 400ms after retry
                        }
                    }, 800); // Wait 800ms for scripts to load
                    return; // Exit early, will continue in setTimeout
                }
                
                console.log('‚úÖ Supabase ready immediately:', !!SupabaseClient.client);
                
                // Check if DataSync is available
                console.log('üîß Checking DataSync availability...', typeof DataSync);
                console.log('üîß Checking SupabaseClient availability...', typeof SupabaseClient);

                // Load dashboard data with delay to ensure all libraries are ready
                // This fixes the issue where data doesn't appear until manual call
                console.log('‚è≥ Scheduling loadDashboardData() with 800ms delay...');
                setTimeout(() => {
                    // Double-check that all components are ready
                    if (areComponentsReady()) {
                        console.log('üöÄ Now calling loadDashboardData()...');
                        loadDashboardData();
                        console.log('‚úÖ loadDashboardData() called (async, will complete later)');
                    } else {
                        console.error('‚ùå Components still not ready after 800ms delay');
                        // Try one more time with longer delay
                        console.log('‚è≥ Attempting final retry in 1200ms...');
                        setTimeout(() => {
                            console.log('üöÄ Final attempt to call loadDashboardData()...');
                            loadDashboardData();
                        }, 1200);
                    }
                }, 800); // 800ms delay ensures all libraries are fully loaded
            } catch (e) {
                console.error('‚ùå Invalid session data:', e);
                localStorage.removeItem('broker_session');
                sessionStorage.setItem('redirecting', 'true');
                window.location.href = 'login.html?from=dashboard';
                return;
            }
        }

        // Logout function
        async function logout() {
            console.log('üö™ Logging out...');
            
            // Clear localStorage session first
            localStorage.removeItem('broker_session');
            
            // Sign out from Supabase
            try {
                await supabaseClient.auth.signOut();
                console.log('‚úÖ Signed out from Supabase');
            } catch (e) {
                console.log('‚ö†Ô∏è Supabase signout error:', e);
            }
            
            // Redirect to login with parameter to prevent auto-redirect back
            window.location.href = 'login.html?from=dashboard';
        }

        // Load dashboard data
        async function loadDashboardData() {
            console.log('üöÄ [START] loadDashboardData called');
            
            // Check if DOM elements exist
            const elements = {
                statProperties: document.getElementById('statProperties'),
                statPropertiesChange: document.getElementById('statPropertiesChange'),
                statSelections: document.getElementById('statSelections'),
                statSelectionsChange: document.getElementById('statSelectionsChange'),
                statViewRate: document.getElementById('statViewRate'),
                statViewRateChange: document.getElementById('statViewRateChange'),
                statLikeRate: document.getElementById('statLikeRate'),
                statLikeRateChange: document.getElementById('statLikeRateChange')
            };
            
            console.log('üìã DOM elements check:', {
                statProperties: !!elements.statProperties,
                statSelections: !!elements.statSelections,
                statViewRate: !!elements.statViewRate,
                statLikeRate: !!elements.statLikeRate
            });
            
            if (!elements.statProperties) {
                console.error('‚ùå CRITICAL: DOM elements not found!');
                return;
            }
            
            try {
                console.log('üìä Step 1: Loading dashboard data...');
                
                // Auto-load CSV data if not in memory
                console.log('üìä Step 2: Calling DataSync.autoSync()...');
                await DataSync.autoSync();
                console.log('‚úÖ Step 2: DataSync.autoSync() completed');

                // Load properties count
                console.log('üìä Step 3: Getting properties from DataSync...');
                const properties = DataSync.getProperties();
                const propCount = properties.length;
                console.log(`‚úÖ Step 3: Loaded ${propCount} properties`);
                
                elements.statProperties.textContent = propCount || '-';
                elements.statPropertiesChange.textContent = propCount > 0 ? 'From CSV' : 'Load data';
                elements.statPropertiesChange.className = 'stat-card__change';
                console.log('‚úÖ Step 3: Updated properties stats in DOM');

                // Load selections from Supabase (with fallback to mock data)
                console.log('üìä Step 4: Loading selections from Supabase...');
                let selections = [];
                
                try {
                    selections = await SupabaseClient.getBrokerSelections();
                    console.log(`‚úÖ Step 4: Loaded ${selections.length} selections from Supabase`);
                } catch (supabaseError) {
                    console.warn('‚ö†Ô∏è Supabase failed, using mock data:', supabaseError.message);
                    
                    // Use mock data as fallback
                    selections = [
                        {
                            id: 'mock-1',
                            name: 'Demo Selection 1',
                            status: 'active',
                            total_properties: 10,
                            viewed_count: 8,
                            liked_count: 5,
                            disliked_count: 3,
                            created_at: new Date().toISOString()
                        },
                        {
                            id: 'mock-2',
                            name: 'Demo Selection 2',
                            status: 'active',
                            total_properties: 5,
                            viewed_count: 5,
                            liked_count: 3,
                            disliked_count: 2,
                            created_at: new Date().toISOString()
                        },
                        {
                            id: 'mock-3',
                            name: 'Demo Selection 3',
                            status: 'completed',
                            total_properties: 7,
                            viewed_count: 7,
                            liked_count: 4,
                            disliked_count: 3,
                            created_at: new Date().toISOString(),
                            completed_at: new Date().toISOString()
                        }
                    ];
                    console.log('‚úÖ Using mock data:', selections.length, 'selections');
                }
                
                console.log(`‚úÖ Step 4: Processing ${selections.length} selections`);
                
                const activeSelections = selections.filter(s => s.status !== 'completed');
                console.log(`‚úÖ Step 4: Found ${activeSelections.length} active selections`);

                elements.statSelections.textContent = activeSelections.length || '-';
                elements.statSelectionsChange.textContent = `${selections.length} total`;
                elements.statSelectionsChange.className = 'stat-card__change';
                console.log('‚úÖ Step 4: Updated selections stats in DOM');

                // Calculate view and like rates
                console.log('üìä Step 5: Calculating rates...');
                let totalViewed = 0;
                let totalProperties = 0;
                let totalLiked = 0;
                let totalReacted = 0;

                selections.forEach(s => {
                    totalProperties += s.total_properties || 0;
                    totalViewed += s.viewed_count || 0;
                    totalLiked += s.liked_count || 0;
                    totalReacted += (s.liked_count || 0) + (s.disliked_count || 0);
                });

                const viewRate = totalProperties > 0 ? Math.round((totalViewed / totalProperties) * 100) : 0;
                const likeRate = totalReacted > 0 ? Math.round((totalLiked / totalReacted) * 100) : 0;
                
                console.log('‚úÖ Step 5: Calculated rates', {
                    viewRate,
                    likeRate,
                    totalViewed,
                    totalProperties,
                    totalLiked,
                    totalReacted
                });

                elements.statViewRate.textContent = viewRate + '%';
                elements.statViewRateChange.textContent = `${totalViewed}/${totalProperties} viewed`;
                elements.statViewRateChange.className = 'stat-card__change';

                elements.statLikeRate.textContent = likeRate + '%';
                elements.statLikeRateChange.textContent = `${totalLiked} liked`;
                elements.statLikeRateChange.className = 'stat-card__change';
                console.log('‚úÖ Step 5: Updated rates in DOM');

                console.log('‚úÖ [COMPLETE] Dashboard stats loaded successfully!');

                // Render recent selections
                console.log('üìä Step 6: Rendering recent selections...');
                renderRecentSelections(selections.slice(0, 5));
                console.log('‚úÖ Step 6: Recent selections rendered');

                // Render recent activity
                console.log('üìä Step 7: Rendering recent activity...');
                await renderRecentActivity(selections);
                console.log('‚úÖ Step 7: Recent activity rendered');
                
                console.log('üéâ [SUCCESS] All dashboard data loaded!');

            } catch (error) {
                console.error('‚ùå [ERROR] Failed to load dashboard data:', error);
                console.error('‚ùå Error message:', error.message);
                console.error('‚ùå Error stack:', error.stack);
                
                // Set default values if loading fails
                if (elements.statProperties) {
                    elements.statProperties.textContent = '-';
                    elements.statPropertiesChange.textContent = 'Error loading';
                    elements.statPropertiesChange.className = 'stat-card__change stat-card__change--negative';
                }
                
                if (elements.statSelections) {
                    elements.statSelections.textContent = '-';
                    elements.statSelectionsChange.textContent = 'Error loading';
                    elements.statSelectionsChange.className = 'stat-card__change stat-card__change--negative';
                }
                
                if (elements.statViewRate) {
                    elements.statViewRate.textContent = '-';
                    elements.statViewRateChange.textContent = 'Error loading';
                    elements.statViewRateChange.className = 'stat-card__change stat-card__change--negative';
                }
                
                if (elements.statLikeRate) {
                    elements.statLikeRate.textContent = '-';
                    elements.statLikeRateChange.textContent = 'Error loading';
                    elements.statLikeRateChange.className = 'stat-card__change stat-card__change--negative';
                }
            }
        }

        // Render recent selections
        function renderRecentSelections(selections) {
            const container = document.getElementById('recentSelectionsList');

            if (selections.length === 0) {
                container.innerHTML = `
                    <div class="selection-item">
                        <div class="selection-item__info">
                            <div class="selection-item__name" style="color: var(--gray-400);">No selections yet</div>
                            <div class="selection-item__meta">
                                <span>Go to Properties to create one</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            const icons = ['üè†', 'üè¢', 'üèñÔ∏è', 'üèôÔ∏è', 'üå≥'];

            container.innerHTML = selections.map((s, i) => {
                const timeAgo = getTimeAgo(s.created_at);
                const icon = icons[i % icons.length];
                const hasReactions = s.liked_count > 0 || s.disliked_count > 0;

                return `
                    <div class="selection-item" onclick="window.location.href='selections.html'" style="cursor: pointer;">
                        <div class="selection-item__icon">${icon}</div>
                        <div class="selection-item__info">
                            <div class="selection-item__name">${s.name}</div>
                            <div class="selection-item__meta">
                                <span>${s.total_properties} properties</span>
                                <span>‚Ä¢</span>
                                <span>${timeAgo}</span>
                            </div>
                        </div>
                        <div class="selection-item__stats">
                            ${hasReactions ? `
                                <span class="selection-item__stat selection-item__stat--like">${s.liked_count} ‚ù§Ô∏è</span>
                                <span class="selection-item__stat selection-item__stat--dislike">${s.disliked_count} ‚úï</span>
                            ` : `
                                <span class="selection-item__stat selection-item__stat--pending">${s.status}</span>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render recent activity
        async function renderRecentActivity(selections) {
            const container = document.getElementById('recentActivityList');
            const activities = [];

            // Add selection creation events
            selections.slice(0, 3).forEach(s => {
                activities.push({
                    type: 'selection',
                    text: `Selection <strong>"${s.name}"</strong> created`,
                    time: s.created_at,
                    dotClass: 'activity-item__dot--primary'
                });
            });

            // Add completion events
            selections.filter(s => s.status === 'completed').slice(0, 2).forEach(s => {
                activities.push({
                    type: 'completed',
                    text: `Client finished viewing <strong>"${s.name}"</strong>`,
                    time: s.completed_at || s.created_at,
                    dotClass: 'activity-item__dot--success'
                });
            });

            // Sort by time
            activities.sort((a, b) => new Date(b.time) - new Date(a.time));

            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-item__content">
                            <div class="activity-item__text" style="color: var(--gray-400);">No activity yet</div>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = activities.slice(0, 5).map(a => `
                <div class="activity-item">
                    <div class="activity-item__dot ${a.dotClass}"></div>
                    <div class="activity-item__content">
                        <div class="activity-item__text">${a.text}</div>
                        <div class="activity-item__time">${getTimeAgo(a.time)}</div>
                    </div>
                </div>
            `).join('');
        }

        // Get time ago string
        function getTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString();
        }

        checkAuth();

        function openCreateModal() {
            document.getElementById('createModal').classList.add('modal-overlay--open');
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('modal-overlay--open');
        }

        function goToSelectProperties() {
            window.location.href = 'properties.html?mode=select';
        }

        // Close modal on backdrop click
        document.getElementById('createModal').addEventListener('click', (e) => {
            if (e.target.id === 'createModal') {
                closeCreateModal();
            }
        });

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeCreateModal();
        });

        // Mobile menu toggle
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const btn = document.getElementById('menuBtn');

            sidebar.classList.toggle('sidebar--open');
            overlay.classList.toggle('active');
            btn.classList.toggle('active');
        }
    </script>
</body>
</html>
