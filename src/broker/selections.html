<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selections | Cyprus Real Estate</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../assets/css/common.css">
    <link rel="stylesheet" href="../assets/css/broker.css">

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">

    <!-- PWA -->
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#1e1b4b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="../assets/icons/icon-192.png">

    <style>
        .selections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: var(--space-lg);
        }

        .selection-card {
            background: var(--white);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition);
        }

        .selection-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .selection-card__header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
        }

        .selection-card__icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-lg);
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .selection-card__info {
            flex: 1;
            min-width: 0;
        }

        .selection-card__name {
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: var(--space-xs);
        }

        .selection-card__meta {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .selection-card__body {
            padding: var(--space-lg);
        }

        .selection-card__stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .mini-stat {
            text-align: center;
            padding: var(--space-md);
            background: var(--gray-100);
            border-radius: var(--radius-lg);
        }

        .mini-stat__value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .mini-stat__value--like { color: var(--success); }
        .mini-stat__value--dislike { color: var(--danger); }
        .mini-stat__value--pending { color: var(--warning); }

        .mini-stat__label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
        }

        .selection-card__progress {
            margin-bottom: var(--space-lg);
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            margin-bottom: var(--space-sm);
        }

        .progress-track {
            height: 8px;
            background: var(--gray-200);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            transition: width var(--transition);
        }

        .selection-card__actions {
            display: flex;
            gap: var(--space-sm);
        }

        .selection-card__actions .btn {
            flex: 1;
        }

        .status-badge {
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge--active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-badge--pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-badge--completed {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-2xl);
            color: var(--gray-500);
        }

        .empty-state__icon {
            font-size: 4rem;
            margin-bottom: var(--space-lg);
        }

        .empty-state__title {
            font-size: 1.25rem;
            color: var(--gray-700);
            margin-bottom: var(--space-sm);
        }

        /* Selection Detail Modal */
        .selection-detail-modal {
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .selection-detail__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
        }

        .selection-detail__title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .selection-detail__link {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-md);
            background: var(--gray-100);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-lg);
        }

        .selection-detail__link input {
            flex: 1;
            border: none;
            background: none;
            font-family: monospace;
            font-size: 0.875rem;
        }

        .selection-detail__stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .selection-detail__stat {
            text-align: center;
            padding: var(--space-md);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
        }

        .selection-detail__stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .selection-detail__stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .selection-detail__section {
            margin-bottom: var(--space-xl);
        }

        .selection-detail__section-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .property-reaction-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .property-reaction-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
        }

        .property-reaction-item--liked {
            border-left: 4px solid var(--success);
        }

        .property-reaction-item--disliked {
            border-left: 4px solid var(--danger);
        }

        .property-reaction-item__image {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: var(--radius);
            background: var(--gray-200);
        }

        .property-reaction-item__info {
            flex: 1;
            min-width: 0;
        }

        .property-reaction-item__title {
            font-weight: 600;
            margin-bottom: var(--space-xs);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .property-reaction-item__meta {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .property-reaction-item__link {
            padding: var(--space-sm) var(--space-md);
            background: var(--primary-light);
            color: var(--primary);
            border-radius: var(--radius);
            text-decoration: none;
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .property-reaction-item__link:hover {
            background: var(--primary);
            color: var(--white);
        }

        .no-reactions {
            text-align: center;
            padding: var(--space-xl);
            color: var(--gray-400);
        }

        /* Property reaction items clickable */
        .property-reaction-item {
            cursor: pointer;
            transition: all var(--transition);
        }

        .property-reaction-item:hover {
            background: var(--gray-50);
            transform: translateX(4px);
        }

        /* Property Detail Modal */
        .property-detail-modal {
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .property-detail__gallery {
            position: relative;
            width: 100%;
            height: 300px;
            background: var(--gray-200);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: var(--space-lg);
        }

        .property-detail__gallery-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .property-detail__gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .property-detail__gallery-nav--prev { left: 10px; }
        .property-detail__gallery-nav--next { right: 10px; }

        .property-detail__gallery-counter {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .property-detail__gallery-dots {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
        }

        .property-detail__gallery-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
        }

        .property-detail__gallery-dot--active {
            background: white;
        }

        .property-detail__title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: var(--space-sm);
        }

        .property-detail__price {
            font-size: 1.25rem;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: var(--space-md);
        }

        .property-detail__location {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            color: var(--gray-600);
            margin-bottom: var(--space-lg);
        }

        .property-detail__specs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            padding: var(--space-md);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
        }

        .property-detail__spec {
            text-align: center;
        }

        .property-detail__spec-value {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .property-detail__spec-label {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .property-detail__description {
            line-height: 1.6;
            color: var(--gray-700);
            margin-bottom: var(--space-lg);
        }

        .property-detail__features {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }

        .property-detail__feature {
            padding: var(--space-xs) var(--space-sm);
            background: var(--primary-light);
            color: var(--primary);
            border-radius: var(--radius);
            font-size: 0.875rem;
        }

        @media (max-width: 600px) {
            .property-detail__specs {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileMenu()"></div>

    <div class="broker-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar__header">
                <a href="dashboard.html" class="sidebar__logo">
                    <span>üè†</span>
                    <span>RealEstate</span>
                </a>
            </div>

            <nav class="sidebar__nav">
                <a href="dashboard.html" class="nav-item">
                    <span class="nav-item__icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="properties.html" class="nav-item">
                    <span class="nav-item__icon">üè¢</span>
                    <span>Properties</span>
                </a>
                <a href="selections.html" class="nav-item nav-item--active">
                    <span class="nav-item__icon">üìã</span>
                    <span>Selections</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-item__icon">üë•</span>
                    <span>Clients</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-item__icon">üìà</span>
                    <span>Analytics</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-item__icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
                <a href="#" class="nav-item" onclick="logout(); return false;">
                    <span class="nav-item__icon">üö™</span>
                    <span>Logout</span>
                </a>
                <a href="../index.html" class="nav-item nav-item--home">
                    <span class="nav-item__icon">üåê</span>
                    <span>Home Page</span>
                </a>
            </nav>

            <div class="sidebar__footer">
                <div class="user-info">
                    <div class="user-avatar">MK</div>
                    <div class="user-details">
                        <div class="user-name">Maria Konstantinou</div>
                        <div class="user-role">Senior Broker</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="topbar">
                <button class="mobile-menu-btn" id="menuBtn" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <h1 class="topbar__title">Selections</h1>
                <div class="topbar__actions">
                    <a href="properties.html" class="btn btn-primary">
                        + New Selection
                    </a>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <!-- Filter tabs -->
                <div class="filter-bar" style="margin-bottom: var(--space-xl);">
                    <button class="btn btn-primary">All (8)</button>
                    <button class="btn btn-secondary">Active (3)</button>
                    <button class="btn btn-secondary">Pending (2)</button>
                    <button class="btn btn-secondary">Completed (3)</button>
                </div>

                <!-- Selections Grid -->
                <div class="selections-grid">
                    <!-- Selection 1 - Completed -->
                    <div class="selection-card">
                        <div class="selection-card__header">
                            <div class="selection-card__icon">üè†</div>
                            <div class="selection-card__info">
                                <div class="selection-card__name">Apartments in Limassol</div>
                                <div class="selection-card__meta">
                                    6 properties ‚Ä¢ Created today
                                </div>
                            </div>
                            <span class="status-badge status-badge--completed">Completed</span>
                        </div>
                        <div class="selection-card__body">
                            <div class="selection-card__stats">
                                <div class="mini-stat">
                                    <div class="mini-stat__value mini-stat__value--like">4</div>
                                    <div class="mini-stat__label">Liked</div>
                                </div>
                                <div class="mini-stat">
                                    <div class="mini-stat__value mini-stat__value--dislike">2</div>
                                    <div class="mini-stat__label">Passed</div>
                                </div>
                                <div class="mini-stat">
                                    <div class="mini-stat__value">67%</div>
                                    <div class="mini-stat__label">Like Rate</div>
                                </div>
                            </div>
                            <div class="selection-card__progress">
                                <div class="progress-label">
                                    <span>Viewed</span>
                                    <span>6/6</span>
                                </div>
                                <div class="progress-track">
                                    <div class="progress-fill" style="width: 100%"></div>
                                </div>
                            </div>
                            <div class="selection-card__actions">
                                <button class="btn btn-secondary" onclick="copyLink()">Copy Link</button>
                                <button class="btn btn-secondary" onclick="exportPDF()">Export</button>
                                <button class="btn btn-primary" onclick="viewResults()">Results</button>
                            </div>
                        </div>
                    </div>

                    <!-- Selection 2 - Pending -->
                    <div class="selection-card">
                        <div class="selection-card__header">
                            <div class="selection-card__icon">üèñÔ∏è</div>
                            <div class="selection-card__info">
                                <div class="selection-card__name">Beachfront Villas</div>
                                <div class="selection-card__meta">
                                    4 properties ‚Ä¢ 2 days ago
                                </div>
                            </div>
                            <span class="status-badge status-badge--pending">Pending</span>
                        </div>
                        <div class="selection-card__body">
                            <div class="selection-card__stats">
                                <div class="mini-stat">
                                    <div class="mini-stat__value mini-stat__value--like">-</div>
                                    <div class="mini-stat__label">Liked</div>
                                </div>
                                <div class="mini-stat">
                                    <div class="mini-stat__value mini-stat__value--dislike">-</div>
                                    <div class="mini-stat__label">Passed</div>
                                </div>
                                <div class="mini-stat">
                                    <div class="mini-stat__value mini-stat__value--pending">0%</div>
                                    <div class="mini-stat__label">Viewed</div>
                                </div>
                            </div>
                            <div class="selection-card__progress">
                                <div class="progress-label">
                                    <span>Not viewed yet</span>
                                    <span>0/4</span>
                                </div>
                                <div class="progress-track">
                                    <div class="progress-fill" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="selection-card__actions">
                                <button class="btn btn-secondary" onclick="copyLink()">Copy Link</button>
                                <button class="btn btn-secondary" onclick="sendReminder()">Remind</button>
                                <button class="btn btn-primary" onclick="previewSelection()">Preview</button>
                            </div>
                        </div>
                    </div>

                    <!-- Selection 3 - Active -->
                    <div class="selection-card">
                        <div class="selection-card__header">
                            <div class="selection-card__icon">üèôÔ∏è</div>
                            <div class="selection-card__info">
                                <div class="selection-card__name">City Center Penthouses</div>
                                <div class="selection-card__meta">
                                    3 properties ‚Ä¢ 5 days ago
                                </div>
                            </div>
                            <span class="status-badge status-badge--active">Active</span>
                        </div>
                        <div class="selection-card__body">
                            <div class="selection-card__stats">
                                <div class="mini-stat">
                                    <div class="mini-stat__value mini-stat__value--like">2</div>
                                    <div class="mini-stat__label">Liked</div>
                                </div>
                                <div class="mini-stat">
                                    <div class="mini-stat__value mini-stat__value--dislike">0</div>
                                    <div class="mini-stat__label">Passed</div>
                                </div>
                                <div class="mini-stat">
                                    <div class="mini-stat__value">67%</div>
                                    <div class="mini-stat__label">Viewed</div>
                                </div>
                            </div>
                            <div class="selection-card__progress">
                                <div class="progress-label">
                                    <span>In progress</span>
                                    <span>2/3</span>
                                </div>
                                <div class="progress-track">
                                    <div class="progress-fill" style="width: 66%"></div>
                                </div>
                            </div>
                            <div class="selection-card__actions">
                                <button class="btn btn-secondary" onclick="copyLink()">Copy Link</button>
                                <button class="btn btn-secondary" onclick="exportPDF()">Export</button>
                                <button class="btn btn-primary" onclick="viewResults()">Results</button>
                            </div>
                        </div>
                    </div>

                    <!-- Selection 4 - Completed -->
                    <div class="selection-card">
                        <div class="selection-card__header">
                            <div class="selection-card__icon">üå≥</div>
                            <div class="selection-card__info">
                                <div class="selection-card__name">Family Homes Paphos</div>
                                <div class="selection-card__meta">
                                    8 properties ‚Ä¢ 1 week ago
                                </div>
                            </div>
                            <span class="status-badge status-badge--completed">Completed</span>
                        </div>
                        <div class="selection-card__body">
                            <div class="selection-card__stats">
                                <div class="mini-stat">
                                    <div class="mini-stat__value mini-stat__value--like">5</div>
                                    <div class="mini-stat__label">Liked</div>
                                </div>
                                <div class="mini-stat">
                                    <div class="mini-stat__value mini-stat__value--dislike">3</div>
                                    <div class="mini-stat__label">Passed</div>
                                </div>
                                <div class="mini-stat">
                                    <div class="mini-stat__value">63%</div>
                                    <div class="mini-stat__label">Like Rate</div>
                                </div>
                            </div>
                            <div class="selection-card__progress">
                                <div class="progress-label">
                                    <span>Viewed</span>
                                    <span>8/8</span>
                                </div>
                                <div class="progress-track">
                                    <div class="progress-fill" style="width: 100%"></div>
                                </div>
                            </div>
                            <div class="selection-card__actions">
                                <button class="btn btn-secondary" onclick="copyLink()">Copy Link</button>
                                <button class="btn btn-secondary" onclick="exportPDF()">Export</button>
                                <button class="btn btn-primary" onclick="viewResults()">Results</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Selection Detail Modal -->
    <div class="modal-overlay" id="selectionDetailModal">
        <div class="modal selection-detail-modal">
            <div class="modal__header">
                <h3 class="modal__title" id="detailModalTitle">Selection Details</h3>
                <button class="modal__close" onclick="closeDetailModal()">‚úï</button>
            </div>
            <div class="modal__body" id="detailModalContent">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal__footer" style="flex-wrap: wrap; gap: var(--space-sm);">
                <div style="display: flex; gap: var(--space-xs); align-items: center;">
                    <span style="font-size: 0.75rem; color: var(--gray-500);">PDF:</span>
                    <button class="btn btn-secondary btn-sm" onclick="exportResultsPDF('en')" title="English">üá¨üáß</button>
                    <button class="btn btn-secondary btn-sm" onclick="exportResultsPDF('ru')" title="Russian">üá∑üá∫</button>
                    <button class="btn btn-secondary btn-sm" onclick="exportResultsPDF('el')" title="Greek">üá¨üá∑</button>
                </div>
                <button class="btn btn-secondary" onclick="closeDetailModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Property Detail Modal -->
    <div class="modal-overlay" id="propertyDetailModal">
        <div class="modal property-detail-modal">
            <div class="modal__header">
                <h3 class="modal__title">Property Details</h3>
                <button class="modal__close" onclick="closePropertyModal()">‚úï</button>
            </div>
            <div class="modal__body" id="propertyModalContent">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal__footer">
                <button class="btn btn-secondary" onclick="closePropertyModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.js"></script>
    <script src="../assets/js/data-sync.js"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script src="../assets/js/pdf-export.js"></script>
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('../sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW failed:', err));
        }

        // Check authentication
        async function checkAuth() {
            if (!SupabaseClient.init()) {
                window.location.href = 'login.html';
                return;
            }

            const { data: { session } } = await SupabaseClient.client.auth.getSession();

            if (!session) {
                window.location.href = 'login.html';
                return;
            }
        }

        // Logout function
        async function logout() {
            if (SupabaseClient.client) {
                await SupabaseClient.client.auth.signOut();
            }
            window.location.href = 'login.html';
        }

        checkAuth();

        let selections = [];

        // Initialize
        async function init() {
            // Load CSV data for property details
            await DataSync.autoSync();
            await loadSelections();
        }

        // Load selections from Supabase
        async function loadSelections() {
            const grid = document.querySelector('.selections-grid');
            grid.innerHTML = '<div class="empty-state"><div class="empty-state__icon">‚è≥</div><p>Loading selections...</p></div>';

            try {
                selections = await SupabaseClient.getBrokerSelections();

                if (selections.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1/-1;">
                            <div class="empty-state__icon">üìã</div>
                            <div class="empty-state__title">No selections yet</div>
                            <p>Create your first selection from the Properties page</p>
                            <a href="properties.html" class="btn btn-primary" style="margin-top: var(--space-lg);">
                                Browse Properties
                            </a>
                        </div>
                    `;
                    return;
                }

                renderSelections();
                updateFilterCounts();
            } catch (error) {
                console.error('Failed to load selections:', error);
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-state__icon">‚ùå</div>
                        <p>Failed to load selections. Please refresh.</p>
                    </div>
                `;
            }
        }

        // Render selections
        function renderSelections(filter = 'all') {
            const grid = document.querySelector('.selections-grid');
            let filtered = selections;

            if (filter !== 'all') {
                filtered = selections.filter(s => s.status === filter);
            }

            grid.innerHTML = filtered.map(s => {
                const likeRate = s.viewed_count > 0
                    ? Math.round((s.liked_count / s.viewed_count) * 100)
                    : 0;
                const progress = s.total_properties > 0
                    ? Math.round((s.viewed_count / s.total_properties) * 100)
                    : 0;
                const statusClass = s.status === 'completed' ? 'completed' :
                                   s.status === 'active' ? 'active' : 'pending';
                const icon = s.status === 'completed' ? '‚úÖ' :
                            s.status === 'active' ? 'üîÑ' : '‚è≥';

                return `
                    <div class="selection-card" data-id="${s.id}">
                        <div class="selection-card__header">
                            <div class="selection-card__icon">${icon}</div>
                            <div class="selection-card__info">
                                <div class="selection-card__name">${s.name}</div>
                                <div class="selection-card__meta">
                                    ${s.total_properties} properties ‚Ä¢ ${SupabaseClient.formatDate(s.created_at)}
                                </div>
                            </div>
                            <span class="status-badge status-badge--${statusClass}">${s.status}</span>
                        </div>
                        <div class="selection-card__body">
                            <div class="selection-card__stats">
                                <div class="mini-stat">
                                    <div class="mini-stat__value mini-stat__value--like">${s.liked_count}</div>
                                    <div class="mini-stat__label">Liked</div>
                                </div>
                                <div class="mini-stat">
                                    <div class="mini-stat__value mini-stat__value--dislike">${s.disliked_count}</div>
                                    <div class="mini-stat__label">Passed</div>
                                </div>
                                <div class="mini-stat">
                                    <div class="mini-stat__value">${likeRate}%</div>
                                    <div class="mini-stat__label">Like Rate</div>
                                </div>
                            </div>
                            <div class="selection-card__progress">
                                <div class="progress-label">
                                    <span>${s.status === 'pending' ? 'Not viewed yet' : s.status === 'completed' ? 'Completed' : 'In progress'}</span>
                                    <span>${s.viewed_count}/${s.total_properties}</span>
                                </div>
                                <div class="progress-track">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            <div class="selection-card__actions">
                                <button class="btn btn-secondary" onclick="copyLink('${s.token}')">Copy Link</button>
                                <button class="btn btn-secondary" onclick="previewSelection('${s.token}')">Preview</button>
                                <button class="btn btn-primary" onclick="viewSelectionDetails('${s.id}')">Details</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update filter counts
        function updateFilterCounts() {
            const all = selections.length;
            const active = selections.filter(s => s.status === 'active').length;
            const pending = selections.filter(s => s.status === 'pending').length;
            const completed = selections.filter(s => s.status === 'completed').length;

            const buttons = document.querySelectorAll('.filter-bar .btn');
            buttons[0].textContent = `All (${all})`;
            buttons[1].textContent = `Active (${active})`;
            buttons[2].textContent = `Pending (${pending})`;
            buttons[3].textContent = `Completed (${completed})`;
        }

        // Filter buttons
        document.querySelectorAll('.filter-bar .btn').forEach((btn, index) => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-bar .btn').forEach(b => {
                    b.classList.remove('btn-primary');
                    b.classList.add('btn-secondary');
                });
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');

                const filters = ['all', 'active', 'pending', 'completed'];
                renderSelections(filters[index]);
            });
        });

        function copyLink(token) {
            const link = SupabaseClient.buildSelectionLink(token);
            navigator.clipboard.writeText(link).then(() => {
                alert('Link copied to clipboard!');
            });
        }

        async function deleteSelection(id) {
            if (!confirm('Are you sure you want to delete this selection?')) return;

            try {
                await SupabaseClient.deleteSelection(id);
                await loadSelections();
            } catch (error) {
                alert('Failed to delete selection');
            }
        }

        function previewSelection(token) {
            window.open(`../client/swipe.html?t=${token}`, '_blank');
        }

        // Store current selection data for PDF export
        let currentDetailSelection = null;

        // View selection details
        async function viewSelectionDetails(id) {
            const selection = selections.find(s => s.id === id);
            if (!selection) return;

            // Reset PDF export data
            currentDetailSelection = null;

            document.getElementById('detailModalTitle').textContent = selection.name;

            // Show loading
            document.getElementById('detailModalContent').innerHTML = `
                <div style="text-align: center; padding: var(--space-xl);">
                    <p>Loading details...</p>
                </div>
            `;
            document.getElementById('selectionDetailModal').classList.add('modal-overlay--open');

            try {
                // Get reactions for this selection
                const reactions = await SupabaseClient.getSelectionReactions(id);
                const properties = DataSync.getProperties();

                // Build property lookup
                const propMap = {};
                properties.forEach(p => propMap[p.id] = p);

                const likedReactions = reactions.filter(r => r.reaction === 'like');
                const dislikedReactions = reactions.filter(r => r.reaction === 'dislike');
                const likeRate = reactions.length > 0 ? Math.round((likedReactions.length / reactions.length) * 100) : 0;

                const link = SupabaseClient.buildSelectionLink(selection.token);

                const content = `
                    <div class="selection-detail__link">
                        <span>üîó</span>
                        <input type="text" value="${link}" readonly id="detailLink">
                        <button class="btn btn-sm btn-primary" onclick="copyDetailLink()">Copy</button>
                    </div>

                    <div class="selection-detail__stats">
                        <div class="selection-detail__stat">
                            <div class="selection-detail__stat-value">${selection.total_properties}</div>
                            <div class="selection-detail__stat-label">Properties</div>
                        </div>
                        <div class="selection-detail__stat">
                            <div class="selection-detail__stat-value" style="color: var(--success);">${likedReactions.length}</div>
                            <div class="selection-detail__stat-label">Liked</div>
                        </div>
                        <div class="selection-detail__stat">
                            <div class="selection-detail__stat-value" style="color: var(--danger);">${dislikedReactions.length}</div>
                            <div class="selection-detail__stat-label">Passed</div>
                        </div>
                        <div class="selection-detail__stat">
                            <div class="selection-detail__stat-value">${likeRate}%</div>
                            <div class="selection-detail__stat-label">Like Rate</div>
                        </div>
                    </div>

                    ${likedReactions.length > 0 ? `
                    <div class="selection-detail__section">
                        <div class="selection-detail__section-title">
                            <span style="color: var(--success);">‚ù§Ô∏è</span> Liked Properties (${likedReactions.length})
                        </div>
                        <div class="property-reaction-list">
                            ${likedReactions.map(r => renderReactionItem(r, propMap, 'liked')).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${dislikedReactions.length > 0 ? `
                    <div class="selection-detail__section">
                        <div class="selection-detail__section-title">
                            <span style="color: var(--danger);">‚úï</span> Passed Properties (${dislikedReactions.length})
                        </div>
                        <div class="property-reaction-list">
                            ${dislikedReactions.map(r => renderReactionItem(r, propMap, 'disliked')).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${reactions.length === 0 ? `
                    <div class="no-reactions">
                        <p>No reactions yet. Share the link with your client!</p>
                    </div>
                    ` : ''}

                    <div style="margin-top: var(--space-lg); text-align: center;">
                        <button class="btn btn-danger" onclick="confirmDeleteSelection('${id}')">
                            Delete Selection
                        </button>
                    </div>
                `;

                document.getElementById('detailModalContent').innerHTML = content;

                // Store data for PDF export
                const selectedPropertyIds = selection.property_ids || [];
                const selectedProperties = properties.filter(p => selectedPropertyIds.includes(p.id));

                currentDetailSelection = {
                    id: selection.id,
                    name: selection.name,
                    clientName: selection.client_name || null,
                    properties: selectedProperties,
                    reactions: reactions
                };

            } catch (error) {
                console.error('Failed to load details:', error);
                document.getElementById('detailModalContent').innerHTML = `
                    <div style="text-align: center; padding: var(--space-xl); color: var(--danger);">
                        <p>Failed to load details. Please try again.</p>
                    </div>
                `;
            }
        }

        function renderReactionItem(reaction, propMap, type) {
            const prop = propMap[reaction.property_id] || {};
            const photo = (prop.photos && prop.photos[0]) || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800';
            const title = reaction.property_title || prop.title || 'Unknown Property';
            const price = prop.price || (prop.cleanPrice ? `‚Ç¨${prop.cleanPrice.toLocaleString()}` : 'Price N/A');
            const location = prop.location || '';

            return `
                <div class="property-reaction-item property-reaction-item--${type}"
                     onclick="openPropertyModal('${reaction.property_id}')"
                     title="Click to view details">
                    <img src="${photo}" class="property-reaction-item__image"
                         onerror="this.src='https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800'">
                    <div class="property-reaction-item__info">
                        <div class="property-reaction-item__title">${title}</div>
                        <div class="property-reaction-item__meta">${price} ${location ? '‚Ä¢ ' + location : ''}</div>
                    </div>
                    <span class="property-reaction-item__link">View Details ‚Üí</span>
                </div>
            `;
        }

        // Property modal state
        let currentPropertyPhotos = [];
        let currentPropertyPhotoIndex = 0;

        // Open property detail modal
        function openPropertyModal(propertyId) {
            event.stopPropagation(); // Prevent bubbling to selection detail modal

            const properties = DataSync.getProperties();
            const prop = properties.find(p => p.id === propertyId);

            if (!prop) {
                alert('Property details not found');
                return;
            }

            // Set photos for gallery
            currentPropertyPhotos = prop.photos || [];
            currentPropertyPhotoIndex = 0;

            const photo = currentPropertyPhotos[0] || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800';
            const photoCount = currentPropertyPhotos.length;

            // Build features array
            const features = [];
            if (prop.veranda) features.push('Veranda');
            if (prop.basement) features.push('Basement');
            if (prop.pool) features.push('Pool');
            if (prop.parking) features.push('Parking');
            if (prop.seaView) features.push('Sea View');

            const content = `
                <div class="property-detail__gallery">
                    <img src="${photo}" class="property-detail__gallery-image" id="propertyGalleryImage"
                         onerror="this.src='https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800'">
                    ${photoCount > 1 ? `
                        <button class="property-detail__gallery-nav property-detail__gallery-nav--prev" onclick="navigatePropertyPhoto(-1)">‚ùÆ</button>
                        <button class="property-detail__gallery-nav property-detail__gallery-nav--next" onclick="navigatePropertyPhoto(1)">‚ùØ</button>
                        <div class="property-detail__gallery-counter" id="propertyPhotoCounter">1 / ${photoCount}</div>
                    ` : ''}
                </div>

                <h2 class="property-detail__title">${prop.id || 'Property'}</h2>
                ${prop.title ? `<div style="font-size: 0.875rem; color: var(--gray-600); margin-top: 8px; margin-bottom: 12px;">${prop.title}</div>` : ''}
                <div class="property-detail__price">${prop.price || (prop.cleanPrice ? '‚Ç¨' + prop.cleanPrice.toLocaleString() : 'Price on request')}</div>
                <div class="property-detail__location">üìç ${prop.location || 'Cyprus'}</div>

                <div class="property-detail__specs">
                    <div class="property-detail__spec">
                        <div class="property-detail__spec-value">${prop.bedrooms || '-'}</div>
                        <div class="property-detail__spec-label">Bedrooms</div>
                    </div>
                    <div class="property-detail__spec">
                        <div class="property-detail__spec-value">${prop.bathrooms || '-'}</div>
                        <div class="property-detail__spec-label">Bathrooms</div>
                    </div>
                    <div class="property-detail__spec">
                        <div class="property-detail__spec-value">${prop.area || '-'}</div>
                        <div class="property-detail__spec-label">Area m¬≤</div>
                    </div>
                    <div class="property-detail__spec">
                        <div class="property-detail__spec-value">${prop.pricePerSqm ? '‚Ç¨' + prop.pricePerSqm.toLocaleString() : '-'}</div>
                        <div class="property-detail__spec-label">Price/m¬≤</div>
                    </div>
                </div>

                ${prop.description ? `<p class="property-detail__description">${prop.description}</p>` : ''}

                ${features.length > 0 ? `
                    <div class="property-detail__features">
                        ${features.map(f => `<span class="property-detail__feature">${f}</span>`).join('')}
                    </div>
                ` : ''}
            `;

            document.getElementById('propertyModalContent').innerHTML = content;

            document.getElementById('propertyDetailModal').classList.add('modal-overlay--open');
        }

        // Navigate property photos
        function navigatePropertyPhoto(direction) {
            event.stopPropagation();
            if (currentPropertyPhotos.length <= 1) return;

            currentPropertyPhotoIndex += direction;
            if (currentPropertyPhotoIndex < 0) currentPropertyPhotoIndex = currentPropertyPhotos.length - 1;
            if (currentPropertyPhotoIndex >= currentPropertyPhotos.length) currentPropertyPhotoIndex = 0;

            const img = document.getElementById('propertyGalleryImage');
            const counter = document.getElementById('propertyPhotoCounter');

            img.src = currentPropertyPhotos[currentPropertyPhotoIndex];
            counter.textContent = `${currentPropertyPhotoIndex + 1} / ${currentPropertyPhotos.length}`;
        }

        // Close property modal
        function closePropertyModal() {
            document.getElementById('propertyDetailModal').classList.remove('modal-overlay--open');
        }

        function closeDetailModal() {
            document.getElementById('selectionDetailModal').classList.remove('modal-overlay--open');
        }

        function copyDetailLink() {
            const input = document.getElementById('detailLink');
            input.select();
            document.execCommand('copy');
            event.target.textContent = 'Copied!';
            setTimeout(() => event.target.textContent = 'Copy', 2000);
        }

        // Export results to PDF with reactions
        function exportResultsPDF(lang) {
            if (!currentDetailSelection) {
                alert('No selection data available');
                return;
            }

            PDFExport.generateResultsPDF({
                selectionName: currentDetailSelection.name,
                clientName: currentDetailSelection.clientName,
                brokerName: 'Cyprus Real Estate',
                brokerLicense: '1234/E', // TODO: Get from user settings
                brokerLogo: null, // TODO: Add logo upload functionality
                properties: currentDetailSelection.properties,
                reactions: currentDetailSelection.reactions,
                lang: lang,
                showForBroker: true // Show property IDs for broker version
            });
        }

        async function confirmDeleteSelection(id) {
            if (!confirm('Are you sure you want to delete this selection? This cannot be undone.')) return;

            try {
                await SupabaseClient.deleteSelection(id);
                closeDetailModal();
                await loadSelections();
            } catch (error) {
                alert('Failed to delete selection');
            }
        }

        // Modal close handlers
        document.getElementById('selectionDetailModal').addEventListener('click', (e) => {
            if (e.target.id === 'selectionDetailModal') closeDetailModal();
        });
        document.getElementById('propertyDetailModal').addEventListener('click', (e) => {
            if (e.target.id === 'propertyDetailModal') closePropertyModal();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Close property modal first if open
                if (document.getElementById('propertyDetailModal').classList.contains('modal-overlay--open')) {
                    closePropertyModal();
                } else {
                    closeDetailModal();
                }
            }
        });

        // Mobile menu toggle
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const btn = document.getElementById('menuBtn');

            sidebar.classList.toggle('sidebar--open');
            overlay.classList.toggle('active');
            btn.classList.toggle('active');
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
