<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Å–∞–º–∏</title>
    <link rel="stylesheet" href="../assets/css/common.css">
    <link rel="stylesheet" href="../assets/css/broker.css">
    <style>
        body {font-family: sans-serif; background: #f8fafc; padding: 2rem;}
        .container {max-width: 1600px; margin: 0 auto;}
        .header {background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 2rem; border-radius: 16px; margin-bottom: 2rem;}
        .stats {display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;}
        .stat {background: white; padding: 1.5rem; border-radius: 12px; text-align: center;}
        .stat-value {font-size: 2.5rem; font-weight: 700; color: #6366f1;}
        .content {display: grid; grid-template-columns: 400px 1fr; gap: 2rem;}
        .form-card {background: white; padding: 2rem; border-radius: 12px;}
        .form-group {margin-bottom: 1rem;}
        .form-group label {display: block; margin-bottom: 0.5rem; font-weight: 600;}
        .form-group select, .form-group input, .form-group textarea {width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px;}
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus {outline: none; border-color: #6366f1;}
        .btn {padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;}
        .btn-primary {background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white;}
        .preview {background: white; padding: 2rem; border-radius: 12px;}
        .properties-grid {display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;}
        .property-card {background: #f8fafc; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0;}
        .property-image {width: 100%; height: 150px; object-fit: cover;}
        .property-body {padding: 1rem;}
        .property-title {font-weight: 600; margin-bottom: 0.5rem; font-size: 0.875rem;}
        .property-details {display: flex; gap: 0.5rem; font-size: 0.75rem; color: #64748b;}
        
        /* Message styles */
        .info-message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            animation: slideIn 0.3s ease;
        }
        
        .info-message.editing {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .info-message.new {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèóÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Å–∞–º–∏</h1>
            <p>–î–æ–±–∞–≤–ª—è–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞—Ö</p>
        </div>

        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="totalCodes">0</div>
                <div>–ö–æ–¥–æ–≤ –æ–±—ä–µ–∫—Ç–æ–≤</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="totalProps">0</div>
                <div>–û–±—ä–µ–∫—Ç–æ–≤</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="totalComplexes">0</div>
                <div>–ö–æ–º–ø–ª–µ–∫—Å–æ–≤</div>
            </div>
        </div>

        <div class="content">
            <div class="form-card">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Å</h2>
                <form id="complexForm">
                    <div class="form-group">
                        <label>–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞ *</label>
                        <select id="objectCode" required>
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Å–∞ *</label>
                        <input type="text" id="complexName" required>
                    </div>
                    
                    <div class="form-group">
                        <label>–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫ *</label>
                        <input type="text" id="developer" required>
                    </div>
                    
                    <div class="form-group">
                        <label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                        <input type="tel" id="phone" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email">
                    </div>
                    
                    <div class="form-group">
                        <label>–í–µ–±-—Å–∞–π—Ç</label>
                        <input type="url" id="website">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </form>
            </div>

            <div class="preview">
                <h2>üì∏ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±—ä–µ–∫—Ç–æ–≤</h2>
                <div id="previewCount"></div>
                <div id="previewContainer"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/data-sync.js"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script>
        let allProperties = [];
        let objectCodes = [];

        async function init() {
            console.log('üöÄ Initializing...');
            
            await new Promise(r => setTimeout(r, 1000));
            
            if (typeof DataSync === 'undefined') {
                console.error('‚ùå DataSync not loaded');
                alert('–û—à–∏–±–∫–∞: DataSync –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                return;
            }
            
            await loadData();
        }

        async function loadData() {
            try {
                console.log('üì• Loading CSV...');
                await DataSync.autoSync();
                allProperties = await DataSync.getProperties();
                
                console.log('‚úÖ Loaded', allProperties.length, 'properties');
                
                // Show sample
                if (allProperties[0]) {
                    console.log('üìã Sample property:', {
                        object: allProperties[0].object,
                        projectTitle: allProperties[0].projectTitle,
                        price: allProperties[0].price,
                        photos: allProperties[0].photos?.length
                    });
                }
                
                // Extract unique codes from property.object field
                const codes = new Set();
                let extracted = 0;
                
                allProperties.forEach(p => {
                    if (p.object && p.object.trim()) {
                        codes.add(p.object.trim());
                        extracted++;
                    }
                });
                
                objectCodes = Array.from(codes).sort();
                console.log('‚úÖ Extracted', objectCodes.length, 'unique codes');
                console.log('üìä Codes:', objectCodes.slice(0, 20));
                console.log(`üìà Total: ${extracted} properties have codes`);
                
                if (objectCodes.length === 0) {
                    alert('‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–¥–æ–≤ –æ–±—ä–µ–∫—Ç–æ–≤!');
                    return;
                }
                
                populateDropdown();
                updateStats();
                
            } catch (e) {
                console.error('‚ùå Error:', e);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message);
            }
        }

        function populateDropdown() {
            const select = document.getElementById('objectCode');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞...</option>';
            
            objectCodes.forEach(code => {
                // Count properties for this code
                const count = allProperties.filter(p => p.object === code).length;
                
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${code} (${count} ${count === 1 ? '–æ–±—ä–µ–∫—Ç' : count < 5 ? '–æ–±—ä–µ–∫—Ç–∞' : '–æ–±—ä–µ–∫—Ç–æ–≤'})`;
                select.appendChild(option);
            });
            
            console.log('‚úÖ Dropdown populated');
            
            select.addEventListener('change', async e => {
                if (e.target.value) {
                    await loadComplexData(e.target.value);
                    showPreview(e.target.value);
                } else {
                    clearForm();
                    clearPreview();
                }
            });
        }

        // Load existing complex data from Supabase
        async function loadComplexData(code) {
            console.log('üîç Checking for existing data for code:', code);
            
            if (typeof SupabaseClient === 'undefined' || !SupabaseClient.client) {
                console.log('‚ö†Ô∏è Supabase not available');
                return;
            }
            
            try {
                SupabaseClient.init();
                
                const { data, error } = await SupabaseClient.client
                    .from('complex_info')
                    .select('*')
                    .eq('object_code', code)
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        // No data found - this is ok, new entry
                        console.log('‚ÑπÔ∏è No existing data for this code');
                        clearForm();
                        showNewEntryMessage();
                    } else {
                        console.error('Error loading complex data:', error);
                    }
                    return;
                }
                
                if (data) {
                    console.log('‚úÖ Found existing data:', data);
                    fillFormWithData(data);
                    showEditingMessage(data);
                }
                
            } catch (e) {
                console.log('No existing data:', e);
                clearForm();
                showNewEntryMessage();
            }
        }

        // Fill form with existing data
        function fillFormWithData(data) {
            document.getElementById('complexName').value = data.complex_name || '';
            document.getElementById('developer').value = data.developer_name || '';
            document.getElementById('phone').value = data.phone || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('website').value = data.website || '';
            
            // Store the ID for update
            document.getElementById('objectCode').dataset.existingId = data.id;
            
            // Update button text
            const submitBtn = document.querySelector('.btn-primary');
            submitBtn.textContent = '‚úèÔ∏è –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
            submitBtn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
        }

        // Show editing message
        function showEditingMessage(data) {
            let messageDiv = document.getElementById('existingDataMessage');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'existingDataMessage';
                messageDiv.style.cssText = `
                    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                    color: white;
                    padding: 1rem;
                    border-radius: 8px;
                    margin-bottom: 1rem;
                    font-size: 0.875rem;
                `;
                document.querySelector('.form-card h2').after(messageDiv);
            }
            
            messageDiv.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 0.5rem;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö</div>
                <div style="opacity: 0.9;">
                    –ö–æ–º–ø–ª–µ–∫—Å: <strong>${data.complex_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</strong><br>
                    –ó–∞—Å—Ç—Ä–æ–π—â–∏–∫: <strong>${data.developer_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</strong><br>
                    <small>–ò–∑–º–µ–Ω–∏—Ç–µ –ø–æ–ª—è –∏ –Ω–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"</small>
                </div>
            `;
        }

        // Show new entry message
        function showNewEntryMessage() {
            let messageDiv = document.getElementById('existingDataMessage');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'existingDataMessage';
                messageDiv.style.cssText = `
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    padding: 1rem;
                    border-radius: 8px;
                    margin-bottom: 1rem;
                    font-size: 0.875rem;
                `;
                document.querySelector('.form-card h2').after(messageDiv);
            }
            
            messageDiv.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 0.5rem;">‚ûï –ù–æ–≤—ã–π –∫–æ–º–ø–ª–µ–∫—Å</div>
                <div style="opacity: 0.9;">
                    –î–ª—è —ç—Ç–æ–≥–æ –∫–æ–¥–∞ –ø–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
                </div>
            `;
            
            // Reset button
            const submitBtn = document.querySelector('.btn-primary');
            submitBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            submitBtn.style.background = 'linear-gradient(135deg, #6366f1, #8b5cf6)';
        }

        // Clear form
        function clearForm() {
            document.getElementById('complexName').value = '';
            document.getElementById('developer').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('email').value = '';
            document.getElementById('website').value = '';
            
            delete document.getElementById('objectCode').dataset.existingId;
            
            // Remove message if exists
            const messageDiv = document.getElementById('existingDataMessage');
            if (messageDiv) {
                messageDiv.remove();
            }
            
            // Reset button
            const submitBtn = document.querySelector('.btn-primary');
            submitBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            submitBtn.style.background = 'linear-gradient(135deg, #6366f1, #8b5cf6)';
        }

        function showPreview(code) {
            const props = allProperties.filter(p => p.object === code);
            
            document.getElementById('previewCount').textContent = 
                `–ù–∞–π–¥–µ–Ω–æ: ${props.length} ${props.length === 1 ? '–æ–±—ä–µ–∫—Ç' : props.length < 5 ? '–æ–±—ä–µ–∫—Ç–∞' : '–æ–±—ä–µ–∫—Ç–æ–≤'}`;
            
            const container = document.getElementById('previewContainer');
            
            if (props.length === 0) {
                container.innerHTML = '<p>–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–¥–∞</p>';
                return;
            }

            container.innerHTML = '<div class="properties-grid">' +
                props.map(p => `
                    <div class="property-card">
                        <img src="${p.photos[0]}" class="property-image" onerror="this.style.display='none'">
                        <div class="property-body">
                            <div style="font-size:1.1rem;font-weight:700;color:#6366f1;margin-bottom:0.5rem">
                                ${p.price || '–ü–æ –∑–∞–ø—Ä–æ—Å—É'}
                            </div>
                            <div class="property-title">${p.projectTitle || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                            <div class="property-details">
                                <span>üõèÔ∏è ${p.bedrooms || '?'}</span>
                                <span>üìê ${p.area || '?'}m¬≤</span>
                            </div>
                        </div>
                    </div>
                `).join('') +
                '</div>';
        }

        function clearPreview() {
            document.getElementById('previewCount').textContent = '';
            document.getElementById('previewContainer').innerHTML = '';
        }

        function updateStats() {
            document.getElementById('totalCodes').textContent = objectCodes.length;
            document.getElementById('totalProps').textContent = allProperties.length;
            document.getElementById('totalComplexes').textContent = '0';
        }

        // Form submit
        document.getElementById('complexForm').addEventListener('submit', async e => {
            e.preventDefault();
            
            if (typeof SupabaseClient === 'undefined') {
                alert('Supabase –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
                return;
            }
            
            const existingId = document.getElementById('objectCode').dataset.existingId;
            const isUpdate = !!existingId;
            
            const formData = {
                object_code: document.getElementById('objectCode').value,
                complex_name: document.getElementById('complexName').value,
                developer_name: document.getElementById('developer').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value || null,
                website: document.getElementById('website').value || null,
            };
            
            try {
                SupabaseClient.init();
                
                let error;
                
                if (isUpdate) {
                    // Update existing record
                    console.log('Updating existing complex:', existingId);
                    const result = await SupabaseClient.client
                        .from('complex_info')
                        .update(formData)
                        .eq('id', existingId);
                    error = result.error;
                    
                    if (!error) {
                        alert('‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
                    }
                } else {
                    // Insert new record
                    console.log('Creating new complex');
                    formData.created_by = 'broker';
                    const result = await SupabaseClient.client
                        .from('complex_info')
                        .insert([formData]);
                    error = result.error;
                    
                    if (!error) {
                        alert('‚úÖ –ö–æ–º–ø–ª–µ–∫—Å –¥–æ–±–∞–≤–ª–µ–Ω!');
                    }
                }
                
                if (error) throw error;
                
                // Reset form
                document.getElementById('complexForm').reset();
                clearForm();
                clearPreview();
                
                // Reset dropdown
                document.getElementById('objectCode').value = '';
                
            } catch (error) {
                console.error('Error:', error);
                if (error.code === '23505') {
                    alert('‚ùå –ö–æ–º–ø–ª–µ–∫—Å —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
                }
            }
        });

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
