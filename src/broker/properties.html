<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Properties | Cyprus Real Estate</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../assets/css/common.css">
    <link rel="stylesheet" href="../assets/css/broker.css">
    
    <!-- Leaflet CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">

    <!-- PWA -->
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#1e1b4b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="../assets/icons/icon-192.png">

    <style>
        .property-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--space-lg);
        }

        .property-card-broker {
            background: var(--white);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition);
            cursor: pointer;
            position: relative;
        }

        .property-card-broker:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .property-card-broker.selected {
            box-shadow: 0 0 0 3px var(--primary);
        }

        .property-card-broker__checkbox {
            position: absolute;
            top: var(--space-md);
            left: var(--space-md);
            width: 24px;
            height: 24px;
            border-radius: var(--radius);
            background: var(--white);
            border: 2px solid var(--gray-300);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all var(--transition);
        }

        .property-card-broker.selected .property-card-broker__checkbox {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--white);
        }

        .property-card-broker__image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: var(--gray-200);
        }

        .property-card-broker__body {
            padding: var(--space-md);
        }

        .property-card-broker__price {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: var(--space-xs);
        }

        .property-card-broker__title {
            font-weight: 600;
            margin-bottom: var(--space-xs);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .property-card-broker__location {
            font-size: 0.875rem;
            color: var(--gray-500);
            margin-bottom: var(--space-md);
        }

        .property-card-broker__tags {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }

        .property-card-broker__tag {
            padding: var(--space-xs) var(--space-sm);
            background: var(--gray-100);
            border-radius: var(--radius);
            font-size: 0.75rem;
            color: var(--gray-600);
        }

        .selection-bar {
            position: fixed;
            bottom: 0;
            left: 260px;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--gray-200);
            padding: var(--space-md) var(--space-xl);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transform: translateY(100%);
            transition: transform var(--transition);
            z-index: 100;
        }

        .selection-bar.visible {
            transform: translateY(0);
        }

        .selection-bar__info {
            font-weight: 500;
        }

        .selection-bar__actions {
            display: flex;
            gap: var(--space-md);
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .sync-status__dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .sync-status__dot--syncing {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        .stats-bar {
            display: flex;
            gap: var(--space-xl);
            margin-bottom: var(--space-lg);
            padding: var(--space-md);
            background: var(--white);
            border-radius: var(--radius-lg);
        }

        .stats-bar__item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .stats-bar__value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stats-bar__label {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-2xl);
            color: var(--gray-500);
        }

        .empty-state__icon {
            font-size: 4rem;
            margin-bottom: var(--space-lg);
        }

        /* Property Detail Modal */
        .property-detail {
            max-width: 600px;
        }

        .property-detail__image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-lg);
        }

        .property-detail__header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }

        .property-detail__price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .property-detail__unit {
            font-size: 0.875rem;
            color: var(--gray-500);
            background: var(--gray-100);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius);
        }

        .property-detail__title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }

        .property-detail__location {
            color: var(--gray-500);
            margin-bottom: var(--space-lg);
        }

        .property-detail__grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .property-detail__stat {
            text-align: center;
            padding: var(--space-md);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
        }

        .property-detail__stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .property-detail__stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .property-detail__section {
            margin-bottom: var(--space-lg);
        }

        .property-detail__section-title {
            font-weight: 600;
            margin-bottom: var(--space-sm);
            color: var(--gray-700);
        }

        .property-detail__features {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
        }

        .property-detail__feature {
            padding: var(--space-xs) var(--space-sm);
            background: var(--gray-100);
            border-radius: var(--radius);
            font-size: 0.875rem;
        }

        .property-detail__link {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-md);
            background: var(--primary-light);
            border-radius: var(--radius-lg);
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: all var(--transition);
        }

        .property-detail__link:hover {
            background: var(--primary);
            color: var(--white);
        }

        /* Map Styles */
        .property-detail__map-section {
            margin-top: var(--space-xl);
        }

        .property-detail__map {
            width: 100%;
            height: 350px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .property-card-broker__actions {
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            display: flex;
            gap: var(--space-xs);
            z-index: 10;
        }

        .property-card-broker__btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius);
            background: var(--white);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .property-card-broker__btn:hover {
            transform: scale(1.1);
        }

        /* Photo Gallery in Modal */
        .property-detail__gallery {
            position: relative;
            margin-bottom: var(--space-lg);
        }

        .property-detail__main-photo {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: var(--radius-lg);
        }

        .property-detail__photo-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
            box-shadow: var(--shadow-md);
        }

        .property-detail__photo-nav:hover {
            background: var(--white);
            transform: translateY(-50%) scale(1.1);
        }

        .property-detail__photo-nav--prev {
            left: var(--space-sm);
        }

        .property-detail__photo-nav--next {
            right: var(--space-sm);
        }

        .property-detail__photo-counter {
            position: absolute;
            bottom: var(--space-sm);
            right: var(--space-sm);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius);
            font-size: 0.75rem;
        }

        .property-detail__thumbs {
            display: flex;
            gap: var(--space-xs);
            margin-top: var(--space-sm);
            overflow-x: auto;
            padding-bottom: var(--space-xs);
        }

        .property-detail__thumb {
            width: 60px;
            height: 45px;
            object-fit: cover;
            border-radius: var(--radius);
            cursor: pointer;
            opacity: 0.6;
            transition: all var(--transition);
            flex-shrink: 0;
            border: 2px solid transparent;
        }

        .property-detail__thumb:hover {
            opacity: 0.9;
        }

        .property-detail__thumb.active {
            opacity: 1;
            border-color: var(--primary);
        }

        @media (max-width: 768px) {
            .selection-bar {
                left: 0;
            }
        }

        /* Client Modal Styles */
        .form-group {
            margin-bottom: var(--space-md);
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: var(--space-sm);
            color: var(--gray-700);
        }

        .client-tabs {
            display: flex;
            gap: var(--space-xs);
        }

        .client-tab {
            flex: 1;
            padding: var(--space-sm) var(--space-md);
            background: var(--gray-100);
            border: 2px solid transparent;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-600);
            transition: all var(--transition);
        }

        .client-tab:hover {
            background: var(--gray-200);
        }

        .client-tab.active {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
        }

        .client-panel {
            padding: var(--space-md);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            min-height: 80px;
        }

        textarea.input {
            resize: vertical;
            min-height: 60px;
        }
        /* Range Slider Styles */
        .range-slider-container {
            margin-top: var(--space-md);
            margin-bottom: var(--space-sm);
        }

        .range-values {
            display: flex;
            justify-content: space-between;
            color: var(--gray-600);
            font-size: 0.75rem;
            margin-bottom: var(--space-sm);
            font-weight: 600;
        }

        .range-slider {
            position: relative;
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            margin-bottom: var(--space-md);
            cursor: pointer;
        }

        .range-slider__track {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #5eead4);
            border-radius: 3px;
            transition: all 0.1s ease;
        }

        .range-slider__thumb {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--white);
            border: 3px solid var(--primary);
            border-radius: 50%;
            cursor: grab;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            z-index: 2;
        }

        .range-slider__thumb:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
        }

        .range-slider__thumb:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.15);
            border-color: var(--primary-dark);
        }

        .range-slider__thumb.active {
            z-index: 3;
        }
        /* Price Preset Buttons */
        .price-preset-btn {
            padding: 8px 14px;
            border: 2px solid var(--gray-200, #e2e8f0);
            border-radius: 8px;
            background: white;
            color: var(--gray-700, #374151);
            font-size: 0.8125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .price-preset-btn:hover {
            border-color: var(--primary, #6366f1);
            background: var(--primary-50, #eef2ff);
            color: var(--primary, #6366f1);
            transform: translateY(-1px);
        }
        
        .price-preset-btn:active {
            transform: translateY(0);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .price-preset-btn {
                padding: 10px 16px;
                font-size: 0.875rem;
                min-width: 80px;
                text-align: center;
            }
            
            .price-presets {
                margin-bottom: 16px !important;
            }
            
            /* Make range slider thumbs bigger on mobile */
            .range-slider__thumb {
                width: 20px !important;
                height: 20px !important;
            }
            
            /* Increase touch target for range slider */
            .range-slider {
                padding: 12px 0 !important;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileMenu()"></div>

    <div class="broker-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar__header">
                <a href="dashboard.html" class="sidebar__logo">
                    <span>üè†</span>
                    <span>RealEstate</span>
                </a>
            </div>

            <nav class="sidebar__nav">
                <a href="dashboard.html" class="nav-item">
                    <span class="nav-item__icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="properties.html" class="nav-item nav-item--active">
                    <span class="nav-item__icon">üè¢</span>
                    <span>Properties</span>
                </a>
                <a href="add-property.html" class="nav-item" style="background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--primary);">
                    <span class="nav-item__icon">‚ûï</span>
                    <span>Add Property</span>
                </a>
                <a href="selections.html" class="nav-item">
                    <span class="nav-item__icon">üìã</span>
                    <span>Selections</span>
                </a>
                <a href="complex-manager.html" class="nav-item">
                    <span class="nav-item__icon">üèóÔ∏è</span>
                    <span>–ö–æ–º–ø–ª–µ–∫—Å—ã</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-item__icon">üë•</span>
                    <span>Clients</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-item__icon">üìà</span>
                    <span>Analytics</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-item__icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
                <a href="#" class="nav-item" onclick="logout(); return false;">
                    <span class="nav-item__icon">üö™</span>
                    <span>Logout</span>
                </a>
                <a href="../index.html" class="nav-item nav-item--home">
                    <span class="nav-item__icon">üåê</span>
                    <span>Home Page</span>
                </a>
            </nav>

            <div class="sidebar__footer">
                <div class="user-info">
                    <div class="user-avatar">MK</div>
                    <div class="user-details">
                        <div class="user-name">Maria Konstantinou</div>
                        <div class="user-role">Senior Broker</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="topbar">
                <button class="mobile-menu-btn" id="menuBtn" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <h1 class="topbar__title">Properties</h1>
                <div class="topbar__actions">
                    <button class="btn btn-primary" onclick="window.location.href='add-property.html'" title="Add New Property">
                        ‚ûï Add Property
                    </button>
                    <div class="sync-status" id="syncStatus">
                        <span class="sync-status__dot"></span>
                        <span id="syncText">Synced</span>
                    </div>
                    <button class="btn btn-secondary" onclick="openBrokerSettingsModal()" title="Broker Settings">
                        ‚öôÔ∏è Settings
                    </button>
                    <button class="btn btn-secondary" id="syncBtn" onclick="syncData()">
                        üìÅ Load from CSV
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <!-- Stats -->
                <div class="stats-bar" id="statsBar">
                    <div class="stats-bar__item">
                        <span class="stats-bar__value" id="totalCount">0</span>
                        <span class="stats-bar__label">Total</span>
                    </div>
                    <div class="stats-bar__item">
                        <span class="stats-bar__value" id="avgPrice">‚Ç¨0</span>
                        <span class="stats-bar__label">Avg Price</span>
                    </div>
                    <div class="stats-bar__item">
                        <span class="stats-bar__value" id="lastSync">Never</span>
                        <span class="stats-bar__label">Last Sync</span>
                    </div>
                </div>

                <!-- Filters Panel -->
                <div class="filters-panel">
                    <div class="filters-panel__header">
                        <span class="filters-panel__title">
                            Filters <span class="active-filters-badge" id="activeFiltersCount" style="display:none">0</span>
                        </span>
                        <button class="filters-panel__clear" onclick="clearAllFilters()">Clear all</button>
                    </div>

                    <!-- Main filters row -->
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-group__label">Search</label>
                            <input type="text" class="input" placeholder="Title, location, features..." id="searchInput">
                        </div>
                        <div class="filter-group">
                            <label class="filter-group__label">Sort by</label>
                            <select class="input" id="sortSelect" onchange="handleSortChange()">
                                <option value="date-desc">Newest First</option>
                                <option value="date-asc">Oldest First</option>
                                <option value="price-desc">Price: High to Low</option>
                                <option value="price-asc">Price: Low to High</option>
                                <option value="area-desc">Area: Largest First</option>
                                <option value="area-asc">Area: Smallest First</option>
                                <option value="title-asc">Title: A-Z</option>
                                <option value="title-desc">Title: Z-A</option>
                                <option value="location-asc">Location: A-Z</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-group__label">Location</label>
                            <div class="multi-select" id="locationMultiSelect">
                                <div class="multi-select__trigger" onclick="toggleMultiSelect('location')">
                                    <span class="multi-select__text" id="locationText">All locations</span>
                                    <span class="multi-select__arrow">‚ñº</span>
                                </div>
                                <div class="multi-select__dropdown" id="locationDropdown"></div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label class="filter-group__label">District</label>
                            <div class="multi-select" id="districtMultiSelect">
                                <div class="multi-select__trigger" onclick="toggleMultiSelect('district')">
                                    <span class="multi-select__text" id="districtText">All districts</span>
                                    <span class="multi-select__arrow">‚ñº</span>
                                </div>
                                <div class="multi-select__dropdown" id="districtDropdown"></div>
                            </div>
                        </div>
                        <div class="filter-group" style="display: none;">
                            <label class="filter-group__label">Type</label>
                            <div class="multi-select" id="typeMultiSelect">
                                <div class="multi-select__trigger" onclick="toggleMultiSelect('type')">
                                    <span class="multi-select__text" id="typeText">All types</span>
                                    <span class="multi-select__arrow">‚ñº</span>
                                </div>
                                <div class="multi-select__dropdown" id="typeDropdown"></div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label class="filter-group__label">Status</label>
                            <div class="multi-select" id="statusMultiSelect">
                                <div class="multi-select__trigger" onclick="toggleMultiSelect('status')">
                                    <span class="multi-select__text" id="statusText">All statuses</span>
                                    <span class="multi-select__arrow">‚ñº</span>
                                </div>
                                <div class="multi-select__dropdown" id="statusDropdown"></div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label class="filter-group__label">Main Type</label>
                            <div class="multi-select" id="mainTypeMultiSelect">
                                <div class="multi-select__trigger" onclick="toggleMultiSelect('mainType')">
                                    <span class="multi-select__text" id="mainTypeText">All main types</span>
                                    <span class="multi-select__arrow">‚ñº</span>
                                </div>
                                <!-- –û–ø—Ü–∏–∏ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö CSV —á–µ—Ä–µ–∑ updateFilters() -->
                                <div class="multi-select__dropdown" id="mainTypeDropdown"></div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label class="filter-group__label">Delivery Date</label>
                            <div class="delivery-filter">
                                <select class="input" id="deliveryFilter">
                                    <option value="">All delivery dates</option>
                                    <option value="delivered">Already delivered</option>
                                    <option value="3months">Within 3 months</option>
                                    <option value="6months">Within 6 months</option>
                                    <option value="12months">Within 12 months</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027+">2027 or later</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-group" style="grid-column: span 1;">
                            <label class="filter-group__label">Price (‚Ç¨)</label>
                            
                            <!-- Quick Presets -->
                            <div class="price-presets" style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;">
                                <button class="price-preset-btn" onclick="togglePriceRange(0, 200000); event.preventDefault();">
                                    <200K
                                </button>
                                <button class="price-preset-btn" onclick="togglePriceRange(200000, 300000); event.preventDefault();">
                                    200-300K
                                </button>
                                <button class="price-preset-btn" onclick="togglePriceRange(300000, 400000); event.preventDefault();" 
                                        style="background: var(--primary, #6366f1); border-color: var(--primary, #6366f1); color: white; font-weight: 600; font-size: 0.9rem; padding: 8px 16px;">
                                    300-400K
                                </button>
                                <button class="price-preset-btn" onclick="togglePriceRange(400000, 500000); event.preventDefault();">
                                    400-500K
                                </button>
                                <button class="price-preset-btn" onclick="togglePriceRange(500000, 1000000); event.preventDefault();">
                                    500K-1M
                                </button>
                                <button class="price-preset-btn" onclick="togglePriceRange(1000000, 2000000); event.preventDefault();">
                                    1-2M
                                </button>
                                <button class="price-preset-btn" onclick="togglePriceRange(2000000, 50000000); event.preventDefault();">
                                    >2M
                                </button>
                                <button class="price-preset-btn" onclick="togglePriceUponRequest(); event.preventDefault();" style="background: var(--warning, #f59e0b); border-color: var(--warning, #f59e0b); color: white;">
                                    üí∞ Price upon request
                                </button>
                            </div>
                            
                            <!-- Circular Price Knob -->
                            <div class="circular-price-knob-container" style="margin-top: 20px;">
                                <div class="circular-price-knob" id="priceKnob">
                                    <svg width="220" height="220" viewBox="0 0 220 220">
                                        <!-- Background circle -->
                                        <circle cx="110" cy="110" r="80" fill="none" stroke="#e5e7eb" stroke-width="20"/>
                                        
                                        <!-- Main sector (0 - 1M): 0¬∞ to 345¬∞ -->
                                        <circle cx="110" cy="110" r="80" fill="none" 
                                                stroke="url(#mainGradient)" 
                                                stroke-width="20"
                                                stroke-dasharray="471 31.4"
                                                stroke-dashoffset="125.7"
                                                stroke-linecap="round"
                                                transform="rotate(-90 110 110)"/>
                                        
                                        <!-- Premium sector (1M+): 345¬∞ to 360¬∞ (15¬∞) -->
                                        <circle cx="110" cy="110" r="80" fill="none" 
                                                stroke="url(#premiumGradient)" 
                                                stroke-width="20"
                                                stroke-dasharray="20.9 481.5"
                                                stroke-dashoffset="-345.6"
                                                stroke-linecap="round"
                                                transform="rotate(-90 110 110)"/>
                                        
                                        <!-- Active arc -->
                                        <circle cx="110" cy="110" r="80" fill="none" 
                                                id="priceKnobArc"
                                                stroke="#6366f1" 
                                                stroke-width="22"
                                                stroke-dasharray="0 502.4"
                                                stroke-dashoffset="125.7"
                                                stroke-linecap="round"
                                                transform="rotate(-90 110 110)"/>
                                        
                                        <!-- Handle -->
                                        <g id="priceKnobHandle">
                                            <circle cx="110" cy="30" r="14" fill="white" stroke="#6366f1" stroke-width="3"/>
                                            <circle cx="110" cy="30" r="8" fill="#6366f1"/>
                                        </g>
                                        
                                        <!-- Gradients -->
                                        <defs>
                                            <linearGradient id="mainGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                                <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.3" />
                                                <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0.8" />
                                            </linearGradient>
                                            <linearGradient id="premiumGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                                <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                                                <stop offset="100%" style="stop-color:#fbbf24;stop-opacity:1" />
                                            </linearGradient>
                                        </defs>
                                    </svg>
                                    
                                    <!-- Center display -->
                                    <div class="knob-center-display">
                                        <div class="knob-value" id="priceKnobValue">‚Ç¨0</div>
                                        <div class="knob-label">Max Price</div>
                                    </div>
                                </div>
                                
                                <!-- Price range inputs below knob -->
                                <div class="price-range-inputs" style="margin-top: 15px;">
                                    <input type="number" class="input" placeholder="Min" id="priceMin" 
                                           onchange="updatePriceFromInputs()" style="font-size: 0.875rem;">
                                    <span style="color: var(--gray-400);">-</span>
                                    <input type="number" class="input" placeholder="Max" id="priceMax" 
                                           onchange="updatePriceFromInputs()" style="font-size: 0.875rem;">
                                </div>
                            </div>
                            
                            <style>
                            .circular-price-knob-container {
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                padding: 10px;
                            }
                            
                            .circular-price-knob {
                                position: relative;
                                width: 220px;
                                height: 220px;
                                cursor: pointer;
                                user-select: none;
                            }
                            
                            .knob-center-display {
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                text-align: center;
                                pointer-events: none;
                            }
                            
                            .knob-value {
                                font-size: 1.5rem;
                                font-weight: 700;
                                color: #1f2937;
                                margin-bottom: 4px;
                            }
                            
                            .knob-label {
                                font-size: 0.75rem;
                                color: #6b7280;
                                text-transform: uppercase;
                                letter-spacing: 0.05em;
                            }
                            
                            #priceKnobHandle {
                                cursor: grab;
                                transition: transform 0.05s ease-out;
                            }
                            
                            #priceKnobHandle:active {
                                cursor: grabbing;
                            }
                            
                            .circular-price-knob:hover #priceKnobHandle circle:first-child {
                                stroke-width: 4;
                                r: 16;
                            }
                            </style>
                            
                            <script>
                            // Circular Price Knob Logic
                            (function() {
                                const knob = document.getElementById('priceKnob');
                                const handle = document.getElementById('priceKnobHandle');
                                const arc = document.getElementById('priceKnobArc');
                                const valueDisplay = document.getElementById('priceKnobValue');
                                const priceMaxInput = document.getElementById('priceMax');
                                
                                let isDragging = false;
                                let currentAngle = 0; // 0 to 360 degrees
                                
                                // Price mapping
                                // Main sector: 0¬∞ - 345¬∞ maps to 0 - 1,000,000‚Ç¨
                                // Premium sector: 345¬∞ - 360¬∞ maps to 1,000,000‚Ç¨ - ‚àû (shows all premium)
                                
                                function angleToPrice(angle) {
                                    if (angle <= 345) {
                                        // Linear mapping: 0-345¬∞ ‚Üí 0-1M‚Ç¨
                                        return Math.round((angle / 345) * 1000000);
                                    } else {
                                        // Premium sector: 345-360¬∞ ‚Üí 1M-50M‚Ç¨
                                        return 50000000; // Show all premium
                                    }
                                }
                                
                                function priceToAngle(price) {
                                    if (price <= 1000000) {
                                        return (price / 1000000) * 345;
                                    } else {
                                        return 352.5; // Middle of premium sector
                                    }
                                }
                                
                                function formatPrice(price) {
                                    if (price >= 50000000) return '‚Ç¨1M+';
                                    if (price >= 1000000) return '‚Ç¨' + (price / 1000000).toFixed(1) + 'M';
                                    if (price >= 1000) return '‚Ç¨' + (price / 1000).toFixed(0) + 'K';
                                    return '‚Ç¨' + price;
                                }
                                
                                function updateKnob(angle) {
                                    currentAngle = Math.max(0, Math.min(360, angle));
                                    
                                    // Update handle position
                                    const handleAngle = currentAngle - 90; // SVG rotation offset
                                    handle.setAttribute('transform', `rotate(${handleAngle} 110 110)`);
                                    
                                    // Update arc
                                    const arcLength = (currentAngle / 360) * 502.4;
                                    arc.setAttribute('stroke-dasharray', `${arcLength} ${502.4 - arcLength}`);
                                    
                                    // Update price
                                    const price = angleToPrice(currentAngle);
                                    valueDisplay.textContent = formatPrice(price);
                                    priceMaxInput.value = price >= 50000000 ? '' : price;
                                    
                                    // Change color in premium sector
                                    if (currentAngle > 345) {
                                        arc.setAttribute('stroke', '#f59e0b');
                                        valueDisplay.style.color = '#f59e0b';
                                    } else {
                                        arc.setAttribute('stroke', '#6366f1');
                                        valueDisplay.style.color = '#1f2937';
                                    }
                                    
                                    // Trigger filter update
                                    if (!isDragging || Date.now() % 100 < 10) { // Throttle updates while dragging
                                        renderProperties();
                                    }
                                }
                                
                                function getAngleFromEvent(e) {
                                    const rect = knob.getBoundingClientRect();
                                    const centerX = rect.left + rect.width / 2;
                                    const centerY = rect.top + rect.height / 2;
                                    
                                    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                                    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                                    
                                    const deltaX = clientX - centerX;
                                    const deltaY = clientY - centerY;
                                    
                                    let angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI) + 90;
                                    if (angle < 0) angle += 360;
                                    
                                    return angle;
                                }
                                
                                function startDrag(e) {
                                    isDragging = true;
                                    updateKnob(getAngleFromEvent(e));
                                    e.preventDefault();
                                }
                                
                                function drag(e) {
                                    if (isDragging) {
                                        updateKnob(getAngleFromEvent(e));
                                        e.preventDefault();
                                    }
                                }
                                
                                function stopDrag() {
                                    if (isDragging) {
                                        isDragging = false;
                                        renderProperties(); // Final update
                                    }
                                }
                                
                                // Event listeners
                                knob.addEventListener('mousedown', startDrag);
                                knob.addEventListener('touchstart', startDrag);
                                document.addEventListener('mousemove', drag);
                                document.addEventListener('touchmove', drag);
                                document.addEventListener('mouseup', stopDrag);
                                document.addEventListener('touchend', stopDrag);
                                
                                // Update from manual input
                                window.updatePriceFromInputs = function() {
                                    const maxPrice = parseInt(priceMaxInput.value) || 50000000;
                                    const angle = priceToAngle(maxPrice);
                                    updateKnob(angle);
                                };
                                
                                // Initialize
                                updateKnob(360); // Start at max (show all)
                            })();
                            </script>
                        </div>
                    </div>

                    <!-- Bedrooms chips -->
                    <div style="margin-top: var(--space-md);">
                        <label class="filter-group__label">Bedrooms</label>
                        <div class="bedroom-chips" style="margin-top: 4px;">
                            <button class="bedroom-chip active" data-beds="">Any</button>
                            <button class="bedroom-chip" data-beds="0">Studio</button>
                            <button class="bedroom-chip" data-beds="1">1</button>
                            <button class="bedroom-chip" data-beds="2">2</button>
                            <button class="bedroom-chip" data-beds="3">3</button>
                            <button class="bedroom-chip" data-beds="4">4+</button>
                        </div>
                    </div>

                    <!-- Advanced filters toggle -->
                    <button class="filters-toggle" onclick="toggleAdvancedFilters()">
                        <span id="advancedToggleText">More filters</span>
                        <span id="advancedToggleIcon">‚ñº</span>
                    </button>

                    <!-- Advanced filters -->
                    <div class="filters-advanced" id="advancedFilters">
                        <div class="filter-group">
                            <label class="filter-group__label">Area (m¬≤)</label>
                            <div class="range-group">
                                <input type="number" class="input" placeholder="Min" id="areaMin">
                                <span class="range-group__sep">-</span>
                                <input type="number" class="input" placeholder="Max" id="areaMax">
                            </div>
                            <!-- Range Slider -->
                            <div class="range-slider-container">
                                <div class="range-values">
                                    <span id="areaRangeDisplay">0 - 30,000</span>
                                </div>
                                <div class="range-slider" id="areaSlider" data-min="0" data-max="30000">
                                    <div class="range-slider__track"></div>
                                    <div class="range-slider__thumb" data-thumb="min"></div>
                                    <div class="range-slider__thumb" data-thumb="max"></div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label class="filter-group__label">Price/m¬≤ (‚Ç¨)</label>
                            <div class="range-group">
                                <input type="number" class="input" placeholder="Min" id="priceSqmMin">
                                <span class="range-group__sep">-</span>
                                <input type="number" class="input" placeholder="Max" id="priceSqmMax">
                            </div>
                            <!-- Range Slider -->
                            <div class="range-slider-container">
                                <div class="range-values">
                                    <span id="priceSqmRangeDisplay">0 - 30,000</span>
                                </div>
                                <div class="range-slider" id="priceSqmSlider" data-min="0" data-max="30000">
                                    <div class="range-slider__track"></div>
                                    <div class="range-slider__thumb" data-thumb="min"></div>
                                    <div class="range-slider__thumb" data-thumb="max"></div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-group checkbox-filters">
                            <label class="filter-group__label" style="width: 100%;">Extras</label>
                            <label class="checkbox-filter">
                                <input type="checkbox" id="hasVeranda"> Veranda
                            </label>
                            <label class="checkbox-filter">
                                <input type="checkbox" id="hasBasement"> Basement
                            </label>
                            <label class="checkbox-filter">
                                <input type="checkbox" id="hasPool"> Pool
                            </label>
                            <label class="checkbox-filter">
                                <input type="checkbox" id="hasParking"> Parking
                            </label>
                            <label class="checkbox-filter">
                                <input type="checkbox" id="hasSeaView"> Sea View
                            </label>
                        </div>
                        <div class="filter-group">
                            <label class="filter-group__label">Object Code</label>
                            <div class="multi-select" id="objectMultiSelect">
                                <div class="multi-select__trigger" onclick="toggleMultiSelect('object')">
                                    <span class="multi-select__text" id="objectText">All object codes</span>
                                    <span class="multi-select__arrow">‚ñº</span>
                                </div>
                                <div class="multi-select__dropdown" id="objectDropdown"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Properties Grid -->
                <div class="property-grid" id="propertiesGrid">
                    <div class="empty-state">
                        <div class="empty-state__icon">üì¶</div>
                        <p>Loading properties...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Selection Bar -->
    <div class="selection-bar" id="selectionBar">
        <div class="selection-bar__info">
            <span id="selectedCount">0</span> properties selected
        </div>
        <div class="selection-bar__actions">
            <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
            <button class="btn btn-primary" onclick="createSelectionFromSelected()">
                Create Selection
            </button>
        </div>
    </div>

    <!-- Property Detail Modal -->
    <div class="modal-overlay" id="propertyModal">
        <div class="modal property-detail">
            <div class="modal__header">
                <h3 class="modal__title">Property Details</h3>
                <button class="modal__close" onclick="closePropertyModal()">‚úï</button>
            </div>
            <div class="modal__body" id="propertyModalContent">
                <!-- Content will be inserted by JS -->
            </div>
            <div class="modal__footer">
                <button class="btn btn-secondary" onclick="closePropertyModal()">Close</button>
                <button class="btn btn-primary" id="propertyModalSelect" onclick="selectFromModal()">
                    Select Property
                </button>
            </div>
        </div>
    </div>

    <!-- Client Selection Modal -->
    <div class="modal-overlay" id="clientModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal__header">
                <h3 class="modal__title">Create Selection</h3>
                <button class="modal__close" onclick="closeClientModal()">‚úï</button>
            </div>
            <div class="modal__body">
                <p style="color: var(--gray-600); margin-bottom: var(--space-lg);">
                    <strong id="selectedPropsCount">0</strong> properties selected
                </p>

                <!-- Selection Name -->
                <div class="form-group" style="margin-bottom: var(--space-lg);">
                    <label class="form-label">Selection Name *</label>
                    <input type="text" class="input" id="selectionName"
                           placeholder="e.g., Apartments for John" required>
                </div>

                <!-- Client Selection -->
                <div class="form-group" style="margin-bottom: var(--space-lg);">
                    <label class="form-label">Client</label>
                    <div class="client-tabs" style="display: flex; gap: var(--space-sm); margin-bottom: var(--space-md);">
                        <button type="button" class="client-tab active" data-tab="existing" onclick="switchClientTab('existing')">
                            Existing Client
                        </button>
                        <button type="button" class="client-tab" data-tab="new" onclick="switchClientTab('new')">
                            New Client
                        </button>
                        <button type="button" class="client-tab" data-tab="none" onclick="switchClientTab('none')">
                            No Client
                        </button>
                    </div>

                    <!-- Existing Client -->
                    <div id="existingClientPanel" class="client-panel">
                        <select class="input" id="existingClientSelect">
                            <option value="">Select client...</option>
                        </select>
                    </div>

                    <!-- New Client -->
                    <div id="newClientPanel" class="client-panel" style="display: none;">
                        <div style="display: flex; flex-direction: column; gap: var(--space-md);">
                            <input type="text" class="input" id="newClientName" placeholder="Client name *">
                            <input type="email" class="input" id="newClientEmail" placeholder="Email (optional)">
                            <input type="tel" class="input" id="newClientPhone" placeholder="Phone (optional)">
                        </div>
                    </div>

                    <!-- No Client -->
                    <div id="noClientPanel" class="client-panel" style="display: none;">
                        <p style="color: var(--gray-500); font-size: 0.875rem;">
                            Selection will be created without a specific client
                        </p>
                    </div>
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label class="form-label">Description (optional)</label>
                    <textarea class="input" id="selectionDescription" rows="2"
                              placeholder="Notes about this selection..."></textarea>
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn-secondary" onclick="closeClientModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmCreateSelection()" id="createSelectionBtn">
                    Create Selection
                </button>
            </div>
        </div>
    </div>

    <!-- Link Modal -->
    <div class="modal-overlay" id="linkModal">
        <div class="modal">
            <div class="modal__header">
                <h3 class="modal__title">Selection Created!</h3>
                <button class="modal__close" onclick="closeLinkModal()">‚úï</button>
            </div>
            <div class="modal__body" style="text-align: center;">
                <div style="font-size: 4rem; margin-bottom: var(--space-lg);">üéâ</div>
                <p style="margin-bottom: var(--space-lg);">Share this link with your client:</p>
                <div style="display: flex; gap: var(--space-sm); margin-bottom: var(--space-lg);">
                    <input type="text" class="input" id="selectionLink" readonly
                           style="text-align: center; font-family: monospace;">
                    <button class="btn btn-primary" onclick="copyLink()">Copy</button>
                </div>
                <p class="text-muted text-small">Link expires in 7 days</p>

                <!-- PDF Export -->
                <div style="margin-top: var(--space-xl); padding-top: var(--space-lg); border-top: 1px solid var(--gray-200);">
                    <p style="margin-bottom: var(--space-md); color: var(--gray-600); font-size: 0.875rem;">
                        Export selection as PDF:
                    </p>
                    <div style="display: flex; justify-content: center; gap: var(--space-sm);">
                        <button class="btn btn-secondary" onclick="exportSelectionPDF('en')" title="English">
                            üá¨üáß EN
                        </button>
                        <button class="btn btn-secondary" onclick="exportSelectionPDF('ru')" title="Russian">
                            üá∑üá∫ RU
                        </button>
                        <button class="btn btn-secondary" onclick="exportSelectionPDF('el')" title="Greek">
                            üá¨üá∑ EL
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal__footer" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="closeLinkModal()">Done</button>
                <button class="btn btn-primary" onclick="previewSelectionFromLink()">Preview</button>
            </div>
        </div>
    </div>

    <!-- Broker Settings Modal -->
    <div class="modal-overlay" id="brokerSettingsModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal__header">
                <h3 class="modal__title">‚öôÔ∏è –ú–æ–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã</h3>
                <button class="modal__close" onclick="closeBrokerSettingsModal()">‚úï</button>
            </div>
            <div class="modal__body">
                <p style="color: var(--gray-500); font-size: 0.875rem; margin-bottom: var(--space-lg);">
                    –≠—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞–º –¥–ª—è —Å–≤—è–∑–∏ —Å –≤–∞–º–∏
                </p>
                
                <div class="form-group">
                    <label class="form-group__label">üë§ –í–∞—à–µ –∏–º—è</label>
                    <input type="text" class="input" id="brokerNameInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Ä–∏—è –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω—É">
                </div>
                
                <div class="form-group" style="margin-top: var(--space-md);">
                    <label class="form-group__label">üìû –¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" class="input" id="brokerPhoneInput" placeholder="+357 99 123456">
                    <small style="color: var(--gray-500); font-size: 0.75rem; margin-top: 4px; display: block;">
                        –î–ª—è –∑–≤–æ–Ω–∫–æ–≤ –∏ WhatsApp/Viber (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã –æ—Ç–¥–µ–ª—å–Ω–æ)
                    </small>
                </div>
                
                <div class="form-group" style="margin-top: var(--space-md);">
                    <label class="form-group__label">üìß Email</label>
                    <input type="email" class="input" id="brokerEmailInput" placeholder="your@email.com">
                </div>
                
                <div style="margin-top: var(--space-lg); padding-top: var(--space-md); border-top: 1px solid var(--gray-200);">
                    <p style="font-weight: 500; margin-bottom: var(--space-md);">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</p>
                    
                    <div class="form-group">
                        <label class="form-group__label" style="color: #25D366;">üí¨ WhatsApp</label>
                        <input type="tel" class="input" id="brokerWhatsAppInput" placeholder="–ù–æ–º–µ—Ä –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º (–≤–æ–∑—å–º—ë—Ç—Å—è –∏–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞)">
                    </div>
                    
                    <div class="form-group" style="margin-top: var(--space-md);">
                        <label class="form-group__label" style="color: #229ED9;">‚úàÔ∏è Telegram</label>
                        <input type="text" class="input" id="brokerTelegramInput" placeholder="@username –∏–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
                    </div>
                    
                    <div class="form-group" style="margin-top: var(--space-md);">
                        <label class="form-group__label" style="color: #7360F2;">üì± Viber</label>
                        <input type="tel" class="input" id="brokerViberInput" placeholder="–ù–æ–º–µ—Ä –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º (–≤–æ–∑—å–º—ë—Ç—Å—è –∏–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞)">
                    </div>
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn-secondary" onclick="closeBrokerSettingsModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveBrokerSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.js"></script>
    <script src="../assets/js/data-sync.js"></script>
    <script src="../assets/js/mock-data.js"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script src="../assets/js/pdf-export.js"></script>
    <script>
        // Initialize global Supabase client
        const supabaseUrl = 'https://ymizsgrtfkezzsichfwy.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltaXpzZ3J0ZmtlenpzaWNoZnd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3MzQ5NjIsImV4cCI6MjA4MTMxMDk2Mn0.2XJd1cc_IODicg7ElBGmcVp9Z5RrNccEWm2flV_nrqs';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        window.supabaseClient = supabaseClient;
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('../sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW failed:', err));
        }

        // Check authentication
        async function checkAuth() {
            // Check localStorage session (demo accounts)
            const session = localStorage.getItem('broker_session');
            
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            try {
                JSON.parse(session); // Validate session data
            } catch (e) {
                console.error('Invalid session data:', e);
                localStorage.removeItem('broker_session');
                window.location.href = 'login.html';
                return;
            }

            // Initialize Supabase for data operations (not auth)
            SupabaseClient.init();
        }

        // Logout function
        async function logout() {
            // Sign out from Supabase first
            try {
                await supabaseClient.auth.signOut();
                console.log('‚úÖ Signed out from Supabase');
            } catch (e) {
                console.log('‚ö†Ô∏è Supabase signout error:', e);
            }
            
            // Clear localStorage session
            localStorage.removeItem('broker_session');
            
            // Redirect to login
            window.location.href = 'login.html';
        }

        checkAuth();
    </script>
    <script>
        let selectedProperties = new Set();
        let allProperties = [];
        let displayedCount = 0;
        const ITEMS_PER_PAGE = 50;

        /**
         * ‚úÖ FIX: Normalize property ID for consistent comparison
         * Ensures all IDs are compared as strings, preventing type mismatch issues
         * @param {string|number} id - Property ID
         * @returns {string} - Normalized ID as trimmed string
         */
        function normalizeId(id) {
            if (id === null || id === undefined) return '';
            return String(id).trim();
        }

        // Initialize
        async function init() {
            // Auto-load from CSV if not already loaded
            if (!DataSync.isLoaded()) {
                await DataSync.autoSync();
            }

            // Load properties from memory cache
            allProperties = DataSync.getProperties();

            if (allProperties.length === 0) {
                // Show message to load data
                document.getElementById('propertiesGrid').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state__icon">üìÅ</div>
                        <div class="empty-state__title">No properties loaded</div>
                        <p>Click "Load from CSV" to load property data</p>
                    </div>
                `;
            } else {
                renderProperties();
            }

            updateStats();
            updateFilters();
            updateSyncStatus();
        }

        // Sync data from Google Sheets
        async function syncData() {
            const btn = document.getElementById('syncBtn');
            const statusDot = document.querySelector('.sync-status__dot');
            const syncText = document.getElementById('syncText');

            btn.disabled = true;
            btn.textContent = 'üìÅ Loading...';
            statusDot.classList.add('sync-status__dot--syncing');
            syncText.textContent = 'Loading...';

            try {
                const result = await DataSync.syncProperties();

                if (result.success) {
                    allProperties = result.properties;
                    renderProperties();
                    updateStats();
                    updateFilters();
                    alert(`‚úÖ Successfully synced ${result.count} properties!`);
                } else {
                    alert('‚ùå Sync failed: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Sync failed: ' + error.message);
            }

            btn.disabled = false;
            btn.textContent = 'üìÅ Load from CSV';
            statusDot.classList.remove('sync-status__dot--syncing');
            updateSyncStatus();
        }

        // Update sync status display
        function updateSyncStatus() {
            const syncText = document.getElementById('syncText');
            const lastSync = document.getElementById('lastSync');
            const lastSyncTime = DataSync.getLastSyncTime();

            if (lastSyncTime) {
                const date = new Date(lastSyncTime);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);

                if (diffMins < 1) {
                    syncText.textContent = 'Just synced';
                    lastSync.textContent = 'Just now';
                } else if (diffMins < 60) {
                    syncText.textContent = `${diffMins}m ago`;
                    lastSync.textContent = `${diffMins}m ago`;
                } else {
                    const diffHours = Math.floor(diffMins / 60);
                    syncText.textContent = `${diffHours}h ago`;
                    lastSync.textContent = `${diffHours}h ago`;
                }
            } else {
                syncText.textContent = 'Not synced';
                lastSync.textContent = 'Never';
            }
        }

        // Render properties grid with pagination
        function renderProperties(append = false) {
            const grid = document.getElementById('propertiesGrid');
            let allFiltered = getFilteredProperties();
            
            // Apply sorting
            allFiltered = sortProperties(allFiltered);

            if (allFiltered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-state__icon">üîç</div>
                        <p>No properties found. Try adjusting filters or sync data.</p>
                    </div>
                `;
                displayedCount = 0;
                return;
            }

            // Reset count if not appending
            if (!append) {
                displayedCount = 0;
            }

            // Get next batch
            const start = displayedCount;
            const end = Math.min(start + ITEMS_PER_PAGE, allFiltered.length);
            const properties = allFiltered.slice(start, end);
            displayedCount = end;

            const html = properties.map(p => {
                const bedroomText = p.bedrooms === 0 ? 'Studio' : `${p.bedrooms} bed`;
                const photos = p.photos && p.photos.length > 0 ? p.photos : ['https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800'];
                
                // Format price from source
                const priceHTML = p.price || (p.cleanPrice > 0 ? `‚Ç¨${p.cleanPrice.toLocaleString()}` : 'Price on request');
                
                const unitLabel = p.apartmentNo ? `#${p.apartmentNo}` : '';
                const hasMultiplePhotos = photos.length > 1;
                const photosJson = JSON.stringify(photos).replace(/"/g, '&quot;');

                // Format delivery info badge
                let deliveryBadge = '';
                if (p.deliveryInfo) {
                    const status = p.deliveryInfo.status;
                    let badgeColor = 'var(--gray-500)';
                    if (status === 'delivered') badgeColor = 'var(--success)';
                    else if (status === 'scheduled') badgeColor = 'var(--primary)';
                    
                    deliveryBadge = `<span class="property-card-broker__delivery-badge" style="background: ${badgeColor}20; color: ${badgeColor}; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                        ${p.deliveryInfo.text}
                    </span>`;
                }

                return `
                    <div class="property-card-broker ${selectedProperties.has(normalizeId(p.id)) ? 'selected' : ''}"
                         data-id="${p.id}" data-photos="${photosJson}" data-photo-index="0">
                        <div class="property-card-broker__checkbox" onclick="toggleProperty('${p.id}')">
                            ${selectedProperties.has(normalizeId(p.id)) ? '‚úì' : ''}
                        </div>
                        <div class="property-card-broker__actions">
                            <button class="property-card-broker__btn" onclick="openPropertyModal('${p.id}')" title="View details">
                                üëÅÔ∏è
                            </button>
                        </div>
                        <div class="property-card-broker__image-wrapper" onclick="toggleProperty('${p.id}')">
                            <img src="${photos[0]}" alt="${p.title}" class="property-card-broker__image"
                                 onerror="this.src='https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800'">
                            ${hasMultiplePhotos ? `
                                <span class="property-card-broker__photo-count">1/${photos.length}</span>
                                <div class="property-card-broker__gallery-dots">
                                    ${photos.slice(0, 5).map((_, i) => `<span class="property-card-broker__gallery-dot ${i === 0 ? 'active' : ''}"></span>`).join('')}
                                </div>
                                <span class="property-card-broker__swipe-hint">Swipe for more</span>
                            ` : ''}
                        </div>
                        <div class="property-card-broker__body" onclick="toggleProperty('${p.id}')">
                            <div class="property-card-broker__price">${priceHTML} ${unitLabel}</div>
                            ${p.projectTitle ? `<div class="property-card-broker__object" style="font-size: 0.85rem; color: var(--gray-600); margin-top: 4px; font-weight: 500;">${p.projectTitle}</div>` : ''}
                            <div class="property-card-broker__title">${p.id || 'Untitled'}</div>
                            ${p.title ? `<div class="property-card-broker__location" style="font-size: 0.75rem; color: var(--gray-500); margin-top: 4px;">${p.title}</div>` : ''}
                            <div class="property-card-broker__location">üìç ${p.location || 'Unknown'}${deliveryBadge ? ` ${deliveryBadge}` : ''}</div>
                            <div class="property-card-broker__tags">
                                <span class="property-card-broker__tag">üõèÔ∏è ${bedroomText}</span>
                                <span class="property-card-broker__tag">üìê ${p.area || 0} m¬≤</span>
                                ${p.type ? `<span class="property-card-broker__tag">${p.type}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Load more button
            const hasMore = displayedCount < allFiltered.length;
            const loadMoreHtml = hasMore ? `
                <div class="load-more-container" style="grid-column: 1/-1; text-align: center; padding: var(--space-xl);">
                    <button class="btn btn-secondary" onclick="loadMoreProperties()">
                        Load More (${allFiltered.length - displayedCount} remaining)
                    </button>
                </div>
            ` : '';

            if (append) {
                // Remove old load more button and append new content
                const oldLoadMore = grid.querySelector('.load-more-container');
                if (oldLoadMore) oldLoadMore.remove();
                grid.insertAdjacentHTML('beforeend', html + loadMoreHtml);
            } else {
                grid.innerHTML = html + loadMoreHtml;
            }

            // Bind swipe events to new cards
            bindCardSwipeEvents();
        }

        // Load more properties
        function loadMoreProperties() {
            renderProperties(true);
        }

        // Handle sort change
        function handleSortChange() {
            const sortSelect = document.getElementById('sortSelect');
            currentSort = sortSelect.value;
            console.log('üìä Sort changed to:', currentSort);
            renderProperties();
        }

        // Sort properties array
        function sortProperties(properties) {
            if (!properties || properties.length === 0) return properties;
            
            const sorted = [...properties]; // Create copy to avoid mutating original
            
            switch (currentSort) {
                case 'date-desc': // Newest First
                    sorted.sort((a, b) => {
                        const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                        const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                        return dateB - dateA;
                    });
                    break;
                    
                case 'date-asc': // Oldest First
                    sorted.sort((a, b) => {
                        const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                        const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                        return dateA - dateB;
                    });
                    break;
                    
                case 'price-desc': // Price: High to Low
                    sorted.sort((a, b) => {
                        const priceA = a.cleanPrice || 0;
                        const priceB = b.cleanPrice || 0;
                        return priceB - priceA;
                    });
                    break;
                    
                case 'price-asc': // Price: Low to High
                    sorted.sort((a, b) => {
                        const priceA = a.cleanPrice || 0;
                        const priceB = b.cleanPrice || 0;
                        return priceA - priceB;
                    });
                    break;
                    
                case 'area-desc': // Area: Largest First
                    sorted.sort((a, b) => {
                        const areaA = a.totalArea || a.insideArea || 0;
                        const areaB = b.totalArea || b.insideArea || 0;
                        return areaB - areaA;
                    });
                    break;
                    
                case 'area-asc': // Area: Smallest First
                    sorted.sort((a, b) => {
                        const areaA = a.totalArea || a.insideArea || 0;
                        const areaB = b.totalArea || b.insideArea || 0;
                        return areaA - areaB;
                    });
                    break;
                    
                case 'title-asc': // Title: A-Z
                    sorted.sort((a, b) => {
                        const titleA = (a.title || '').toLowerCase();
                        const titleB = (b.title || '').toLowerCase();
                        return titleA.localeCompare(titleB);
                    });
                    break;
                    
                case 'title-desc': // Title: Z-A
                    sorted.sort((a, b) => {
                        const titleA = (a.title || '').toLowerCase();
                        const titleB = (b.title || '').toLowerCase();
                        return titleB.localeCompare(titleA);
                    });
                    break;
                    
                case 'location-asc': // Location: A-Z
                    sorted.sort((a, b) => {
                        const locA = (a.location || '').toLowerCase();
                        const locB = (b.location || '').toLowerCase();
                        return locA.localeCompare(locB);
                    });
                    break;
                    
                default:
                    // No sorting
                    break;
            }
            
            return sorted;
        }

        // Toggle price range preset (reset on second click)
        function togglePriceRange(min, max) {
            console.log(`Toggle price range: ${min} - ${max}`);
            
            // Check if this preset is already active
            const isActive = activePricePreset && 
                           activePricePreset.min === min && 
                           activePricePreset.max === max;
            
            if (isActive) {
                // Second click - clear filter
                console.log('üîÑ Clearing price filter (second click)');
                clearPriceFilter();
            } else {
                // First click - set filter
                setPriceRange(min, max);
                activePricePreset = {min, max};
            }
        }
        
        // Toggle "Price upon request" preset (reset on second click)
        function togglePriceUponRequest() {
            console.log('Toggle Price upon request');
            
            // Check if this preset is already active
            const isActive = activePricePreset === 'upon-request';
            
            if (isActive) {
                // Second click - clear filter
                console.log('üîÑ Clearing "Price upon request" filter (second click)');
                clearPriceFilter();
            } else {
                // First click - set filter
                setPriceUponRequest();
                activePricePreset = 'upon-request';
            }
        }
        
        // Clear price filter
        function clearPriceFilter() {
            activePricePreset = null;
            priceUponRequestMode = false;
            document.getElementById('priceMin').value = '';
            document.getElementById('priceMax').value = '';
            
            // Reset all preset button styles
            const allPresets = document.querySelectorAll('.price-preset-btn');
            allPresets.forEach(btn => {
                // Check if it's the 300-400K highlighted button
                if (btn.textContent.includes('300-400K')) {
                    btn.style.background = 'var(--primary, #6366f1)';
                    btn.style.borderColor = 'var(--primary, #6366f1)';
                    btn.style.color = 'white';
                } else if (btn.textContent.includes('Price upon request')) {
                    btn.style.background = 'var(--warning, #f59e0b)';
                    btn.style.borderColor = 'var(--warning, #f59e0b)';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = 'white';
                    btn.style.borderColor = 'var(--gray-200, #e2e8f0)';
                    btn.style.color = 'var(--gray-700, #374151)';
                }
            });
            
            renderProperties();
        }

        // Set price range from preset buttons (numeric ranges only)
        function setPriceRange(min, max) {
            console.log(`Setting price range: ${min} - ${max}`);
            
            // Disable "Price upon request" mode
            priceUponRequestMode = false;
            
            // Update input fields
            document.getElementById('priceMin').value = min;
            document.getElementById('priceMax').value = max;
            
            // Trigger filter update
            renderProperties();
            
            // Visual feedback
            const allPresets = document.querySelectorAll('.price-preset-btn');
            allPresets.forEach(btn => {
                // Reset to default styles
                if (btn.textContent.includes('300-400K')) {
                    // 300-400K keeps its blue highlight
                    btn.style.background = 'var(--primary, #6366f1)';
                    btn.style.borderColor = 'var(--primary, #6366f1)';
                    btn.style.color = 'white';
                } else if (btn.textContent.includes('Price upon request')) {
                    // Price upon request keeps its orange
                    btn.style.background = 'var(--warning, #f59e0b)';
                    btn.style.borderColor = 'var(--warning, #f59e0b)';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = 'white';
                    btn.style.borderColor = 'var(--gray-200, #e2e8f0)';
                    btn.style.color = 'var(--gray-700, #374151)';
                }
            });
            
            // Add active state to clicked button
            if (event && event.target) {
                event.target.style.background = 'var(--primary, #6366f1)';
                event.target.style.borderColor = 'var(--primary, #6366f1)';
                event.target.style.color = 'white';
                event.target.style.transform = 'scale(1.05)';
                
                setTimeout(() => {
                    event.target.style.transform = 'scale(1)';
                }, 200);
            }
        }

        // Set "Price upon request" filter
        function setPriceUponRequest() {
            console.log('üí∞ Filtering for "Price upon request" properties');
            
            // Enable "Price upon request" mode
            priceUponRequestMode = true;
            
            // Clear price range inputs
            document.getElementById('priceMin').value = '';
            document.getElementById('priceMax').value = '';
            
            // Trigger filter update
            renderProperties();
            
            // Visual feedback
            const allPresets = document.querySelectorAll('.price-preset-btn');
            allPresets.forEach(btn => {
                if (btn.textContent.includes('Price upon request')) {
                    btn.style.background = 'var(--warning, #f59e0b)';
                    btn.style.borderColor = 'var(--warning, #f59e0b)';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = 'white';
                    btn.style.borderColor = 'var(--gray-200, #e2e8f0)';
                    btn.style.color = 'var(--gray-700, #374151)';
                }
            });
        }

        // Current filter states
        let selectedBedrooms = '';
        let selectedLocations = [];
        let selectedDistricts = [];
        let selectedTypes = [];
        let selectedStatuses = [];
        let selectedMainTypes = [];
        let selectedObjects = [];
        let currentSort = 'date-desc';  // Default sort: Newest First
        let priceUponRequestMode = false;  // Filter for "Price upon request" objects
        
        // Track active price preset for toggle functionality
        let activePricePreset = null;  // Stores {min, max} or 'upon-request' or null

        // Get filtered properties
        function getFilteredProperties() {
            const search = document.getElementById('searchInput').value.toLowerCase();

            // ‚úÖ FIX: Price range with validation and auto-correction
            let priceMin = parseInt(document.getElementById('priceMin').value) || 0;
            let priceMax = parseInt(document.getElementById('priceMax').value) || Infinity;
            
            // Auto-correct if min > max
            if (priceMin > priceMax && priceMax !== Infinity) {
                console.warn('‚ö†Ô∏è Price range auto-corrected: min > max');
                [priceMin, priceMax] = [priceMax, priceMin];
                // Update UI
                document.getElementById('priceMin').value = priceMin;
                document.getElementById('priceMax').value = priceMax;
            }

            // ‚úÖ FIX: Advanced filters with validation
            let areaMin = parseInt(document.getElementById('areaMin').value) || 0;
            let areaMax = parseInt(document.getElementById('areaMax').value) || Infinity;
            
            // Auto-correct if min > max
            if (areaMin > areaMax && areaMax !== Infinity) {
                console.warn('‚ö†Ô∏è Area range auto-corrected: min > max');
                [areaMin, areaMax] = [areaMax, areaMin];
                document.getElementById('areaMin').value = areaMin;
                document.getElementById('areaMax').value = areaMax;
            }
            
            let priceSqmMin = parseInt(document.getElementById('priceSqmMin').value) || 0;
            let priceSqmMax = parseInt(document.getElementById('priceSqmMax').value) || Infinity;
            
            // Auto-correct if min > max
            if (priceSqmMin > priceSqmMax && priceSqmMax !== Infinity) {
                console.warn('‚ö†Ô∏è Price/sqm range auto-corrected: min > max');
                [priceSqmMin, priceSqmMax] = [priceSqmMax, priceSqmMin];
                document.getElementById('priceSqmMin').value = priceSqmMin;
                document.getElementById('priceSqmMax').value = priceSqmMax;
            }

            // Checkbox filters
            const hasVeranda = document.getElementById('hasVeranda').checked;
            const hasBasement = document.getElementById('hasBasement').checked;
            const hasPool = document.getElementById('hasPool').checked;
            const hasParking = document.getElementById('hasParking').checked;
            const hasSeaView = document.getElementById('hasSeaView').checked;

            // Delivery date filter
            const deliveryFilter = document.getElementById('deliveryFilter')?.value || '';

            return allProperties.filter(p => {
                // Search
                if (search) {
                    const searchable = `${p.title || ''} ${p.location || ''} ${p.features || ''} ${p.additionalInfo || ''}`.toLowerCase();
                    if (!searchable.includes(search)) return false;
                }

                // Location - multi-select
                if (selectedLocations.length > 0) {
                    const propLocation = (p.location || '').toLowerCase();
                    const matches = selectedLocations.some(loc => propLocation.includes(loc.toLowerCase()));
                    if (!matches) return false;
                }

                // District - multi-select
                if (selectedDistricts.length > 0) {
                    const propDistrict = (p.district || '').toLowerCase();
                    const matches = selectedDistricts.some(d => propDistrict.includes(d.toLowerCase()));
                    if (!matches) return false;
                }

                // Type - multi-select
                if (selectedTypes.length > 0) {
                    const propType = (p.type || '').toLowerCase();
                    const matches = selectedTypes.some(t => propType === t.toLowerCase());
                    if (!matches) return false;
                }

                // Status - multi-select
                if (selectedStatuses.length > 0) {
                    const propStatus = (p.status || '').toLowerCase();
                    const matches = selectedStatuses.some(s => propStatus === s.toLowerCase());
                    if (!matches) return false;
                }

                // Main Type - multi-select (–ø—Ä—è–º–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø–æ–ª–µ–º mainType –∏–∑ CSV)
                // ‚úÖ FIX: Main Type - multi-select with case-insensitive comparison
                if (selectedMainTypes.length > 0) {
                    const propMainType = (p.mainType || '').toLowerCase().trim();
                    const matches = selectedMainTypes.some(t => 
                        t.toLowerCase().trim() === propMainType
                    );
                    if (!matches) return false;
                }

                // Bedrooms
                if (selectedBedrooms !== '') {
                    const beds = parseInt(selectedBedrooms);
                    if (beds === 4) {
                        if ((p.bedrooms || 0) < 4) return false;
                    } else {
                        if ((p.bedrooms || 0) !== beds) return false;
                    }
                }

                // Price range with "Price upon request" handling
                const price = p.cleanPrice || 0;
                
                if (priceUponRequestMode) {
                    // "Price upon request" mode - show ONLY objects without price
                    if (price > 0) return false;
                } else {
                    // Normal price range mode
                    // Exclude "Price upon request" objects from numeric price filters
                    if (priceMin > 0 || priceMax < Infinity) {
                        // Numeric price filter is active - exclude objects without price
                        if (price === 0) return false;
                    }
                    // Apply numeric range filter
                    if (price < priceMin || price > priceMax) return false;
                }

                // Area
                const area = p.area || 0;
                if (area < areaMin || area > areaMax) return false;

                // Price per sqm
                const priceSqm = p.priceSqm || 0;
                if (priceSqm > 0 && (priceSqm < priceSqmMin || priceSqm > priceSqmMax)) return false;

                // Delivery date filter
                if (deliveryFilter) {
                    const now = new Date();
                    const deliveryDate = p.deliveryDate ? new Date(p.deliveryDate) : null;
                    
                    if (deliveryFilter === 'delivered') {
                        if (p.deliveryStatus !== 'delivered') return false;
                    } else if (deliveryFilter === '3months') {
                        if (!deliveryDate) return false;
                        const threeMonthsLater = new Date(now.getTime() + 90 * 24 * 60 * 60 * 1000);
                        if (deliveryDate > threeMonthsLater || p.deliveryStatus === 'delivered') return false;
                    } else if (deliveryFilter === '6months') {
                        if (!deliveryDate) return false;
                        const sixMonthsLater = new Date(now.getTime() + 180 * 24 * 60 * 60 * 1000);
                        if (deliveryDate > sixMonthsLater || p.deliveryStatus === 'delivered') return false;
                    } else if (deliveryFilter === '12months') {
                        if (!deliveryDate) return false;
                        const twelveMonthsLater = new Date(now.getTime() + 365 * 24 * 60 * 60 * 1000);
                        if (deliveryDate > twelveMonthsLater || p.deliveryStatus === 'delivered') return false;
                    } else if (deliveryFilter.match(/^\d{4}$/)) {
                        // Specific year
                        if (!deliveryDate) return false;
                        const year = parseInt(deliveryFilter);
                        if (deliveryDate.getFullYear() !== year) return false;
                    } else if (deliveryFilter === '2027+') {
                        if (!deliveryDate) return false;
                        if (deliveryDate.getFullYear() < 2027) return false;
                    }
                }

                // Veranda
                if (hasVeranda && !((p.coveredVeranda || 0) > 0 || (p.uncoveredVeranda || 0) > 0)) {
                    return false;
                }

                // Basement
                if (hasBasement && !((p.basement || 0) > 0)) {
                    return false;
                }

                // Features-based filters
                const features = (p.features || '').toLowerCase();
                if (hasPool && !features.includes('pool')) return false;
                if (hasParking && !features.includes('parking')) return false;
                if (hasSeaView && !(features.includes('sea view') || features.includes('sea-view') || features.includes('seaview'))) return false;

                // Object Code - multi-select
                if (selectedObjects.length > 0) {
                    const propObject = (p.object || '').trim().toUpperCase();
                    const matches = selectedObjects.some(obj => propObject === obj.toUpperCase());
                    if (!matches) return false;
                }

                return true;
            });
        }

        // Update filter dropdowns with actual data
        function updateFilters() {
            const options = PropertyData.getFilterOptions();

            // Locations - multi-select
            const locationDropdown = document.getElementById('locationDropdown');
            locationDropdown.innerHTML = options.locations.map(loc => `
                <label class="multi-select__option" data-value="${loc}">
                    <input type="checkbox" value="${loc}" onchange="onMultiSelectChange('location')">
                    <span>${loc}</span>
                </label>
            `).join('');

            // Districts - multi-select
            const districtDropdown = document.getElementById('districtDropdown');
            if (districtDropdown && options.districts) {
                districtDropdown.innerHTML = options.districts.map(district => `
                    <label class="multi-select__option" data-value="${district}">
                        <input type="checkbox" value="${district}" onchange="onMultiSelectChange('district')">
                        <span>${district}</span>
                    </label>
                `).join('');
            }

            // Types - multi-select
            const typeDropdown = document.getElementById('typeDropdown');
            typeDropdown.innerHTML = options.types.map(type => `
                <label class="multi-select__option" data-value="${type}">
                    <input type="checkbox" value="${type}" onchange="onMultiSelectChange('type')">
                    <span>${type}</span>
                </label>
            `).join('');

            // Statuses - multi-select
            const statusDropdown = document.getElementById('statusDropdown');
            statusDropdown.innerHTML = options.statuses.map(status => `
                <label class="multi-select__option" data-value="${status}">
                    <input type="checkbox" value="${status}" onchange="onMultiSelectChange('status')">
                    <span>${status}</span>
                </label>
            `).join('');

            // Main Types - multi-select (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö)
            const mainTypeDropdown = document.getElementById('mainTypeDropdown');
            mainTypeDropdown.innerHTML = options.mainTypes.map(mainType => `
                <label class="multi-select__option" data-value="${mainType}">
                    <input type="checkbox" value="${mainType}" onchange="onMultiSelectChange('mainType')">
                    <span>${mainType}</span>
                </label>
            `).join('');

            // Object Codes - multi-select
            const objectDropdown = document.getElementById('objectDropdown');
            objectDropdown.innerHTML = options.objects.map(obj => `
                <label class="multi-select__option" data-value="${obj}">
                    <input type="checkbox" value="${obj}" onchange="onMultiSelectChange('object')">
                    <span>${obj}</span>
                </label>
            `).join('');
        }

        // Multi-select toggle
        function toggleMultiSelect(type) {
            const dropdown = document.getElementById(type + 'Dropdown');
            const trigger = dropdown.previousElementSibling;
            const isOpen = dropdown.classList.contains('open');

            // Close all dropdowns first
            document.querySelectorAll('.multi-select__dropdown').forEach(d => d.classList.remove('open'));
            document.querySelectorAll('.multi-select__trigger').forEach(t => t.classList.remove('active'));

            if (!isOpen) {
                dropdown.classList.add('open');
                trigger.classList.add('active');
            }
        }

        // Multi-select change handler
        function onMultiSelectChange(type) {
            const dropdown = document.getElementById(type + 'Dropdown');
            const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');
            const values = Array.from(checkboxes).map(cb => cb.value);

            // Update state
            if (type === 'location') {
                selectedLocations = values;
                updateMultiSelectText('location', values, 'All locations');
            } else if (type === 'district') {
                selectedDistricts = values;
                updateMultiSelectText('district', values, 'All districts');
            } else if (type === 'type') {
                selectedTypes = values;
                updateMultiSelectText('type', values, 'All types');
            } else if (type === 'status') {
                selectedStatuses = values;
                updateMultiSelectText('status', values, 'All statuses');
            } else if (type === 'mainType') {
                selectedMainTypes = values;
                updateMultiSelectText('mainType', values, 'All main types');
            } else if (type === 'object') {
                selectedObjects = values;
                updateMultiSelectText('object', values, 'All object codes');
            }

            updateActiveFiltersCount();
            renderProperties();
        }

        // Update multi-select display text
        function updateMultiSelectText(type, values, defaultText) {
            const textEl = document.getElementById(type + 'Text');
            if (values.length === 0) {
                textEl.textContent = defaultText;
                textEl.classList.remove('has-value');
            } else if (values.length === 1) {
                textEl.textContent = values[0];
                textEl.classList.add('has-value');
            } else {
                textEl.textContent = `${values.length} selected`;
                textEl.classList.add('has-value');
            }
        }

        // Close dropdowns on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.multi-select')) {
                document.querySelectorAll('.multi-select__dropdown').forEach(d => d.classList.remove('open'));
                document.querySelectorAll('.multi-select__trigger').forEach(t => t.classList.remove('active'));
            }
        });

        // Toggle advanced filters
        function toggleAdvancedFilters() {
            const panel = document.getElementById('advancedFilters');
            const text = document.getElementById('advancedToggleText');
            const icon = document.getElementById('advancedToggleIcon');

            panel.classList.toggle('visible');
            const isVisible = panel.classList.contains('visible');
            text.textContent = isVisible ? 'Less filters' : 'More filters';
            icon.textContent = isVisible ? '‚ñ≤' : '‚ñº';
        }

        // Clear all filters
        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('sortSelect').value = 'date-desc';  // Reset sort
            currentSort = 'date-desc';
            priceUponRequestMode = false;  // Reset "Price upon request" mode
            document.getElementById('priceMin').value = '';
            document.getElementById('priceMax').value = '';
            document.getElementById('areaMin').value = '';
            document.getElementById('areaMax').value = '';
            document.getElementById('priceSqmMin').value = '';
            document.getElementById('priceSqmMax').value = '';
            document.getElementById('hasVeranda').checked = false;
            document.getElementById('hasBasement').checked = false;
            document.getElementById('hasPool').checked = false;
            document.getElementById('hasParking').checked = false;
            document.getElementById('hasSeaView').checked = false;

            // Clear multi-selects
            selectedLocations = [];
            selectedDistricts = [];
            selectedTypes = [];
            selectedStatuses = [];
            selectedMainTypes = [];
            selectedObjects = [];
            document.querySelectorAll('.multi-select__dropdown input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateMultiSelectText('location', [], 'All locations');
            updateMultiSelectText('district', [], 'All districts');
            updateMultiSelectText('type', [], 'All types');
            updateMultiSelectText('status', [], 'All statuses');
            updateMultiSelectText('mainType', [], 'All main types');
            updateMultiSelectText('object', [], 'All object codes');

            // Clear bedroom selection
            selectedBedrooms = '';
            document.querySelectorAll('.bedroom-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.beds === '');
            });
            
            // Reset active price preset tracking
            activePricePreset = null;
            
            // Reset price preset buttons styling
            document.querySelectorAll('.price-preset-btn').forEach(btn => {
                // Preserve special styling for 300-400K and Price upon request
                if (btn.textContent.includes('300-400K')) {
                    btn.style.background = 'var(--primary, #6366f1)';
                    btn.style.borderColor = 'var(--primary, #6366f1)';
                    btn.style.color = 'white';
                } else if (btn.textContent.includes('Price upon request')) {
                    btn.style.background = 'var(--warning, #f59e0b)';
                    btn.style.borderColor = 'var(--warning, #f59e0b)';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = 'white';
                    btn.style.borderColor = 'var(--gray-200, #e2e8f0)';
                    btn.style.color = 'var(--gray-700, #374151)';
                }
            });

            updateActiveFiltersCount();
            renderProperties();
        }

        // Update active filters count
        function updateActiveFiltersCount() {
            let count = 0;

            if (document.getElementById('searchInput').value) count++;
            if (selectedLocations.length > 0) count++;
            if (selectedDistricts.length > 0) count++;
            if (selectedTypes.length > 0) count++;
            if (selectedStatuses.length > 0) count++;
            if (selectedMainTypes.length > 0) count++;
            if (document.getElementById('priceMin').value || document.getElementById('priceMax').value) count++;
            if (selectedBedrooms !== '') count++;
            if (document.getElementById('areaMin').value || document.getElementById('areaMax').value) count++;
            if (document.getElementById('priceSqmMin').value || document.getElementById('priceSqmMax').value) count++;
            if (document.getElementById('hasVeranda').checked) count++;
            if (document.getElementById('hasBasement').checked) count++;
            if (document.getElementById('hasPool').checked) count++;
            if (document.getElementById('hasParking').checked) count++;
            if (document.getElementById('hasSeaView').checked) count++;
            if (selectedObjects.length > 0) count++;

            const badge = document.getElementById('activeFiltersCount');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }

        // Navigate photos on property cards (swipe)
        function navigateCardPhoto(card, direction) {
            const photos = JSON.parse(card.dataset.photos || '[]');
            if (photos.length <= 1) return;

            let index = parseInt(card.dataset.photoIndex) || 0;
            index = (index + direction + photos.length) % photos.length;
            card.dataset.photoIndex = index;

            // Update image
            const img = card.querySelector('.property-card-broker__image');
            img.src = photos[index];

            // Update counter
            const counter = card.querySelector('.property-card-broker__photo-count');
            if (counter) {
                counter.textContent = `${index + 1}/${photos.length}`;
            }

            // Update dots
            const dots = card.querySelectorAll('.property-card-broker__gallery-dot');
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === (index % 5));
            });
        }

        // Bind swipe events to card image wrappers
        function bindCardSwipeEvents() {
            document.querySelectorAll('.property-card-broker__image-wrapper').forEach(wrapper => {
                let startX = 0;
                let startY = 0;
                let isSwiping = false;

                wrapper.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    isSwiping = false;
                }, { passive: true });

                wrapper.addEventListener('touchmove', (e) => {
                    if (!startX) return;
                    const diffX = e.touches[0].clientX - startX;
                    const diffY = e.touches[0].clientY - startY;

                    // If horizontal swipe is dominant
                    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 20) {
                        isSwiping = true;
                        e.preventDefault();
                    }
                }, { passive: false });

                wrapper.addEventListener('touchend', (e) => {
                    if (!startX) return;
                    const endX = e.changedTouches[0].clientX;
                    const diffX = endX - startX;

                    if (isSwiping && Math.abs(diffX) > 50) {
                        e.preventDefault();
                        e.stopPropagation();
                        const card = wrapper.closest('.property-card-broker');
                        if (diffX > 0) {
                            navigateCardPhoto(card, -1);
                        } else {
                            navigateCardPhoto(card, 1);
                        }
                    }

                    startX = 0;
                    startY = 0;
                    isSwiping = false;
                }, { passive: false });

                // Prevent click when swiping
                wrapper.addEventListener('click', (e) => {
                    if (isSwiping) {
                        e.stopPropagation();
                        e.preventDefault();
                    }
                }, { capture: true });
            });
        }

        // Bedroom chip click handler
        function initBedroomChips() {
            document.querySelectorAll('.bedroom-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.bedroom-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    selectedBedrooms = chip.dataset.beds;
                    updateActiveFiltersCount();
                    renderProperties();
                });
            });
        }

        // Update statistics
        function updateStats() {
            const stats = PropertyData.getStats();
            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('avgPrice').textContent = `‚Ç¨${stats.avgPrice.toLocaleString()}`;
        }

        // Toggle property selection
        function toggleProperty(id) {
            // ‚úÖ FIX: Normalize ID to ensure consistent type comparison
            const normalized = normalizeId(id);
            if (selectedProperties.has(normalized)) {
                selectedProperties.delete(normalized);
            } else {
                selectedProperties.add(normalized);
            }
            updateSelectionUI();
        }

        // Update selection UI
        function updateSelectionUI() {
            const count = selectedProperties.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('selectionBar').classList.toggle('visible', count > 0);

            // Update cards
            document.querySelectorAll('.property-card-broker').forEach(card => {
                const id = normalizeId(card.dataset.id);  // ‚úÖ FIX: Normalize ID
                const isSelected = selectedProperties.has(id);
                card.classList.toggle('selected', isSelected);
                card.querySelector('.property-card-broker__checkbox').textContent = isSelected ? '‚úì' : '';
            });
        }

        // Clear selection
        function clearSelection() {
            selectedProperties.clear();
            updateSelectionUI();
        }

        // Open client modal before creating selection
        async function createSelectionFromSelected() {
            if (selectedProperties.size === 0) return;

            // Update selected count in modal
            document.getElementById('selectedPropsCount').textContent = selectedProperties.size;

            // Reset form
            document.getElementById('selectionName').value = `Selection ${new Date().toLocaleDateString()}`;
            document.getElementById('selectionDescription').value = '';
            document.getElementById('newClientName').value = '';
            document.getElementById('newClientEmail').value = '';
            document.getElementById('newClientPhone').value = '';

            // Load existing clients
            await loadExistingClients();

            // Reset to default tab
            switchClientTab('existing');

            // Show modal
            document.getElementById('clientModal').classList.add('modal-overlay--open');
        }

        // Client tab switching
        let currentClientTab = 'existing';

        function switchClientTab(tab) {
            currentClientTab = tab;

            // Update tab buttons
            document.querySelectorAll('.client-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });

            // Show/hide panels
            document.getElementById('existingClientPanel').style.display = tab === 'existing' ? 'block' : 'none';
            document.getElementById('newClientPanel').style.display = tab === 'new' ? 'block' : 'none';
            document.getElementById('noClientPanel').style.display = tab === 'none' ? 'block' : 'none';
        }

        // Load existing clients from Supabase
        async function loadExistingClients() {
            const select = document.getElementById('existingClientSelect');
            select.innerHTML = '<option value="">Loading clients...</option>';

            try {
                const clients = await SupabaseClient.getClients();

                if (clients.length === 0) {
                    select.innerHTML = '<option value="">No clients yet</option>';
                } else {
                    select.innerHTML = '<option value="">Select client...</option>' +
                        clients.map(c => `<option value="${c.id}" data-name="${c.name}">${c.name}${c.email ? ' (' + c.email + ')' : ''}</option>`).join('');
                }
            } catch (error) {
                console.error('Failed to load clients:', error);
                select.innerHTML = '<option value="">Failed to load clients</option>';
            }
        }

        // Close client modal
        function closeClientModal() {
            document.getElementById('clientModal').classList.remove('modal-overlay--open');
        }

        // Confirm and create selection
        async function confirmCreateSelection() {
            const selectionName = document.getElementById('selectionName').value.trim();
            if (!selectionName) {
                alert('Please enter a selection name');
                document.getElementById('selectionName').focus();
                return;
            }

            // Validate based on tab
            let clientId = null;
            let clientName = null;

            if (currentClientTab === 'existing') {
                const select = document.getElementById('existingClientSelect');
                clientId = select.value || null;
                clientName = select.selectedOptions[0]?.dataset?.name || null;
            } else if (currentClientTab === 'new') {
                clientName = document.getElementById('newClientName').value.trim();
                if (!clientName) {
                    alert('Please enter the client name');
                    document.getElementById('newClientName').focus();
                    return;
                }

                // Create new client in Supabase
                const email = document.getElementById('newClientEmail').value.trim();
                const phone = document.getElementById('newClientPhone').value.trim();

                try {
                    const newClient = await SupabaseClient.createClient(clientName, email, phone);
                    clientId = newClient.id;
                } catch (error) {
                    console.error('Failed to create client:', error);
                    // Continue without client ID
                }
            }

            const description = document.getElementById('selectionDescription').value.trim();

            // Disable button
            const btn = document.getElementById('createSelectionBtn');
            btn.disabled = true;
            btn.textContent = 'Creating...';

            try {
                // Get selected property IDs
                const selectedIds = Array.from(selectedProperties);
                
                console.log('üìã Creating selection');
                console.log('   Selected count from Set:', selectedProperties.size);
                console.log('   Selected IDs:', selectedIds);
                console.log('   ID types:', selectedIds.map(id => typeof id));
                
                // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±–µ–¥–∏–º—Å—è –≤ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ —Å—Ç—Ä–æ–∫–µ
                const propertyIdsFormatted = Array.from(new Set(
                    selectedIds
                        .filter(id => id !== null && id !== undefined && id !== '')
                        .map(id => String(id).trim())
                ));
                
                console.log('   Formatted IDs:', propertyIdsFormatted);
                console.log('   Total unique IDs:', propertyIdsFormatted.length);
                
                // ‚úÖ –ü–†–û–í–ï–†–ö–ê 1: –£–±–µ–¥–∏–º—Å—è —á—Ç–æ ID –Ω–µ –ø—É—Å—Ç—ã–µ
                if (propertyIdsFormatted.length === 0) {
                    alert('No valid property IDs selected. Please try again.');
                    btn.disabled = false;
                    btn.textContent = 'Create Selection';
                    return;
                }
                
                // ‚úÖ –ü–†–û–í–ï–†–ö–ê 2: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                if (propertyIdsFormatted.length !== selectedProperties.size) {
                    console.warn('‚ö†Ô∏è Warning: ID count mismatch!');
                    console.warn('   Original selected:', selectedProperties.size);
                    console.warn('   After formatting:', propertyIdsFormatted.length);
                }
                
                // ‚úÖ –ü–†–û–í–ï–†–ö–ê 3: –í—ã–≤–µ—Å—Ç–∏ –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ ID –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                console.log('   Sample formatted IDs:', propertyIdsFormatted.slice(0, 5));

                // Try to get broker phone from Supabase brokers table first
                let brokerPhone = await SupabaseClient.getBrokerPhone();
                
                // Fallback to localStorage if not found in database
                if (!brokerPhone) {
                    brokerPhone = localStorage.getItem('broker_phone') || null;
                    if (brokerPhone) {
                        console.log('üìû Using broker phone from localStorage:', brokerPhone);
                    }
                } else {
                    console.log('üìû Using broker phone from database:', brokerPhone);
                }

                // Gather all broker contacts from localStorage
                const brokerContacts = {
                    name: localStorage.getItem('broker_name') || null,
                    phone: brokerPhone,
                    email: localStorage.getItem('broker_email') || null,
                    whatsapp: localStorage.getItem('broker_whatsapp') || brokerPhone, // fallback to phone
                    telegram: localStorage.getItem('broker_telegram') || null,
                    viber: localStorage.getItem('broker_viber') || brokerPhone // fallback to phone
                };
                
                console.log('üì± Broker contacts:', brokerContacts);

                // Save to Supabase
                const result = await SupabaseClient.createSelection(
                    selectionName,
                    propertyIdsFormatted,  // Use formatted IDs
                    description || `${propertyIdsFormatted.length} properties for ${clientName || 'client'}`,
                    clientId,
                    brokerContacts  // Pass all broker contacts
                );

                // Also save to localStorage for offline access
                const selectedProps = allProperties.filter(p => selectedProperties.has(p.id));
                localStorage.setItem('current_selection', JSON.stringify(selectedProps));
                localStorage.setItem('current_selection_id', result.id);
                
                console.log('‚úÖ Selection created in database');
                console.log('   Selection ID:', result.id);
                console.log('   Property IDs saved:', result.property_ids);
                console.log('   Total properties:', result.total_properties);
                console.log('   Expected count:', propertyIdsFormatted.length);
                console.log('   Link:', result.link);
                
                // ‚úÖ –ü–†–û–í–ï–†–ö–ê: Verify the saved IDs match what we sent
                if (result.property_ids && result.property_ids.length !== propertyIdsFormatted.length) {
                    console.error('‚ùå ERROR: Saved IDs count does not match!');
                    console.error('   Sent:', propertyIdsFormatted.length);
                    console.error('   Saved:', result.property_ids.length);
                }

                // Store for PDF export
                lastCreatedSelection = {
                    id: result.id,
                    name: selectionName,
                    clientName: clientName,
                    properties: selectedProps
                };

                // Close client modal
                closeClientModal();

                // Show link modal
                document.getElementById('selectionLink').value = result.link;
                document.getElementById('linkModal').classList.add('modal-overlay--open');

                console.log('Selection created:', result);
            } catch (error) {
                console.error('Failed to create selection:', error);
                alert('Failed to create selection. Please try again.');
            }

            btn.disabled = false;
            btn.textContent = 'Create Selection';
        }

        // Copy link
        function copyLink() {
            const input = document.getElementById('selectionLink');
            input.select();
            document.execCommand('copy');

            const btn = event.target;
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy', 2000);
        }

        // Close modal
        function closeLinkModal() {
            document.getElementById('linkModal').classList.remove('modal-overlay--open');
            clearSelection();
        }

        // Broker Settings Modal Functions
        function openBrokerSettingsModal() {
            // Load current settings from localStorage
            document.getElementById('brokerNameInput').value = localStorage.getItem('broker_name') || '';
            document.getElementById('brokerPhoneInput').value = localStorage.getItem('broker_phone') || '';
            document.getElementById('brokerEmailInput').value = localStorage.getItem('broker_email') || '';
            document.getElementById('brokerWhatsAppInput').value = localStorage.getItem('broker_whatsapp') || '';
            document.getElementById('brokerTelegramInput').value = localStorage.getItem('broker_telegram') || '';
            document.getElementById('brokerViberInput').value = localStorage.getItem('broker_viber') || '';
            
            document.getElementById('brokerSettingsModal').classList.add('modal-overlay--open');
        }

        function closeBrokerSettingsModal() {
            document.getElementById('brokerSettingsModal').classList.remove('modal-overlay--open');
        }

        function saveBrokerSettings() {
            const brokerName = document.getElementById('brokerNameInput').value.trim();
            const brokerPhone = document.getElementById('brokerPhoneInput').value.trim();
            const brokerEmail = document.getElementById('brokerEmailInput').value.trim();
            const brokerWhatsApp = document.getElementById('brokerWhatsAppInput').value.trim();
            const brokerTelegram = document.getElementById('brokerTelegramInput').value.trim();
            const brokerViber = document.getElementById('brokerViberInput').value.trim();
            
            if (!brokerPhone && !brokerEmail) {
                alert('–£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('broker_name', brokerName);
            localStorage.setItem('broker_phone', brokerPhone);
            localStorage.setItem('broker_email', brokerEmail);
            localStorage.setItem('broker_whatsapp', brokerWhatsApp);
            localStorage.setItem('broker_telegram', brokerTelegram);
            localStorage.setItem('broker_viber', brokerViber);
            
            console.log('‚úÖ Broker settings saved:', { brokerName, brokerPhone, brokerEmail, brokerTelegram });
            
            // Show success message
            alert('Settings saved successfully!');
            
            closeBrokerSettingsModal();
        }

        // Preview selection (broker preview mode - doesn't save reactions)
        function previewSelection() {
            if (selectedProperties.size === 0) {
                alert('Please select at least one property to preview');
                return;
            }

            // Encode property IDs for preview
            const ids = Array.from(selectedProperties).join(',');
            const previewUrl = `../client/swipe.html?preview=true&ids=${encodeURIComponent(ids)}`;
            window.open(previewUrl, '_blank');
        }

        // Property detail modal
        let currentModalPropertyId = null;
        let currentModalPhotos = [];
        let currentPhotoIndex = 0;

        async function openPropertyModal(id) {
            event.stopPropagation();
            const property = allProperties.find(p => p.id === id);
            if (!property) return;

            currentModalPropertyId = id;
            currentModalPhotos = property.photos && property.photos.length > 0
                ? property.photos
                : ['https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800'];
            currentPhotoIndex = 0;

            const price = property.price || `‚Ç¨${(property.cleanPrice || 0).toLocaleString()}`;
            const isSelected = selectedProperties.has(id);

            // Format price from source
            const priceHTML = property.price || (property.cleanPrice > 0 ? `‚Ç¨${property.cleanPrice.toLocaleString()}` : 'Price on request');

            // Parse features
            const features = property.features ? property.features.split(/[,;]/).map(f => f.trim()).filter(f => f) : [];

            // Load complex info from Supabase
            let complexInfo = null;
            if (property.object && SupabaseClient && SupabaseClient.client) {
                try {
                    const { data, error } = await SupabaseClient.client
                        .from('complex_info')
                        .select('*')
                        .eq('object_code', property.object)
                        .single();
                    
                    if (!error && data) {
                        complexInfo = data;
                        console.log('‚úÖ Loaded complex info:', complexInfo);
                    }
                } catch (e) {
                    console.log('No complex info found for', property.object);
                }
            }

            // Build gallery HTML
            const showNav = currentModalPhotos.length > 1;
            const thumbsHtml = currentModalPhotos.length > 1
                ? `<div class="property-detail__thumbs">
                    ${currentModalPhotos.map((photo, idx) => `
                        <img src="${photo}" class="property-detail__thumb ${idx === 0 ? 'active' : ''}"
                             onclick="changeModalPhoto(${idx})"
                             onerror="this.style.display='none'">
                    `).join('')}
                   </div>`
                : '';

            const content = `
                <div class="property-detail__gallery">
                    <img src="${currentModalPhotos[0]}" class="property-detail__main-photo" id="modalMainPhoto"
                         onerror="this.src='https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800'">
                    ${showNav ? `
                        <button class="property-detail__photo-nav property-detail__photo-nav--prev" onclick="changeModalPhoto('prev')">&#10094;</button>
                        <button class="property-detail__photo-nav property-detail__photo-nav--next" onclick="changeModalPhoto('next')">&#10095;</button>
                        <div class="property-detail__photo-counter" id="photoCounter">1 / ${currentModalPhotos.length}</div>
                    ` : ''}
                    ${thumbsHtml}
                </div>

                <div class="property-detail__header">
                    <div class="property-detail__price">${priceHTML}</div>
                    ${property.apartmentNo ? `<div class="property-detail__unit">Unit #${property.apartmentNo}</div>` : ''}
                </div>

                <div class="property-detail__title">${property.id || 'Untitled'}</div>
                ${property.title ? `<div class="property-detail__location" style="font-size: 0.875rem; color: var(--gray-600); margin-top: 8px; margin-bottom: 8px;">${property.title}</div>` : ''}
                <div class="property-detail__location">üìç ${property.location || 'Unknown'} ${property.type ? `‚Ä¢ ${property.type}` : ''}</div>
                
                ${(() => {
                    if (complexInfo) {
                        // Show developer/complex information
                        return `
                        <div style="margin-top: 16px; padding: 16px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 12px; color: white;">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 8px;">üèóÔ∏è –ó–∞—Å—Ç—Ä–æ–π—â–∏–∫</div>
                            <div style="font-weight: 700; font-size: 1.125rem; margin-bottom: 4px;">${complexInfo.developer_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                            ${complexInfo.complex_name ? `<div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 8px;">–ö–æ–º–ø–ª–µ–∫—Å: ${complexInfo.complex_name}</div>` : ''}
                            <a href="tel:${complexInfo.phone}" class="btn" style="margin-top: 12px; background: white; color: #6366f1; text-decoration: none; display: inline-block; padding: 10px 20px; border-radius: 8px; font-weight: 600;">
                                üìû ${complexInfo.phone}
                            </a>
                            ${complexInfo.email ? `
                                <div style="margin-top: 8px; font-size: 0.875rem;">
                                    üìß <a href="mailto:${complexInfo.email}" style="color: white; text-decoration: underline;">${complexInfo.email}</a>
                                </div>
                            ` : ''}
                            ${complexInfo.website ? `
                                <div style="margin-top: 8px; font-size: 0.875rem;">
                                    üåê <a href="${complexInfo.website}" target="_blank" style="color: white; text-decoration: underline;">–í–µ–±-—Å–∞–π—Ç</a>
                                </div>
                            ` : ''}
                        </div>
                        `;
                    } else {
                        // Show default broker information
                        const brokerPhone = localStorage.getItem('broker_phone') || '+357 99 123456';
                        const brokerName = localStorage.getItem('broker_name') || 'Broker';
                        
                        return `
                        <div style="margin-top: 16px;">
                            <a href="tel:${brokerPhone}" class="btn btn-primary" style="text-decoration: none; display: inline-block; padding: 12px 24px;">
                                üìû Contact Broker: ${brokerPhone}
                            </a>
                        </div>
                        `;
                    }
                })()}
                
                ${property.deliveryInfo && property.deliveryInfo.status !== 'unknown' ? `
                <div style="margin-top: 12px; padding: 8px 12px; background: ${property.deliveryInfo.status === 'delivered' ? 'var(--success)' : 'var(--primary)'}20; border-radius: 8px; display: inline-block;">
                    <span style="font-size: 0.875rem; color: ${property.deliveryInfo.status === 'delivered' ? 'var(--success)' : 'var(--primary)'}; font-weight: 500;">
                        ${property.deliveryInfo.status === 'delivered' ? '‚úì ' : 'üìÖ '}${property.deliveryInfo.text}
                    </span>
                </div>
                ` : ''}

                <div class="property-detail__grid">
                    <div class="property-detail__stat">
                        <div class="property-detail__stat-value">${property.bedrooms || 0}</div>
                        <div class="property-detail__stat-label">Bedrooms</div>
                    </div>
                    <div class="property-detail__stat">
                        <div class="property-detail__stat-value">${property.area || 0}</div>
                        <div class="property-detail__stat-label">Total m¬≤</div>
                    </div>
                    <div class="property-detail__stat">
                        <div class="property-detail__stat-value">${property.insideArea || '-'}</div>
                        <div class="property-detail__stat-label">Inside m¬≤</div>
                    </div>
                </div>

                ${property.coveredVeranda || property.uncoveredVeranda ? `
                <div class="property-detail__section">
                    <div class="property-detail__section-title">Areas</div>
                    <div class="property-detail__features">
                        ${property.coveredVeranda ? `<span class="property-detail__feature">Covered Veranda: ${property.coveredVeranda} m¬≤</span>` : ''}
                        ${property.uncoveredVeranda ? `<span class="property-detail__feature">Uncovered Veranda: ${property.uncoveredVeranda} m¬≤</span>` : ''}
                        ${property.basement ? `<span class="property-detail__feature">Basement: ${property.basement} m¬≤</span>` : ''}
                    </div>
                </div>
                ` : ''}

                ${features.length > 0 ? `
                <div class="property-detail__section">
                    <div class="property-detail__section-title">Features</div>
                    <div class="property-detail__features">
                        ${features.map(f => `<span class="property-detail__feature">${f}</span>`).join('')}
                    </div>
                </div>
                ` : ''}

                ${property.additionalInfo ? `
                <div class="property-detail__section">
                    <div class="property-detail__section-title">Additional Info</div>
                    <p style="color: var(--gray-600); font-size: 0.875rem;">${property.additionalInfo}</p>
                </div>
                ` : ''}

                ${property.latitude && property.longitude && !isNaN(property.latitude) && !isNaN(property.longitude) ? `
                <div class="property-detail__section property-detail__map-section">
                    <div class="property-detail__section-title">üìç Location</div>
                    <div id="propertyDetailMap" class="property-detail__map"></div>
                </div>
                ` : ''}

            `;

            document.getElementById('propertyModalContent').innerHTML = content;
            document.getElementById('propertyModalSelect').textContent = isSelected ? 'Remove from Selection' : 'Select Property';
            document.getElementById('propertyModal').classList.add('modal-overlay--open');

            // Initialize map if coordinates available
            if (property.latitude && property.longitude && !isNaN(property.latitude) && !isNaN(property.longitude)) {
                initPropertyMap(property.latitude, property.longitude, property.title || property.id, property.location);
            }
        }

        // Initialize map in property modal
        function initPropertyMap(lat, lng, title, location) {
            setTimeout(() => {
                try {
                    const mapElement = document.getElementById('propertyDetailMap');
                    if (!mapElement || !window.L) return;

                    // Remove existing map if any
                    mapElement.innerHTML = '';

                    // Create map
                    const map = L.map('propertyDetailMap').setView([lat, lng], 15);

                    // Add tiles
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(map);

                    // Add marker
                    const marker = L.marker([lat, lng]).addTo(map);
                    marker.bindPopup(`
                        <div style="text-align: center;">
                            <strong style="font-size: 13px;">${title}</strong><br>
                            <span style="color: #666; font-size: 11px;">${location || 'Cyprus'}</span>
                        </div>
                    `).openPopup();

                    // Fix map display issues
                    setTimeout(() => map.invalidateSize(), 100);

                } catch (error) {
                    console.error('Map initialization error:', error);
                }
            }, 200);
        }

        function closePropertyModal() {
            document.getElementById('propertyModal').classList.remove('modal-overlay--open');
            currentModalPropertyId = null;
        }

        function changeModalPhoto(action) {
            if (typeof action === 'number') {
                currentPhotoIndex = action;
            } else if (action === 'prev') {
                currentPhotoIndex = (currentPhotoIndex - 1 + currentModalPhotos.length) % currentModalPhotos.length;
            } else if (action === 'next') {
                currentPhotoIndex = (currentPhotoIndex + 1) % currentModalPhotos.length;
            }

            // Update main photo
            const mainPhoto = document.getElementById('modalMainPhoto');
            if (mainPhoto) {
                mainPhoto.src = currentModalPhotos[currentPhotoIndex];
            }

            // Update counter
            const counter = document.getElementById('photoCounter');
            if (counter) {
                counter.textContent = `${currentPhotoIndex + 1} / ${currentModalPhotos.length}`;
            }

            // Update thumbnails
            document.querySelectorAll('.property-detail__thumb').forEach((thumb, idx) => {
                thumb.classList.toggle('active', idx === currentPhotoIndex);
            });
        }

        function selectFromModal() {
            if (currentModalPropertyId) {
                toggleProperty(currentModalPropertyId);
                const isSelected = selectedProperties.has(currentModalPropertyId);
                document.getElementById('propertyModalSelect').textContent = isSelected ? 'Remove from Selection' : 'Select Property';
            }
        }

        // Filter event listeners - with debounce for text inputs
        let filterDebounce;
        function onFilterChange() {
            clearTimeout(filterDebounce);
            filterDebounce = setTimeout(() => {
                updateActiveFiltersCount();
                renderProperties();
            }, 150);
        }

        // Text inputs with debounce
        document.getElementById('searchInput').addEventListener('input', onFilterChange);
        document.getElementById('priceMin').addEventListener('input', onFilterChange);
        document.getElementById('priceMax').addEventListener('input', onFilterChange);
        document.getElementById('areaMin').addEventListener('input', onFilterChange);
        document.getElementById('areaMax').addEventListener('input', onFilterChange);
        document.getElementById('priceSqmMin').addEventListener('input', onFilterChange);
        document.getElementById('priceSqmMax').addEventListener('input', onFilterChange);

        // Checkbox filters
        document.getElementById('hasVeranda').addEventListener('change', () => { updateActiveFiltersCount(); renderProperties(); });
        document.getElementById('hasBasement').addEventListener('change', () => { updateActiveFiltersCount(); renderProperties(); });
        document.getElementById('hasPool').addEventListener('change', () => { updateActiveFiltersCount(); renderProperties(); });
        document.getElementById('hasParking').addEventListener('change', () => { updateActiveFiltersCount(); renderProperties(); });
        document.getElementById('hasSeaView').addEventListener('change', () => { updateActiveFiltersCount(); renderProperties(); });

        // Delivery date filter
        document.getElementById('deliveryFilter').addEventListener('change', () => { updateActiveFiltersCount(); renderProperties(); });

        // Initialize bedroom chips
        initBedroomChips();

        // Modal close handlers
        document.getElementById('linkModal').addEventListener('click', (e) => {
            if (e.target.id === 'linkModal') closeLinkModal();
        });
        document.getElementById('propertyModal').addEventListener('click', (e) => {
            if (e.target.id === 'propertyModal') closePropertyModal();
        });
        document.getElementById('clientModal').addEventListener('click', (e) => {
            if (e.target.id === 'clientModal') closeClientModal();
        });
        document.getElementById('brokerSettingsModal').addEventListener('click', (e) => {
            if (e.target.id === 'brokerSettingsModal') closeBrokerSettingsModal();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeClientModal();
                closePropertyModal();
                closeLinkModal();
                closeBrokerSettingsModal();
            }
        });

        // Preview selection from link modal (uses the link, not selected properties)
        function previewSelectionFromLink() {
            const link = document.getElementById('selectionLink').value;
            if (link) {
                window.open(link, '_blank');
            }
        }

        // Store last created selection for PDF export
        let lastCreatedSelection = null;

        // Export selection to PDF
        function exportSelectionPDF(lang) {
            if (!lastCreatedSelection) {
                alert('No selection data available');
                return;
            }

            PDFExport.generateSelectionPDF({
                selectionName: lastCreatedSelection.name,
                clientName: lastCreatedSelection.clientName,
                brokerName: 'Cyprus Real Estate',
                properties: lastCreatedSelection.properties,
                lang: lang
            });
        }

        // Mobile menu toggle
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const btn = document.getElementById('menuBtn');

            sidebar.classList.toggle('sidebar--open');
            overlay.classList.toggle('active');
            btn.classList.toggle('active');
        }

        // Initialize on load
        init();
    </script>
    
    <!-- Range Slider JavaScript -->
    <script>
        // Range Slider Functionality
        class RangeSlider {
            constructor(sliderId, minInputId, maxInputId, displayId) {
                this.slider = document.getElementById(sliderId);
                if (!this.slider) return;

                this.minInput = document.getElementById(minInputId);
                this.maxInput = document.getElementById(maxInputId);
                this.display = document.getElementById(displayId);
                this.track = this.slider.querySelector('.range-slider__track');
                this.thumbs = Array.from(this.slider.querySelectorAll('.range-slider__thumb'));
                
                this.min = parseInt(this.slider.dataset.min) || 0;
                this.max = parseInt(this.slider.dataset.max) || 100;
                this.currentMin = this.min;
                this.currentMax = this.max;
                
                this.init();
            }

            init() {
                // Sync inputs with slider
                this.minInput.addEventListener('input', () => this.updateFromInput());
                this.maxInput.addEventListener('input', () => this.updateFromInput());
                
                // Initialize slider drag
                this.thumbs.forEach((thumb, index) => {
                    thumb.addEventListener('mousedown', (e) => this.startDrag(e, index));
                    thumb.addEventListener('touchstart', (e) => this.startDrag(e, index));
                });

                // Initialize position
                this.updateFromInput();
            }

            startDrag(e, thumbIndex) {
                e.preventDefault();
                const thumb = this.thumbs[thumbIndex];
                thumb.classList.add('active');

                const onMove = (e) => this.onDrag(e, thumbIndex);
                const onEnd = () => {
                    thumb.classList.remove('active');
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onEnd);
                    document.removeEventListener('touchmove', onMove);
                    document.removeEventListener('touchend', onEnd);
                    renderProperties(); // Apply filter on drag end
                };

                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchmove', onMove);
                document.addEventListener('touchend', onEnd);
            }

            onDrag(e, thumbIndex) {
                const rect = this.slider.getBoundingClientRect();
                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                const percentage = Math.max(0, Math.min(100, ((clientX - rect.left) / rect.width) * 100));
                const value = this.min + (percentage / 100) * (this.max - this.min);

                if (thumbIndex === 0) {
                    // Min thumb
                    this.currentMin = Math.min(value, this.currentMax);
                    this.minInput.value = Math.round(this.currentMin);
                } else {
                    // Max thumb
                    this.currentMax = Math.max(value, this.currentMin);
                    this.maxInput.value = Math.round(this.currentMax);
                }

                this.updateVisuals();
            }

            updateFromInput() {
                const minVal = parseFloat(this.minInput.value) || this.min;
                const maxVal = parseFloat(this.maxInput.value) || this.max;

                this.currentMin = Math.max(this.min, Math.min(minVal, this.max));
                this.currentMax = Math.max(this.min, Math.min(maxVal, this.max));

                // Ensure min <= max
                if (this.currentMin > this.currentMax) {
                    const temp = this.currentMin;
                    this.currentMin = this.currentMax;
                    this.currentMax = temp;
                    this.minInput.value = Math.round(this.currentMin);
                    this.maxInput.value = Math.round(this.currentMax);
                }

                this.updateVisuals();
            }

            updateVisuals() {
                const minPercent = ((this.currentMin - this.min) / (this.max - this.min)) * 100;
                const maxPercent = ((this.currentMax - this.min) / (this.max - this.min)) * 100;

                this.track.style.left = minPercent + '%';
                this.track.style.right = (100 - maxPercent) + '%';

                this.thumbs[0].style.left = minPercent + '%';
                this.thumbs[1].style.left = maxPercent + '%';

                // Update display
                if (this.display) {
                    const formatNumber = (num) => new Intl.NumberFormat('en-US').format(Math.round(num));
                    this.display.textContent = `${formatNumber(this.currentMin)} - ${formatNumber(this.currentMax)}`;
                }
            }

            formatNumber(num) {
                return new Intl.NumberFormat('en-US').format(Math.round(num));
            }
        }

        // Initialize sliders after DOM is ready
        window.addEventListener('DOMContentLoaded', () => {
            // Wait a bit for other scripts to load
            setTimeout(() => {
                new RangeSlider('priceSlider', 'priceMin', 'priceMax', 'priceRangeDisplay');
                new RangeSlider('areaSlider', 'areaMin', 'areaMax', 'areaRangeDisplay');
                new RangeSlider('priceSqmSlider', 'priceSqmMin', 'priceSqmMax', 'priceSqmRangeDisplay');
            }, 100);
        });
    </script>
    
    <!-- Leaflet JS for Maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
</body>
</html>
