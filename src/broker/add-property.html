<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</title>
    <link rel="stylesheet" href="../assets/css/common.css">
    <link rel="stylesheet" href="../assets/css/broker.css">
    <style>
        .add-property-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .form-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .form-section h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .photo-upload {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-upload:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .photo-upload input {
            display: none;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .photo-preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .photo-preview-item .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .photo-preview-item .remove-photo:hover {
            background: rgba(255, 0, 0, 1);
            transform: scale(1.1);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .required::after {
            content: " *";
            color: red;
        }

        .map-container {
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 15px;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .info-text {
            font-size: 0.85rem;
            color: #777;
            margin-top: 5px;
        }
        
        .btn-geolocation:hover:not(:disabled) {
            background: #4f46e5 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
            transition: all 0.2s ease;
        }
        
        .btn-geolocation:active {
            transform: translateY(0);
        }
        
        .btn-geolocation:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .success-message,
        .error-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="add-property-container">
        <h1>üìù –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</h1>

        <div id="messageContainer"></div>

        <form id="propertyForm">
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="form-section">
                <h2>üè¢ –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="projectTitle" class="required">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
                        <input type="text" id="projectTitle" name="projectTitle" required 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ARARAT Grand Residences">
                    </div>

                    <div class="form-group">
                        <label for="apartmentNo" class="required">–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã</label>
                        <input type="text" id="apartmentNo" name="apartmentNo" required 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 601">
                    </div>

                    <div class="form-group">
                        <label for="apartmentType" class="required">–¢–∏–ø –∫–≤–∞—Ä—Ç–∏—Ä—ã</label>
                        <select id="apartmentType" name="apartmentType" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                            <option value="–°—Ç—É–¥–∏—è">–°—Ç—É–¥–∏—è</option>
                            <option value="1-—Å–ø–∞–ª—å–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞">1-—Å–ø–∞–ª—å–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞</option>
                            <option value="2-—Å–ø–∞–ª—å–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞">2-—Å–ø–∞–ª—å–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞</option>
                            <option value="3-—Å–ø–∞–ª—å–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞">3-—Å–ø–∞–ª—å–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞</option>
                            <option value="4-—Å–ø–∞–ª—å–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞">4-—Å–ø–∞–ª—å–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞</option>
                            <option value="5-—Å–ø–∞–ª—å–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞">5-—Å–ø–∞–ª—å–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞</option>
                            <option value="–ü–µ–Ω—Ç—Ö–∞—É—Å">–ü–µ–Ω—Ç—Ö–∞—É—Å</option>
                            <option value="–î—É–ø–ª–µ–∫—Å">–î—É–ø–ª–µ–∫—Å</option>
                            <option value="–í–∏–ª–ª–∞">–í–∏–ª–ª–∞</option>
                            <option value="–¢–∞—É–Ω—Ö–∞—É—Å">–¢–∞—É–Ω—Ö–∞—É—Å</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="bedrooms" class="required">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∞–ª–µ–Ω</label>
                        <input type="number" id="bedrooms" name="bedrooms" min="0" max="20" required>
                    </div>

                    <div class="form-group">
                        <label for="url">URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–±—ä–µ–∫—Ç–∞</label>
                        <input type="url" id="url" name="url" 
                               placeholder="https://example.com/property/123">
                    </div>

                    <div class="form-group">
                        <label for="propertyStatus" class="required">–°—Ç–∞—Ç—É—Å –æ–±—ä–µ–∫—Ç–∞</label>
                        <select id="propertyStatus" name="propertyStatus" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                            <option value="Available">–î–æ—Å—Ç—É–ø–µ–Ω</option>
                            <option value="Reserved">–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω</option>
                            <option value="Sold">–ü—Ä–æ–¥–∞–Ω</option>
                            <option value="Project delivered">–ü—Ä–æ–µ–∫—Ç —Å–¥–∞–Ω</option>
                            <option value="Under construction">–°—Ç—Ä–æ–∏—Ç—Å—è</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="mainType" class="required">–û—Å–Ω–æ–≤–Ω–æ–π —Ç–∏–ø</label>
                        <select id="mainType" name="mainType" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                            <option value="Apartment">–ö–≤–∞—Ä—Ç–∏—Ä–∞</option>
                            <option value="Penthouse">–ü–µ–Ω—Ç—Ö–∞—É—Å</option>
                            <option value="Villa">–í–∏–ª–ª–∞</option>
                            <option value="House">–î–æ–º</option>
                            <option value="Townhouse">–¢–∞—É–Ω—Ö–∞—É—Å</option>
                            <option value="Other">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- –õ–æ–∫–∞—Ü–∏—è -->
            <div class="form-section">
                <h2>üìç –õ–æ–∫–∞—Ü–∏—è</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="location" class="required">–ì–æ—Ä–æ–¥/–†–∞–π–æ–Ω</label>
                        <input type="text" id="location" name="location" required 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ–∏–º–∞—Å—Å–æ–ª">
                    </div>

                    <div class="form-group">
                        <label for="latitude">–®–∏—Ä–æ—Ç–∞</label>
                        <input type="number" id="latitude" name="latitude" step="0.000001" 
                               placeholder="34.71483">
                        <span class="info-text">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</span>
                    </div>

                    <div class="form-group">
                        <label for="longitude">–î–æ–ª–≥–æ—Ç–∞</label>
                        <input type="number" id="longitude" name="longitude" step="0.000001" 
                               placeholder="33.16071">
                    </div>

                    <div class="form-group full-width">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label style="font-weight: 600; color: #374151; margin: 0;">
                                üó∫Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ
                            </label>
                            <button type="button" class="btn-geolocation" onclick="getMyLocation()" style="padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; display: flex; align-items: center; gap: 6px;">
                                <span>üìç</span>
                                <span>–ú–æ—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è</span>
                            </button>
                        </div>
                        <div class="map-container" style="border: 2px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div id="map"></div>
                        </div>
                        <p style="font-size: 0.875rem; color: #64748b; margin-top: 8px; font-style: italic;">
                            üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                        </p>
                    </div>
                </div>
            </div>

            <!-- –ü–ª–æ—â–∞–¥–∏ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
            <div class="form-section">
                <h2>üìê –ü–ª–æ—â–∞–¥–∏ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="totalArea">–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å (–º¬≤)</label>
                        <input type="number" id="totalArea" name="totalArea" step="0.01" 
                               placeholder="131">
                    </div>

                    <div class="form-group">
                        <label for="insideArea">–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ø–ª–æ—â–∞–¥—å (–º¬≤)</label>
                        <input type="text" id="insideArea" name="insideArea" 
                               placeholder="95 m2">
                    </div>

                    <div class="form-group">
                        <label for="coveredVeranda">–ö—Ä—ã—Ç–∞—è –≤–µ—Ä–∞–Ω–¥–∞ (–º¬≤)</label>
                        <input type="text" id="coveredVeranda" name="coveredVeranda" 
                               placeholder="36 m2">
                    </div>

                    <div class="form-group">
                        <label for="uncoveredVeranda">–û—Ç–∫—Ä—ã—Ç–∞—è –≤–µ—Ä–∞–Ω–¥–∞ (–º¬≤)</label>
                        <input type="text" id="uncoveredVeranda" name="uncoveredVeranda">
                    </div>

                    <div class="form-group">
                        <label for="plot">–£—á–∞—Å—Ç–æ–∫ (–º¬≤)</label>
                        <input type="text" id="plot" name="plot">
                    </div>

                    <div class="form-group">
                        <label for="basement">–ü–æ–¥–≤–∞–ª (–º¬≤)</label>
                        <input type="text" id="basement" name="basement">
                    </div>
                </div>
            </div>

            <!-- –¶–µ–Ω–∞ -->
            <div class="form-section">
                <h2>üí∞ –¶–µ–Ω–∞</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="price" class="required">–¶–µ–Ω–∞ (—Ç–µ–∫—Å—Ç–æ–º)</label>
                        <input type="text" id="price" name="price" required 
                               placeholder="‚Ç¨ 450,000 + VAT –∏–ª–∏ Price upon request">
                    </div>

                    <div class="form-group">
                        <label for="cleanPrice">–¶–µ–Ω–∞ (—á–∏—Å–ª–æ)</label>
                        <input type="number" id="cleanPrice" name="cleanPrice" step="0.01" 
                               placeholder="450000">
                        <span class="info-text">–¢–æ–ª—å–∫–æ —á–∏—Å–ª–æ –±–µ–∑ –≤–∞–ª—é—Ç—ã –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</span>
                    </div>

                    <div class="form-group">
                        <label for="currencyType">–í–∞–ª—é—Ç–∞</label>
                        <select id="currencyType" name="currencyType">
                            <option value="">–ù–µ —É–∫–∞–∑–∞–Ω–∞</option>
                            <option value="EUR">EUR (‚Ç¨)</option>
                            <option value="USD">USD ($)</option>
                            <option value="GBP">GBP (¬£)</option>
                            <option value="RUB">RUB (‚ÇΩ)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="pricepersqm">–¶–µ–Ω–∞ –∑–∞ –º¬≤</label>
                        <input type="text" id="pricepersqm" name="pricepersqm" 
                               placeholder="‚Ç¨15,250">
                    </div>
                </div>
            </div>

            <!-- –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ -->
            <div class="form-section">
                <h2>‚ú® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ</h2>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="features">–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏</label>
                        <textarea id="features" name="features" 
                                  placeholder="Swimming Pool:communal, Parking:2 spaces, Sea View, etc."></textarea>
                        <span class="info-text">–†–∞–∑–¥–µ–ª—è–π—Ç–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞–ø—è—Ç—ã–º–∏</span>
                    </div>

                    <div class="form-group full-width">
                        <label for="additionalInformation">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</label>
                        <textarea id="additionalInformation" name="additionalInformation" 
                                  placeholder="Roof Terrace with swimming pool, etc."></textarea>
                    </div>
                </div>
            </div>

            <!-- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ -->
            <div class="form-section">
                <h2>üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h2>
                <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                    <input type="file" id="photoInput" multiple accept="image/*">
                    <p style="font-size: 3rem; margin: 0;">üì∑</p>
                    <p style="margin: 10px 0 5px 0; font-weight: 600;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</p>
                    <p style="margin: 0; color: #777; font-size: 0.9rem;">–ò–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</p>
                </div>
                <div id="photoPreview" class="photo-preview"></div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="window.location.href='properties.html'">
                    –û—Ç–º–µ–Ω–∏—Ç—å
                </button>
                <button type="submit" class="btn btn-primary">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—ä–µ–∫—Ç
                </button>
            </div>
        </form>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Supabase -->
    <script src="../assets/js/supabase-client.js"></script>
    
    <!-- Image Compression Library -->
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>

    <!-- Leaflet –¥–ª—è –∫–∞—Ä—Ç—ã -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        let map, marker;
        
        function initMap() {
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –ö–∏–ø—Ä–∞
            const defaultLat = 34.9175;
            const defaultLng = 33.6300;

            map = L.map('map').setView([defaultLat, defaultLng], 10);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ
            map.on('click', function(e) {
                if (marker) {
                    map.removeLayer(marker);
                }
                
                marker = L.marker(e.latlng).addTo(map);
                document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
                document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                marker.bindPopup(`
                    <div style="text-align: center;">
                        <strong>üìç –õ–æ–∫–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–∞</strong><br>
                        <small>${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}</small>
                    </div>
                `).openPopup();
            });

            // –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É–∂–µ –∑–∞–¥–∞–Ω—ã, –ø–æ–∫–∞–∑–∞—Ç—å –º–∞—Ä–∫–µ—Ä
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            
            if (lat && lng) {
                marker = L.marker([lat, lng]).addTo(map);
                map.setView([lat, lng], 14);
                marker.bindPopup('<strong>üìç –¢–µ–∫—É—â–∞—è –ª–æ–∫–∞—Ü–∏—è</strong>').openPopup();
            }
        }

        // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è - –Ω–∞–π—Ç–∏ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
        function getMyLocation() {
            if (!navigator.geolocation) {
                alert('‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                return;
            }

            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>üîÑ</span> <span>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...</span>';
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                    document.getElementById('latitude').value = lat.toFixed(6);
                    document.getElementById('longitude').value = lng.toFixed(6);

                    // –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç—É –∏ –¥–æ–±–∞–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä
                    if (marker) {
                        map.removeLayer(marker);
                    }
                    
                    marker = L.marker([lat, lng]).addTo(map);
                    map.setView([lat, lng], 15);
                    
                    marker.bindPopup(`
                        <div style="text-align: center;">
                            <strong>üìç –í–∞—à–∞ –ª–æ–∫–∞—Ü–∏—è</strong><br>
                            <small>${lat.toFixed(5)}, ${lng.toFixed(5)}</small><br>
                            <small style="color: #10b981;">–¢–æ—á–Ω–æ—Å—Ç—å: ¬±${position.coords.accuracy.toFixed(0)}–º</small>
                        </div>
                    `).openPopup();

                    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
                    btn.innerHTML = originalText;
                    btn.disabled = false;

                    // –£—Å–ø–µ—à–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 10000; animation: slideIn 0.3s ease;';
                    notification.innerHTML = '‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞!';
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    let errorMsg = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â—ë–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ.';
                            break;
                    }
                    
                    alert('‚ùå ' + errorMsg);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photoPreview');
        let selectedPhotos = [];

        photoInput.addEventListener('change', function(e) {
            handleFiles(e.target.files);
        });

        // Drag & Drop –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
        const photoUpload = document.querySelector('.photo-upload');
        
        photoUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            photoUpload.style.borderColor = '#667eea';
            photoUpload.style.background = 'rgba(102, 126, 234, 0.1)';
        });

        photoUpload.addEventListener('dragleave', () => {
            photoUpload.style.borderColor = '#ccc';
            photoUpload.style.background = '';
        });

        photoUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            photoUpload.style.borderColor = '#ccc';
            photoUpload.style.background = '';
            handleFiles(e.dataTransfer.files);
        });

        async function handleFiles(files) {
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    // Show compression progress
                    const progressDiv = document.createElement('div');
                    progressDiv.innerHTML = `<p style="color: #6366f1; margin: 10px 0;">üîÑ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è ${file.name}...</p>`;
                    photoPreview.appendChild(progressDiv);
                    
                    try {
                        // Compression options
                        const options = {
                            maxSizeMB: 0.4,              // Max 400 KB
                            maxWidthOrHeight: 1200,      // Max 1200px
                            useWebWorker: true,
                            fileType: 'image/jpeg',      // Convert to JPEG
                            initialQuality: 0.85         // 85% quality
                        };
                        
                        const originalSize = (file.size / 1024 / 1024).toFixed(2); // MB
                        
                        // Compress image
                        const compressedFile = await imageCompression(file, options);
                        const compressedSize = (compressedFile.size / 1024).toFixed(0); // KB
                        
                        // Remove progress message
                        progressDiv.remove();
                        
                        // Show compression result
                        const resultDiv = document.createElement('div');
                        resultDiv.style.cssText = 'color: #10b981; font-size: 0.875rem; margin: 5px 0;';
                        resultDiv.innerHTML = `‚úÖ ${file.name}: ${originalSize} MB ‚Üí ${compressedSize} KB`;
                        photoPreview.appendChild(resultDiv);
                        setTimeout(() => resultDiv.remove(), 3000);
                        
                        // Check if still too large
                        if (compressedFile.size > 500 * 1024) { // 500 KB
                            const warningDiv = document.createElement('div');
                            warningDiv.style.cssText = 'color: #f59e0b; font-size: 0.875rem; margin: 5px 0;';
                            warningDiv.innerHTML = `‚ö†Ô∏è ${file.name} –≤—Å—ë –µ—â—ë –±–æ–ª—å—à–æ–µ (${compressedSize} KB). –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è < 400 KB`;
                            photoPreview.appendChild(warningDiv);
                            setTimeout(() => warningDiv.remove(), 5000);
                        }
                        
                        // Add compressed file
                        selectedPhotos.push(compressedFile);
                        
                        // Show preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const div = document.createElement('div');
                            div.className = 'photo-preview-item';
                            div.innerHTML = `
                                <img src="${e.target.result}" alt="Preview">
                                <button type="button" class="remove-photo" onclick="removePhoto(${selectedPhotos.length - 1})">
                                    √ó
                                </button>
                                <div style="position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; font-size: 0.75rem; border-radius: 4px;">
                                    ${compressedSize} KB
                                </div>
                            `;
                            photoPreview.appendChild(div);
                        };
                        reader.readAsDataURL(compressedFile);
                        
                    } catch (error) {
                        console.error('Error compressing image:', error);
                        progressDiv.remove();
                        
                        // Fallback: add original if compression fails
                        alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∂–∞—Ç—å ${file.name}. –î–æ–±–∞–≤–ª–µ–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª.`);
                        selectedPhotos.push(file);
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const div = document.createElement('div');
                            div.className = 'photo-preview-item';
                            div.innerHTML = `
                                <img src="${e.target.result}" alt="Preview">
                                <button type="button" class="remove-photo" onclick="removePhoto(${selectedPhotos.length - 1})">
                                    √ó
                                </button>
                            `;
                            photoPreview.appendChild(div);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }
        }

        function removePhoto(index) {
            selectedPhotos.splice(index, 1);
            updatePhotoPreview();
        }

        function updatePhotoPreview() {
            photoPreview.innerHTML = '';
            selectedPhotos.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'photo-preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="remove-photo" onclick="removePhoto(${index})">
                            √ó
                        </button>
                    `;
                    photoPreview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        const propertyForm = document.getElementById('propertyForm');
        const messageContainer = document.getElementById('messageContainer');

        propertyForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            showMessage('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞...', 'info');
            
            try {
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ Supabase Storage
                const photoURLs = await uploadPhotos();
                
                // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                const formData = new FormData(propertyForm);
                const propertyData = {
                    project_title: formData.get('projectTitle'),
                    apartment_no: formData.get('apartmentNo'),
                    apartment_type: formData.get('apartmentType'),
                    url: formData.get('url'),
                    property_status: formData.get('propertyStatus'),
                    location: formData.get('location'),
                    bedrooms: parseInt(formData.get('bedrooms')),
                    plot: formData.get('plot'),
                    total_area: parseFloat(formData.get('totalArea')) || null,
                    price: formData.get('price'),
                    latitude: parseFloat(formData.get('latitude')) || null,
                    longitude: parseFloat(formData.get('longitude')) || null,
                    photo_urls: photoURLs,
                    inside_area: formData.get('insideArea'),
                    covered_veranda: formData.get('coveredVeranda'),
                    price_per_sqm: formData.get('pricepersqm'),
                    features: formData.get('features'),
                    uncovered_veranda: formData.get('uncoveredVeranda'),
                    additional_information: formData.get('additionalInformation'),
                    basement: formData.get('basement'),
                    currency_type: formData.get('currencyType'),
                    clean_price: parseFloat(formData.get('cleanPrice')) || null,
                    main_type: formData.get('mainType'),
                    object_id: generateObjectId(),
                    created_at: new Date().toISOString(),
                    broker_id: (await window.supabaseClient.auth.getUser()).data.user?.id || null
                };

                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Supabase
                const { data, error } = await window.supabaseClient
                    .from('properties')
                    .insert([propertyData])
                    .select();

                if (error) throw error;

                showMessage('‚úÖ –û–±—ä–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                
                // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                setTimeout(() => {
                    window.location.href = 'properties.html';
                }, 2000);

            } catch (error) {
                console.error('Error saving property:', error);
                showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message, 'error');
            }
        });

        async function uploadPhotos() {
            if (selectedPhotos.length === 0) return [];

            const photoURLs = [];
            const bucket = 'property-photos';

            for (let i = 0; i < selectedPhotos.length; i++) {
                const file = selectedPhotos[i];
                const fileName = `${Date.now()}_${i}_${file.name}`;
                const filePath = `properties/${fileName}`;

                try {
                    const { data, error } = await window.supabaseClient.storage
                        .from(bucket)
                        .upload(filePath, file);

                    if (error) throw error;

                    // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ URL
                    const { data: urlData } = window.supabaseClient.storage
                        .from(bucket)
                        .getPublicUrl(filePath);

                    photoURLs.push(urlData.publicUrl);
                } catch (error) {
                    console.error('Error uploading photo:', error);
                }
            }

            return photoURLs;
        }

        function generateObjectId() {
            const prefix = 'KZ-';
            const random = Math.floor(Math.random() * 10000);
            return prefix + random.toString().padStart(4, '0');
        }

        function showMessage(message, type) {
            const className = type === 'success' ? 'success-message' : 
                            type === 'error' ? 'error-message' : 'info-message';
            
            messageContainer.innerHTML = `
                <div class="${className}">
                    ${message}
                </div>
            `;

            if (type !== 'info') {
                setTimeout(() => {
                    messageContainer.innerHTML = '';
                }, 5000);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', async function() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const { data: { user } } = await window.supabaseClient.auth.getUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            initMap();
        });

        // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –∑–∞ –º¬≤
        document.getElementById('totalArea').addEventListener('input', calculatePricePerSqm);
        document.getElementById('cleanPrice').addEventListener('input', calculatePricePerSqm);

        function calculatePricePerSqm() {
            const area = parseFloat(document.getElementById('totalArea').value);
            const price = parseFloat(document.getElementById('cleanPrice').value);
            
            if (area && price) {
                const pricePerSqm = (price / area).toFixed(0);
                const currency = document.getElementById('currencyType').value || 'EUR';
                const symbol = currency === 'EUR' ? '‚Ç¨' : currency === 'USD' ? '$' : 
                              currency === 'GBP' ? '¬£' : '‚ÇΩ';
                
                document.getElementById('pricepersqm').value = 
                    `${symbol}${Number(pricePerSqm).toLocaleString()}`;
            }
        }
    </script>
</body>
</html>
