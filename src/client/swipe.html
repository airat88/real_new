<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Selection | Cyprus Real Estate</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../assets/css/common.css">

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-md);
            overflow-x: hidden;
        }

        .swipe-container {
            width: 100%;
            max-width: 450px;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: var(--space-xl);
            color: var(--white);
        }

        .header__logo {
            font-size: 3rem;
            margin-bottom: var(--space-sm);
        }

        .header__title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: var(--space-xs);
        }

        .header__subtitle {
            opacity: 0.9;
        }

        .cards-stack {
            position: relative;
            width: 100%;
            height: 600px;
            margin-bottom: var(--space-xl);
        }

        .property-card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: var(--white);
            border-radius: var(--radius-xxl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            cursor: grab;
            transition: transform 0.3s ease;
        }

        .property-card:active {
            cursor: grabbing;
        }

        .property-card__image {
            width: 100%;
            height: 60%;
            object-fit: cover;
            background: var(--gray-200);
        }

        .property-card__content {
            padding: var(--space-lg);
            height: 40%;
            overflow-y: auto;
        }

        .property-card__price {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: var(--space-sm);
        }

        .property-card__title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }

        .property-card__location {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            color: var(--gray-600);
            margin-bottom: var(--space-md);
        }

        .property-card__tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
            margin-bottom: var(--space-md);
        }

        .property-card__tag {
            padding: 4px 12px;
            background: var(--gray-100);
            border-radius: var(--radius-full);
            font-size: 0.875rem;
        }

        .property-card__features {
            font-size: 0.875rem;
            color: var(--gray-600);
            line-height: 1.6;
        }

        .swipe-indicator {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 6rem;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 10;
        }

        .swipe-indicator--like {
            left: 20px;
        }

        .swipe-indicator--dislike {
            right: 20px;
        }

        .actions {
            display: flex;
            justify-content: center;
            gap: var(--space-xl);
        }

        .action-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            transition: all var(--transition);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn--dislike {
            background: var(--white);
            color: var(--danger);
        }

        .action-btn--like {
            background: var(--success);
            color: var(--white);
        }

        .progress {
            text-align: center;
            color: var(--white);
            margin-top: var(--space-lg);
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .loading-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--white);
            z-index: 1000;
        }

        .loading-screen__spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: var(--white);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-screen__text {
            margin-top: var(--space-lg);
            font-size: 1.125rem;
        }

        .completion-screen {
            text-align: center;
            color: var(--white);
        }

        .completion-screen__icon {
            font-size: 5rem;
            margin-bottom: var(--space-lg);
        }

        .completion-screen__title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--space-md);
        }

        .completion-screen__message {
            font-size: 1.125rem;
            opacity: 0.9;
            margin-bottom: var(--space-xl);
        }

        .completion-screen__stats {
            display: flex;
            justify-content: center;
            gap: var(--space-xl);
            margin-bottom: var(--space-xl);
        }

        .completion-screen__stat {
            text-align: center;
        }

        .completion-screen__stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--space-xs);
        }

        .completion-screen__stat-label {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .error-screen {
            text-align: center;
            color: var(--white);
        }

        .error-screen__icon {
            font-size: 5rem;
            margin-bottom: var(--space-lg);
        }

        .error-screen__title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--space-md);
        }

        .error-screen__message {
            font-size: 1.125rem;
            opacity: 0.9;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-screen__spinner"></div>
        <div class="loading-screen__text">Loading selection...</div>
    </div>

    <!-- Main Content -->
    <div class="swipe-container hidden" id="mainContent">
        <div class="header">
            <div class="header__logo">üè†</div>
            <div class="header__title" id="selectionName">Property Selection</div>
            <div class="header__subtitle" id="brokerInfo"></div>
        </div>

        <div class="cards-stack" id="cardsStack">
            <!-- Swipe indicators -->
            <div class="swipe-indicator swipe-indicator--like" id="likeIndicator">‚ù§Ô∏è</div>
            <div class="swipe-indicator swipe-indicator--dislike" id="dislikeIndicator">‚úñÔ∏è</div>
            
            <!-- Property cards will be inserted here -->
        </div>

        <div class="actions">
            <button class="action-btn action-btn--dislike" onclick="handleAction('dislike')">
                ‚úñÔ∏è
            </button>
            <button class="action-btn action-btn--like" onclick="handleAction('like')">
                ‚ù§Ô∏è
            </button>
        </div>

        <div class="progress" id="progressText">
            0 of 0
        </div>
    </div>

    <!-- Completion Screen -->
    <div class="swipe-container hidden" id="completionScreen">
        <div class="completion-screen">
            <div class="completion-screen__icon">üéâ</div>
            <div class="completion-screen__title">All Done!</div>
            <div class="completion-screen__message">
                Thank you for reviewing the properties.<br>
                Your broker will contact you soon!
            </div>
            <div class="completion-screen__stats">
                <div class="completion-screen__stat">
                    <div class="completion-screen__stat-value" style="color: #10b981;" id="likedCount">0</div>
                    <div class="completion-screen__stat-label">Liked</div>
                </div>
                <div class="completion-screen__stat">
                    <div class="completion-screen__stat-value" style="color: #ef4444;" id="dislikedCount">0</div>
                    <div class="completion-screen__stat-label">Passed</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Screen -->
    <div class="swipe-container hidden" id="errorScreen">
        <div class="error-screen">
            <div class="error-screen__icon">‚ö†Ô∏è</div>
            <div class="error-screen__title">Oops!</div>
            <div class="error-screen__message" id="errorMessage">
                Invalid or expired link.
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../assets/js/supabase-client.js"></script>
    <script src="../assets/js/data-sync.js"></script>
    <script>
        // State
        let selectionToken = null;
        let selectionData = null;
        let properties = [];
        let currentIndex = 0;
        let likedCount = 0;
        let dislikedCount = 0;

        // Swipe handling
        let startX = 0;
        let startY = 0;
        let currentCard = null;
        let isDragging = false;

        // Initialize
        async function init() {
            // Get token from URL
            const urlParams = new URLSearchParams(window.location.search);
            selectionToken = urlParams.get('t');

            if (!selectionToken) {
                showError('No selection token provided.');
                return;
            }

            try {
                // Load selection data
                selectionData = await SupabaseClient.getSelectionByToken(selectionToken);
                
                if (!selectionData) {
                    showError('Selection not found or has been deleted.');
                    return;
                }

                // Update header
                document.getElementById('selectionName').textContent = selectionData.name;
                document.getElementById('brokerInfo').textContent = `by ${selectionData.broker_name}`;

                // Load properties
                await DataSync.sync();
                const allProperties = DataSync.getProperties();
                
                // Get property IDs from selection
                const propertyIds = selectionData.property_ids || [];
                properties = allProperties.filter(p => propertyIds.includes(p.id));

                if (properties.length === 0) {
                    showError('This selection has no properties.');
                    return;
                }

                // Hide loading, show content
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');

                // Render cards
                renderCards();
                updateProgress();

            } catch (error) {
                console.error('Error loading selection:', error);
                showError('Failed to load selection. Please try again.');
            }
        }

        // Render property cards
        function renderCards() {
            const stack = document.getElementById('cardsStack');
            
            // Clear existing cards (except indicators)
            const cards = stack.querySelectorAll('.property-card');
            cards.forEach(card => card.remove());

            // Render cards in reverse order (bottom to top)
            for (let i = Math.min(currentIndex + 3, properties.length) - 1; i >= currentIndex; i--) {
                const property = properties[i];
                const card = createCard(property, i);
                stack.appendChild(card);
            }

            // Attach swipe events to top card
            const topCard = stack.querySelector('.property-card:last-child');
            if (topCard) {
                attachSwipeEvents(topCard);
                currentCard = topCard;
            }
        }

        // Create property card
        function createCard(property, index) {
            const card = document.createElement('div');
            card.className = 'property-card';
            card.dataset.index = index;

            const bedroomText = property.bedrooms === 0 ? 'Studio' : `${property.bedrooms} bed`;
            const photos = property.photos && property.photos.length > 0 
                ? property.photos 
                : ['https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800'];

            // Format price
            let priceHTML = property.price || `‚Ç¨${(property.cleanPrice || 0).toLocaleString()}`;

            card.innerHTML = `
                <img src="${photos[0]}" alt="${property.title}" class="property-card__image"
                     onerror="this.src='https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800'">
                <div class="property-card__content">
                    <div class="property-card__price">${priceHTML}</div>
                    <div class="property-card__title">${property.title || property.id || 'Untitled Property'}</div>
                    <div class="property-card__location">
                        <span>üìç</span>
                        <span>${property.location || 'Unknown location'}</span>
                    </div>
                    <div class="property-card__tags">
                        <span class="property-card__tag">üõèÔ∏è ${bedroomText}</span>
                        <span class="property-card__tag">üìê ${property.area || 0} m¬≤</span>
                        ${property.type ? `<span class="property-card__tag">${property.type}</span>` : ''}
                        ${property.status ? `<span class="property-card__tag">${property.status}</span>` : ''}
                    </div>
                    ${property.features ? `<div class="property-card__features">${property.features}</div>` : ''}
                </div>
            `;

            // Add depth effect
            const offset = index - currentIndex;
            if (offset > 0) {
                card.style.transform = `scale(${1 - offset * 0.05}) translateY(${offset * -10}px)`;
                card.style.opacity = 1 - offset * 0.2;
                card.style.zIndex = 100 - offset;
            }

            return card;
        }

        // Attach swipe events
        function attachSwipeEvents(card) {
            card.addEventListener('mousedown', handleStart);
            card.addEventListener('touchstart', handleStart);
        }

        function handleStart(e) {
            if (!currentCard) return;
            
            isDragging = true;
            const touch = e.type === 'touchstart' ? e.touches[0] : e;
            startX = touch.clientX;
            startY = touch.clientY;
            
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('touchmove', handleMove);
            document.addEventListener('mouseup', handleEnd);
            document.addEventListener('touchend', handleEnd);
        }

        function handleMove(e) {
            if (!isDragging || !currentCard) return;
            
            e.preventDefault();
            const touch = e.type === 'touchmove' ? e.touches[0] : e;
            const deltaX = touch.clientX - startX;
            const deltaY = touch.clientY - startY;
            
            // Move card
            currentCard.style.transform = `translate(${deltaX}px, ${deltaY}px) rotate(${deltaX * 0.1}deg)`;
            
            // Show indicators
            const likeIndicator = document.getElementById('likeIndicator');
            const dislikeIndicator = document.getElementById('dislikeIndicator');
            
            if (deltaX > 50) {
                likeIndicator.style.opacity = Math.min(deltaX / 100, 1);
                dislikeIndicator.style.opacity = 0;
            } else if (deltaX < -50) {
                dislikeIndicator.style.opacity = Math.min(Math.abs(deltaX) / 100, 1);
                likeIndicator.style.opacity = 0;
            } else {
                likeIndicator.style.opacity = 0;
                dislikeIndicator.style.opacity = 0;
            }
        }

        function handleEnd(e) {
            if (!isDragging || !currentCard) return;
            
            isDragging = false;
            const touch = e.type === 'touchend' ? e.changedTouches[0] : e;
            const deltaX = touch.clientX - startX;
            
            // Remove event listeners
            document.removeEventListener('mousemove', handleMove);
            document.removeEventListener('touchmove', handleMove);
            document.removeEventListener('mouseup', handleEnd);
            document.removeEventListener('touchend', handleEnd);
            
            // Reset indicators
            document.getElementById('likeIndicator').style.opacity = 0;
            document.getElementById('dislikeIndicator').style.opacity = 0;
            
            // Determine action
            if (deltaX > 100) {
                swipeCard('like');
            } else if (deltaX < -100) {
                swipeCard('dislike');
            } else {
                // Reset position
                currentCard.style.transform = '';
            }
        }

        // Handle button actions
        function handleAction(action) {
            swipeCard(action);
        }

        // Swipe card
        async function swipeCard(action) {
            if (!currentCard) return;
            
            const property = properties[currentIndex];
            
            // Animate card out
            const direction = action === 'like' ? 1 : -1;
            currentCard.style.transition = 'transform 0.3s ease';
            currentCard.style.transform = `translate(${direction * 1000}px, 0) rotate(${direction * 30}deg)`;
            
            // Update counts
            if (action === 'like') {
                likedCount++;
            } else {
                dislikedCount++;
            }
            
            // Save reaction
            try {
                await SupabaseClient.saveReaction(selectionData.id, property.id, action);
            } catch (error) {
                console.error('Failed to save reaction:', error);
            }
            
            // Move to next card
            currentIndex++;
            
            setTimeout(() => {
                if (currentIndex >= properties.length) {
                    showCompletion();
                } else {
                    renderCards();
                    updateProgress();
                }
            }, 300);
        }

        // Update progress
        function updateProgress() {
            document.getElementById('progressText').textContent = 
                `${currentIndex} of ${properties.length}`;
        }

        // Show completion screen
        function showCompletion() {
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('completionScreen').classList.remove('hidden');
            document.getElementById('likedCount').textContent = likedCount;
            document.getElementById('dislikedCount').textContent = dislikedCount;
        }

        // Show error screen
        function showError(message) {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('errorScreen').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        // Start on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
